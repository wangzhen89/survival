<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>第 17 章 使用 R 进行生存分析 | 医学研究中的生存数据建模</title>
<meta name="author" content="Wang Zhen">
<meta name="description" content="阅读提示 本章给出了许多代码块 (code chunk)，默认为全局打开。点击代码块的 “Hide” 可隐藏该代码块 ；若希望全局隐藏以方便阅读，需将页面划到最上方，右侧会显示一个额外的全局控制，将其设为 “Hide All Code” 即可（默认为 “Show All Code”）。 如无法显示/隐藏，可试着将全局控制的两个选项各点一次，原因不详。...">
<meta name="generator" content="bookdown 0.38 with bs4_book()">
<meta property="og:title" content="第 17 章 使用 R 进行生存分析 | 医学研究中的生存数据建模">
<meta property="og:type" content="book">
<meta property="og:description" content="阅读提示 本章给出了许多代码块 (code chunk)，默认为全局打开。点击代码块的 “Hide” 可隐藏该代码块 ；若希望全局隐藏以方便阅读，需将页面划到最上方，右侧会显示一个额外的全局控制，将其设为 “Hide All Code” 即可（默认为 “Show All Code”）。 如无法显示/隐藏，可试着将全局控制的两个选项各点一次，原因不详。...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第 17 章 使用 R 进行生存分析 | 医学研究中的生存数据建模">
<meta name="twitter:description" content="阅读提示 本章给出了许多代码块 (code chunk)，默认为全局打开。点击代码块的 “Hide” 可隐藏该代码块 ；若希望全局隐藏以方便阅读，需将页面划到最上方，右侧会显示一个额外的全局控制，将其设为 “Hide All Code” 即可（默认为 “Show All Code”）。 如无法显示/隐藏，可试着将全局控制的两个选项各点一次，原因不详。...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.7.0/transition.js"></script><script src="libs/bs3compat-0.7.0/tabs.js"></script><script src="libs/bs3compat-0.7.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script>
    /* ========================================================================
     * Bootstrap: transition.js v3.3.7
     * http://getbootstrap.com/javascript/#transitions
     * ========================================================================
     * Copyright 2011-2016 Twitter, Inc.
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
     * ======================================================================== */


    +function ($) {
      'use strict';

      // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
      // ============================================================

      function transitionEnd() {
        var el = document.createElement('bootstrap')

        var transEndEventNames = {
          WebkitTransition : 'webkitTransitionEnd',
          MozTransition    : 'transitionend',
          OTransition      : 'oTransitionEnd otransitionend',
          transition       : 'transitionend'
        }

        for (var name in transEndEventNames) {
          if (el.style[name] !== undefined) {
            return { end: transEndEventNames[name] }
          }
        }

        return false // explicit for ie8 (  ._.)
      }

      // http://blog.alexmaccaw.com/css-transitions
      $.fn.emulateTransitionEnd = function (duration) {
        var called = false
        var $el = this
        $(this).one('bsTransitionEnd', function () { called = true })
        var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
        setTimeout(callback, duration)
        return this
      }

      $(function () {
        $.support.transition = transitionEnd()

        if (!$.support.transition) return

        $.event.special.bsTransitionEnd = {
          bindType: $.support.transition.end,
          delegateType: $.support.transition.end,
          handle: function (e) {
            if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
          }
        }
      })

    }(jQuery);
    </script><script>
    /* ========================================================================
     * Bootstrap: collapse.js v3.3.7
     * http://getbootstrap.com/javascript/#collapse
     * ========================================================================
     * Copyright 2011-2016 Twitter, Inc.
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
     * ======================================================================== */

    /* jshint latedef: false */

    +function ($) {
      'use strict';

      // COLLAPSE PUBLIC CLASS DEFINITION
      // ================================

      var Collapse = function (element, options) {
        this.$element      = $(element)
        this.options       = $.extend({}, Collapse.DEFAULTS, options)
        this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                               '[data-toggle="collapse"][data-target="#' + element.id + '"]')
        this.transitioning = null

        if (this.options.parent) {
          this.$parent = this.getParent()
        } else {
          this.addAriaAndCollapsedClass(this.$element, this.$trigger)
        }

        if (this.options.toggle) this.toggle()
      }

      Collapse.VERSION  = '3.3.7'

      Collapse.TRANSITION_DURATION = 350

      Collapse.DEFAULTS = {
        toggle: true
      }

      Collapse.prototype.dimension = function () {
        var hasWidth = this.$element.hasClass('width')
        return hasWidth ? 'width' : 'height'
      }

      Collapse.prototype.show = function () {
        if (this.transitioning || this.$element.hasClass('in')) return

        var activesData
        var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

        if (actives && actives.length) {
          activesData = actives.data('bs.collapse')
          if (activesData && activesData.transitioning) return
        }

        var startEvent = $.Event('show.bs.collapse')
        this.$element.trigger(startEvent)
        if (startEvent.isDefaultPrevented()) return

        if (actives && actives.length) {
          Plugin.call(actives, 'hide')
          activesData || actives.data('bs.collapse', null)
        }

        var dimension = this.dimension()

        this.$element
          .removeClass('collapse')
          .addClass('collapsing')[dimension](0)
          .attr('aria-expanded', true)

        this.$trigger
          .removeClass('collapsed')
          .attr('aria-expanded', true)

        this.transitioning = 1

        var complete = function () {
          this.$element
            .removeClass('collapsing')
            .addClass('collapse in')[dimension]('')
          this.transitioning = 0
          this.$element
            .trigger('shown.bs.collapse')
        }

        if (!$.support.transition) return complete.call(this)

        var scrollSize = $.camelCase(['scroll', dimension].join('-'))

        this.$element
          .one('bsTransitionEnd', $.proxy(complete, this))
          .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
      }

      Collapse.prototype.hide = function () {
        if (this.transitioning || !this.$element.hasClass('in')) return

        var startEvent = $.Event('hide.bs.collapse')
        this.$element.trigger(startEvent)
        if (startEvent.isDefaultPrevented()) return

        var dimension = this.dimension()

        this.$element[dimension](this.$element[dimension]())[0].offsetHeight

        this.$element
          .addClass('collapsing')
          .removeClass('collapse in')
          .attr('aria-expanded', false)

        this.$trigger
          .addClass('collapsed')
          .attr('aria-expanded', false)

        this.transitioning = 1

        var complete = function () {
          this.transitioning = 0
          this.$element
            .removeClass('collapsing')
            .addClass('collapse')
            .trigger('hidden.bs.collapse')
        }

        if (!$.support.transition) return complete.call(this)

        this.$element
          [dimension](0)
          .one('bsTransitionEnd', $.proxy(complete, this))
          .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
      }

      Collapse.prototype.toggle = function () {
        this[this.$element.hasClass('in') ? 'hide' : 'show']()
      }

      Collapse.prototype.getParent = function () {
        return $(this.options.parent)
          .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
          .each($.proxy(function (i, element) {
            var $element = $(element)
            this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
          }, this))
          .end()
      }

      Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
        var isOpen = $element.hasClass('in')

        $element.attr('aria-expanded', isOpen)
        $trigger
          .toggleClass('collapsed', !isOpen)
          .attr('aria-expanded', isOpen)
      }

      function getTargetFromTrigger($trigger) {
        var href
        var target = $trigger.attr('data-target')
          || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

        return $(target)
      }


      // COLLAPSE PLUGIN DEFINITION
      // ==========================

      function Plugin(option) {
        return this.each(function () {
          var $this   = $(this)
          var data    = $this.data('bs.collapse')
          var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

          if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
          if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
          if (typeof option == 'string') data[option]()
        })
      }

      var old = $.fn.collapse

      $.fn.collapse             = Plugin
      $.fn.collapse.Constructor = Collapse


      // COLLAPSE NO CONFLICT
      // ====================

      $.fn.collapse.noConflict = function () {
        $.fn.collapse = old
        return this
      }


      // COLLAPSE DATA-API
      // =================

      $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
        var $this   = $(this)

        if (!$this.attr('data-target')) e.preventDefault()

        var $target = getTargetFromTrigger($this)
        var data    = $target.data('bs.collapse')
        var option  = data ? 'toggle' : $this.data()

        Plugin.call($target, option)
      })

    }(jQuery);
    </script><script>
    window.initializeCodeFolding = function(show) {

      // handlers for show-all and hide all
      $("#rmd-show-all-code").click(function() {
        $('div.r-code-collapse').each(function() {
          $(this).collapse('show');
        });
      });
      $("#rmd-hide-all-code").click(function() {
        $('div.r-code-collapse').each(function() {
          $(this).collapse('hide');
        });
      });

      // index for unique code element ids
      var currentIndex = 1;

      // select all R code blocks
      var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan, pre.js');
      rCodeBlocks.each(function() {

        // create a collapsable div to wrap the code in
        var div = $('<div class="collapse r-code-collapse"></div>');
        if (show)
          div.addClass('in');
        var id = 'rcode-643E0F36' + currentIndex++;
        div.attr('id', id);
        $(this).before(div);
        $(this).detach().appendTo(div);

        // add a show code button right above
        var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
        var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
        showCodeButton.append(showCodeText);
        showCodeButton
            .attr('data-toggle', 'collapse')
            .attr('data-target', '#' + id)
            .attr('aria-expanded', show)
            .attr('aria-controls', id);

        var buttonRow = $('<div class="row"></div>');
        var buttonCol = $('<div class="col-md-12"></div>');

        buttonCol.append(showCodeButton);
        buttonRow.append(buttonCol);

        div.before(buttonRow);

        // update state of button on show/hide
        div.on('hidden.bs.collapse', function () {
          showCodeText.text('Code');
        });
        div.on('show.bs.collapse', function () {
          showCodeText.text('Hide');
        });
      });

    }
    </script><script>
    /* ========================================================================
     * Bootstrap: dropdown.js v3.3.7
     * http://getbootstrap.com/javascript/#dropdowns
     * ========================================================================
     * Copyright 2011-2016 Twitter, Inc.
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
     * ======================================================================== */


    +function ($) {
      'use strict';

      // DROPDOWN CLASS DEFINITION
      // =========================

      var backdrop = '.dropdown-backdrop'
      var toggle   = '[data-toggle="dropdown"]'
      var Dropdown = function (element) {
        $(element).on('click.bs.dropdown', this.toggle)
      }

      Dropdown.VERSION = '3.3.7'

      function getParent($this) {
        var selector = $this.attr('data-target')

        if (!selector) {
          selector = $this.attr('href')
          selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
        }

        var $parent = selector && $(selector)

        return $parent && $parent.length ? $parent : $this.parent()
      }

      function clearMenus(e) {
        if (e && e.which === 3) return
        $(backdrop).remove()
        $(toggle).each(function () {
          var $this         = $(this)
          var $parent       = getParent($this)
          var relatedTarget = { relatedTarget: this }

          if (!$parent.hasClass('open')) return

          if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

          $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

          if (e.isDefaultPrevented()) return

          $this.attr('aria-expanded', 'false')
          $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
        })
      }

      Dropdown.prototype.toggle = function (e) {
        var $this = $(this)

        if ($this.is('.disabled, :disabled')) return

        var $parent  = getParent($this)
        var isActive = $parent.hasClass('open')

        clearMenus()

        if (!isActive) {
          if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
            // if mobile we use a backdrop because click events don't delegate
            $(document.createElement('div'))
              .addClass('dropdown-backdrop')
              .insertAfter($(this))
              .on('click', clearMenus)
          }

          var relatedTarget = { relatedTarget: this }
          $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

          if (e.isDefaultPrevented()) return

          $this
            .trigger('focus')
            .attr('aria-expanded', 'true')

          $parent
            .toggleClass('open')
            .trigger($.Event('shown.bs.dropdown', relatedTarget))
        }

        return false
      }

      Dropdown.prototype.keydown = function (e) {
        if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

        var $this = $(this)

        e.preventDefault()
        e.stopPropagation()

        if ($this.is('.disabled, :disabled')) return

        var $parent  = getParent($this)
        var isActive = $parent.hasClass('open')

        if (!isActive && e.which != 27 || isActive && e.which == 27) {
          if (e.which == 27) $parent.find(toggle).trigger('focus')
          return $this.trigger('click')
        }

        var desc = ' li:not(.disabled):visible a'
        var $items = $parent.find('.dropdown-menu' + desc)

        if (!$items.length) return

        var index = $items.index(e.target)

        if (e.which == 38 && index > 0)                 index--         // up
        if (e.which == 40 && index < $items.length - 1) index++         // down
        if (!~index)                                    index = 0

        $items.eq(index).trigger('focus')
      }


      // DROPDOWN PLUGIN DEFINITION
      // ==========================

      function Plugin(option) {
        return this.each(function () {
          var $this = $(this)
          var data  = $this.data('bs.dropdown')

          if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
          if (typeof option == 'string') data[option].call($this)
        })
      }

      var old = $.fn.dropdown

      $.fn.dropdown             = Plugin
      $.fn.dropdown.Constructor = Dropdown


      // DROPDOWN NO CONFLICT
      // ====================

      $.fn.dropdown.noConflict = function () {
        $.fn.dropdown = old
        return this
      }


      // APPLY TO STANDARD DROPDOWN ELEMENTS
      // ===================================

      $(document)
        .on('click.bs.dropdown.data-api', clearMenus)
        .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
        .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
        .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
        .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

    }(jQuery);
    </script><style type="text/css">
    .code-folding-btn { margin-bottom: 4px; }
    .row { display: flex; }
    .collapse { display: none; }
    .in { display:block }
    .pull-right > .dropdown-menu {
        right: 0;
        left: auto;
    }
    .open > .dropdown-menu {
        display: block;
    }
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        display: none;
        float: left;
        min-width: 160px;
        padding: 5px 0;
        margin: 2px 0 0;
        font-size: 14px;
        text-align: left;
        list-style: none;
        background-color: #fff;
        -webkit-background-clip: padding-box;
        background-clip: padding-box;
        border: 1px solid #ccc;
        border: 1px solid rgba(0,0,0,.15);
        border-radius: 4px;
        -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
        box-shadow: 0 6px 12px rgba(0,0,0,.175);
    }
    </style>
<script>
    $(document).ready(function () {
      window.initializeCodeFolding("show" === "show");
    });
    </script><script>
    document.write('<div class="btn-group pull-right" style="position: absolute; top: 20%; right: 2%; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>')
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">医学研究中的生存数据建模</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">前言</a></li>
<li><a class="" href="%E4%BD%9C%E8%80%85%E4%BB%8B%E7%BB%8D.html">作者介绍</a></li>
<li><a class="" href="%E7%9B%AE%E5%BD%95.html">目录</a></li>
<li class="book-part">正文</li>
<li><a class="" href="chap1.html"><span class="header-section-number">1</span> 生存分析</a></li>
<li><a class="" href="chap2.html"><span class="header-section-number">2</span> 一些非参数程序</a></li>
<li><a class="" href="chap3.html"><span class="header-section-number">3</span> Cox 回归模型</a></li>
<li><a class="" href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html">►Cox 回归模型</a></li>
<li><a class="" href="chap4.html"><span class="header-section-number">4</span> Cox 回归模型的模型检查</a></li>
<li><a class="" href="chap5.html"><span class="header-section-number">5</span> 参数回归模型</a></li>
<li><a class="" href="%E5%8F%82%E6%95%B0%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html">►参数回归模型</a></li>
<li><a class="" href="chap6.html"><span class="header-section-number">6</span> 灵活的参数模型</a></li>
<li><a class="" href="chap7.html"><span class="header-section-number">7</span> 参数模型的模型检查</a></li>
<li><a class="" href="chap8.html"><span class="header-section-number">8</span> 时依变量</a></li>
<li><a class="" href="chap9.html"><span class="header-section-number">9</span> 区间删失生存数据</a></li>
<li><a class="" href="chap10.html"><span class="header-section-number">10</span> 脆弱模型</a></li>
<li><a class="" href="chap11.html"><span class="header-section-number">11</span> 非比例风险和机构的比较</a></li>
<li><a class="" href="chap12.html"><span class="header-section-number">12</span> 竞争风险</a></li>
<li><a class="" href="chap13.html"><span class="header-section-number">13</span> 多次事件和事件史分析</a></li>
<li><a class="" href="chap14.html"><span class="header-section-number">14</span> 相依删失</a></li>
<li><a class="" href="chap15.html"><span class="header-section-number">15</span> 生存研究的样本量要求</a></li>
<li><a class="" href="chap16.html"><span class="header-section-number">16</span> 贝叶斯生存分析</a></li>
<li><a class="active" href="chap17.html"><span class="header-section-number">17</span> 使用 R 进行生存分析</a></li>
<li class="book-part">附录</li>
<li><a class="" href="A.html"><span class="header-section-number">A</span> 最大似然估计</a></li>
<li><a class="" href="B.html"><span class="header-section-number">B</span> 额外数据集</a></li>
<li class="book-part">—</li>
<li><a class="" href="bib.html">参考书目</a></li>
<li><a class="" href="exm.html">示例索引</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="chap17" class="section level1" number="17">
<h1>
<span class="header-section-number">第 17 章</span> 使用 R 进行生存分析<a class="anchor" aria-label="anchor" href="#chap17"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<details open><summary><font color="#8B2232">阅读提示</font>
</summary><p><br>
本章给出了许多代码块 (code chunk)，默认为全局打开。点击代码块的 “Hide” 可隐藏该代码块 ；若希望全局隐藏以方便阅读，需将页面划到最上方，右侧会显示一个额外的全局控制，将其设为 “Hide All Code” 即可（默认为 “Show All Code”）。</p>
<p>如无法显示/隐藏，可试着将全局控制的两个选项各点一次，原因不详。</p>
<p>同时，为尊重原著，未删除代码块中的提示符 <code>&gt;</code> ，因此直接将代码复制粘贴到 R 中并运行是会报错的，需删除该提示符。</p>
</details>
</div>
<p>有许多统计软件包可用于实现本书中描述的技术，其中一些已在第 1 章 <a href="chap1.html#sec1-5">1.5</a> 节中提及。其中，R (R Core Team, 2024) 可能是使用得最广泛的，至少有三个原因。首先，已经为各种各样的统计任务开发了 R 包，这些包由作者维护和更新。其次，新统计技术的开发和发布及其在 R 中的实施之间的周期相对较短，并且 R 代码通常伴随着新统计方法的发布。第三，R 是免费软件，可供所有人使用。然而，R 并不是一个容易学习的包，有一些编程经验是一个优势。其输出也往往相当简洁，但有时很难解释。就生存数据的分析而言，本章中的材料应该有助于解决这些问题。</p>
<p>本章首先介绍了 R 代码和命名法，概述了数据输入和编辑的基础知识。接着，本章介绍了使用第 <a href="chap2.html#chap2">2</a> 章至第 <a href="chap16.html#chap16">16</a> 章描述的方法建模生存数据的 R 包。每种情况下都包含足够的细节，使读者能够快速入门。尽管对于任何特定任务通常都有许多不同的 R 包可以使用，但本章主要关注用于展示本书所涉技术的那些包。在某些情况下，这里展示的 R 代码可能不是最优雅或最简洁的，但应该相对容易理解。本章并不试图对软件进行全面评述，随着新包的开发和其他包的弃用，本章中的部分材料不可避免地会过时。</p>
<div id="sec17-1" class="section level2" number="17.1">
<h2>
<span class="header-section-number">17.1</span> R 的介绍<a class="anchor" aria-label="anchor" href="#sec17-1"><i class="fas fa-link"></i></a>
</h2>
<p>R 软件可以从 Comprehensive R Archive Network (CRAN) 下载，网址为 <a href="https://www.r-project.org" class="uri">https://www.r-project.org</a>。 该网站链接了许多国家的站点，从这些站点可以下载适用于 Linux, Windows 或 macOS 的 R code. R 的界面相当基础，但通过使用 RStudio Desktop 可以得到增强。RStudio Desktop 是 R 的一个集成开发环境，也是开源的，可从 <a href="https://posit.co/download/rstudio-desktop/" class="uri">https://posit.co/download/rstudio-desktop/</a> 下载。
除了具有源代码编辑器，可以在运行 R 命令之前输入命令外，RStudio 还简化了保存和检索文件以及访问命令语法帮助的操作。当运行代码时，输出会出现在单独的窗口中，还有用于图形的窗口、工作区中的变量列表以及已使用命令的历史记录。安装 R 和 RStudio 后，可以通过打开 RStudio 来启动 R.</p>
<p>与 R 的交互是通过带有 “&gt;” 提示符的命令行进行的。在后续给出的代码中，R 命令将以 “&gt;” 为前缀，<strong>但是该符号不是命令的一部分</strong>。R 命令直接或通过 RStudio 中的源编辑器输入到 R 工作区中。通常，使用 <code>setwd(工作目录名称)</code> 指定可以存储 R 代码的工作目录或文件夹比较方便，并且可以使用 <code><a href="https://rdrr.io/r/base/getwd.html">getwd()</a></code> 检查当前目录的名称。</p>
</div>
<div id="sec17-2" class="section level2" number="17.2">
<h2>
<span class="header-section-number">17.2</span> 数据输入和编辑<a class="anchor" aria-label="anchor" href="#sec17-2"><i class="fas fa-link"></i></a>
</h2>
<p>用于生存分析的数据集通常具有与生存时间、删失或状态指示符以及解释变量或因子相对应的列，而行则包含每个个体的变量值。要使用 R 进行分析的数据集称为<strong>数据框</strong> (dataframe)，这是一个矩形数组，其中列对应于变量，行对应于观测。</p>
<p>变量的值可直接读入，例如</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="chap17.html#cb2-1" tabindex="-1"></a><span class="sc">&gt;</span> x<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">3.6</span>,<span class="fl">4.2</span>,<span class="fl">7.5</span>,<span class="fl">5.8</span>,<span class="fl">3.6</span>)</span></code></pre></div>
<p>其中 <code>&lt;-</code> 是赋值运算符。在许多情况下，可以使用等号 <code>=</code>。函数 <code>c</code> 将函数的自变量组合成一个向量。然后 R 可以用作计算器来操纵变量的值，如</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="chap17.html#cb3-1" tabindex="-1"></a><span class="sc">&gt;</span> y<span class="ot">&lt;-</span>x<span class="sc">*</span><span class="fu">log</span>(x)<span class="sc">+</span><span class="fu">exp</span>(x<span class="sc">^</span><span class="dv">3</span><span class="sc">/</span><span class="dv">20</span>)</span></code></pre></div>
<p>用于计算 <span class="math inline">\(y = x \log(x) + \exp(x^3/20)\)</span>，并且可以通过在命令提示符下键入 <code>print(y)</code> 或简单地输入 <code>y</code> 来输出结果。也可在计算中使用统计函数，例如</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="chap17.html#cb4-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">mean</span>(x)</span>
<span id="cb4-2"><a href="chap17.html#cb4-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">sd</span>(x)</span></code></pre></div>
<p>要创建包含变量 <code>x</code> 和 <code>y</code> 的 R 数据框，请将值分配给数据框名称，如下所示</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="chap17.html#cb5-1" tabindex="-1"></a><span class="sc">&gt;</span> testdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x,y)</span></code></pre></div>
<p>可以使用前缀 <code>#</code> 将注释添加到 R 代码中。这一系列计算步骤产生的输出如下所示。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="chap17.html#cb6-1" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb6-2"><a href="chap17.html#cb6-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.491812e+01</span> <span class="fl">4.665302e+01</span> <span class="fl">1.448436e+09</span> <span class="fl">1.726076e+04</span> <span class="fl">1.491812e+01</span></span>
<span id="cb6-3"><a href="chap17.html#cb6-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># 形成 x 值的均值和标准差</span></span>
<span id="cb6-4"><a href="chap17.html#cb6-4" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">mean</span>(x)</span>
<span id="cb6-5"><a href="chap17.html#cb6-5" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">4.94</span></span>
<span id="cb6-6"><a href="chap17.html#cb6-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">sd</span>(x)</span>
<span id="cb6-7"><a href="chap17.html#cb6-7" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.690562</span></span>
<span id="cb6-8"><a href="chap17.html#cb6-8" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># 根据 x 和 y 构造数据框</span></span>
<span id="cb6-9"><a href="chap17.html#cb6-9" tabindex="-1"></a><span class="er">&gt;</span> testdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x,y)</span>
<span id="cb6-10"><a href="chap17.html#cb6-10" tabindex="-1"></a><span class="sc">&gt;</span> testdata</span>
<span id="cb6-11"><a href="chap17.html#cb6-11" tabindex="-1"></a>    x            y</span>
<span id="cb6-12"><a href="chap17.html#cb6-12" tabindex="-1"></a><span class="dv">1</span> <span class="fl">3.6</span> <span class="fl">1.491812e+01</span></span>
<span id="cb6-13"><a href="chap17.html#cb6-13" tabindex="-1"></a><span class="dv">2</span> <span class="fl">4.2</span> <span class="fl">4.665302e+01</span></span>
<span id="cb6-14"><a href="chap17.html#cb6-14" tabindex="-1"></a><span class="dv">3</span> <span class="fl">7.5</span> <span class="fl">1.448436e+09</span></span>
<span id="cb6-15"><a href="chap17.html#cb6-15" tabindex="-1"></a><span class="dv">4</span> <span class="fl">5.8</span> <span class="fl">1.726076e+04</span></span>
<span id="cb6-16"><a href="chap17.html#cb6-16" tabindex="-1"></a><span class="dv">5</span> <span class="fl">3.6</span> <span class="fl">1.491812e+01</span></span></code></pre></div>
<p>请注意，某些命令（例如 <code>data.frame</code>）由两个单词组成，并用点分隔它们。变量名称还可以包含点，如 <code>newdata.x</code>，并且所有变量名称和命令名称都区分大小写。有大量数学和统计函数可以这种方式操作数据，包括用于条件执行语句、数据取子集、矩阵代数等命令。任何命令的帮助文档，例如 <code>data.frame</code>，都可以使用 <code><a href="https://rdrr.io/r/base/data.frame.html">help(data.frame)</a></code> 获得。</p>
<div id="sec17-2-1" class="section level3" number="17.2.1">
<h3>
<span class="header-section-number">17.2.1</span> 从文件中读取和操作数据<a class="anchor" aria-label="anchor" href="#sec17-2-1"><i class="fas fa-link"></i></a>
</h3>
<p>本书的数据集均可从出版商网站 <a href="https://www.routledge.com/" class="uri">https://www.routledge.com/</a>
获得（译者注：具体链接为<a href="https://s3-eu-west-1.amazonaws.com/s3-euw1-ap-pe-ws4-cws-documents.ri-prod/9781032252858/Data%20sets%20from%20Modelling%20Survival%20Data%20in%20Medical%20Research%2C%204th%20edition.zip">这里</a>），并且可使用 <code>read.table</code> 函数读入 R 并形成数据框。假设本章中使用的数据集位于当前工作目录中。</p>
<p><a href="chap1.html#exm:ex1-2">示例 1.2</a> 中有关女性确诊为乳腺癌后的生存时间数据可输入并分配给名为 <code>bcancer</code> 的数据框，如</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="chap17.html#cb7-1" tabindex="-1"></a><span class="sc">&gt;</span> bcancer<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Prognosis for women with breast cancer.dat"</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>这里，引号中的文件名是完整路径名，或者如果数据文件存储在当前目录中，则只是数据文件本身的名称。选项 <code>header=TRUE</code> 表示变量名称已包含在数据集中，并且这些变量名称将用作数据框中的变量名称。</p>
<p>请注意，为了使表 1.2 提供的数据适用于基于计算机的分析，<code>time</code> 和 <code>status</code> 这两个变量表示右删失数据，其中如果观测时间是事件，则 <code>status=1</code>，否则 <code>status=0</code>。可以使用 <code>print</code> 函数检查数据框，如 <code>print(bcancer)</code> ，或者只需在提示符处键入数据框名称，如</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="chap17.html#cb8-1" tabindex="-1"></a><span class="sc">&gt;</span> bcancer</span>
<span id="cb8-2"><a href="chap17.html#cb8-2" tabindex="-1"></a>   stain time status</span>
<span id="cb8-3"><a href="chap17.html#cb8-3" tabindex="-1"></a><span class="dv">1</span>      <span class="dv">1</span>   <span class="dv">23</span>      <span class="dv">1</span></span>
<span id="cb8-4"><a href="chap17.html#cb8-4" tabindex="-1"></a><span class="dv">2</span>      <span class="dv">1</span>   <span class="dv">47</span>      <span class="dv">1</span></span>
<span id="cb8-5"><a href="chap17.html#cb8-5" tabindex="-1"></a><span class="dv">3</span>      <span class="dv">1</span>   <span class="dv">69</span>      <span class="dv">1</span></span>
<span id="cb8-6"><a href="chap17.html#cb8-6" tabindex="-1"></a><span class="dv">4</span>      <span class="dv">1</span>   <span class="dv">70</span>      <span class="dv">0</span></span>
<span id="cb8-7"><a href="chap17.html#cb8-7" tabindex="-1"></a><span class="dv">5</span>      <span class="dv">1</span>   <span class="dv">71</span>      <span class="dv">0</span></span>
<span id="cb8-8"><a href="chap17.html#cb8-8" tabindex="-1"></a> .  .  .  .  .  .  .</span></code></pre></div>
<p>在前五个观测后，输出被截断。另一个有用的命令是 <code>summary</code>，它给出数据框中变量的描述性统计信息，如</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="chap17.html#cb9-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(bcancer)</span>
<span id="cb9-2"><a href="chap17.html#cb9-2" tabindex="-1"></a>     stain            time            status      </span>
<span id="cb9-3"><a href="chap17.html#cb9-3" tabindex="-1"></a> Min.   <span class="sc">:</span><span class="fl">1.000</span>   Min.   <span class="sc">:</span>  <span class="fl">5.00</span>   Min.   <span class="sc">:</span><span class="fl">0.0000</span>  </span>
<span id="cb9-4"><a href="chap17.html#cb9-4" tabindex="-1"></a> 1st Qu.<span class="sc">:</span><span class="fl">1.000</span>   1st Qu.<span class="sc">:</span> <span class="fl">40.00</span>   1st Qu.<span class="sc">:</span><span class="fl">0.0000</span>  </span>
<span id="cb9-5"><a href="chap17.html#cb9-5" tabindex="-1"></a> Median <span class="sc">:</span><span class="fl">2.000</span>   Median <span class="sc">:</span> <span class="fl">71.00</span>   Median <span class="sc">:</span><span class="fl">1.0000</span>  </span>
<span id="cb9-6"><a href="chap17.html#cb9-6" tabindex="-1"></a> Mean   <span class="sc">:</span><span class="fl">1.711</span>   Mean   <span class="sc">:</span> <span class="fl">96.24</span>   Mean   <span class="sc">:</span><span class="fl">0.5778</span>  </span>
<span id="cb9-7"><a href="chap17.html#cb9-7" tabindex="-1"></a> 3rd Qu.<span class="sc">:</span><span class="fl">2.000</span>   3rd Qu.<span class="sc">:</span><span class="fl">148.00</span>   3rd Qu.<span class="sc">:</span><span class="fl">1.0000</span>  </span>
<span id="cb9-8"><a href="chap17.html#cb9-8" tabindex="-1"></a> Max.   <span class="sc">:</span><span class="fl">2.000</span>   Max.   <span class="sc">:</span><span class="fl">225.00</span>   Max.   <span class="sc">:</span><span class="fl">1.0000</span>  </span></code></pre></div>
<p>经常会发生具有相同名称的变量在不同数据框中使用的情况。为了引用特定数据框中的特定变量，使用 <code>$</code> 符号来链接数据框名称和变量名称。例如，要通过将变量 <code>stain</code> 的值从 1, 2 转换为 0, 1 来形成新的变量 <code>stain1</code>，请使用</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="chap17.html#cb10-1" tabindex="-1"></a><span class="sc">&gt;</span> bcancer<span class="sc">$</span>stain1<span class="ot">&lt;-</span>bcancer<span class="sc">$</span>stain<span class="dv">-1</span></span></code></pre></div>
<p>操作数据集时通常需要的另一个过程是创建因子的工具。在乳腺癌数据集中，<code>stain</code> 是值为 1, 2 的变量。要将其设置为具有两个水平的因子，并分别将它们标记为“阴性”和“阳性”，请使用</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="chap17.html#cb11-1" tabindex="-1"></a><span class="sc">&gt;</span> bcancer<span class="sc">$</span>stainf<span class="ot">&lt;-</span><span class="fu">factor</span>(bcancer<span class="sc">$</span>stain,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Negative"</span>,<span class="st">"Positive"</span>))</span></code></pre></div>
<p>在该代码中，因子标签的分配顺序与数据中的顺序相同，因此当 <code>bcancer$stain=1</code> 时，因子水平被标记为 “Negative”.</p>
<p>要退出 R 会话，请使用 <code>quit</code>，这样您可以选择保存当前工作空间的内容以供将来使用。但是，要将工作区专门保存在 RData 类型的文件中，并在以后进行恢复，可以使用以下代码</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="chap17.html#cb12-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">save.image</span>(<span class="st">"breast cancer analysis"</span>) </span>
<span id="cb12-2"><a href="chap17.html#cb12-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">load</span>(<span class="st">"breast cancer analysis"</span>)</span></code></pre></div>
<p>在许多关于 R 的教科书中描述了可以进行的进一步操作，其中一些在本章末尾的延伸阅读部分提到。</p>
</div>
<div id="sec17-2-2" class="section level3" number="17.2.2">
<h3>
<span class="header-section-number">17.2.2</span> R 包<a class="anchor" aria-label="anchor" href="#sec17-2-2"><i class="fas fa-link"></i></a>
</h3>
<p>R 程序具有许多操作、分析和展示数据的功能，其中一些功能已在本节中概述。然而，R 的强大之处是通过使用包 (packages) 来实现的。包由代码、示例数据和文档组成，可从 Comprehensive R Archive Network (CRAN) 下载。通常，一个包包含了许多用于包内特定任务的函数。现已有数千个包，涵盖统计技术、数据可视化、数据操作、机器学习、报告生成等。当需要用于某些特定目的时，可以通过首先安装包将包合并到R中。然后将已安装的包加载到当前工作区中，以使它们能够在 R 会话中使用。</p>
<p>对于生存分析来说，一个特别重要的包是 <code>survival</code> 包。 CRAN 网站上包含完整的文档，作者提供了描述该软件包 Therneau (2024) 附带的 vignettes. 该软件包实现了多种生存分析方法，包括描述性技术、Cox 回归建模、参数建模、时依变量建模、脆弱建模和模型检查技术。</p>
<p>base R 软件包含许多广泛使用的软件包，包括 <code>survival</code>，但是可以使用以下命令安装和加载该软件包以及任何其他软件包</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="chap17.html#cb13-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">install.packages</span>(<span class="st">"survival"</span>) </span>
<span id="cb13-2"><a href="chap17.html#cb13-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(<span class="st">"survival"</span>)</span></code></pre></div>
<p>可以使用 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 检查库中的包列表。许多软件包需要其他软件包才能正常工作，这些软件包将与主软件包一起下载。</p>
<p>在以下各节中，按照本书的章节顺序，给出了用于实现生存数据建模特定技术的 R 代码。</p>
</div>
</div>
<div id="sec17-3" class="section level2" number="17.3">
<h2>
<span class="header-section-number">17.3</span> 非参数程序<a class="anchor" aria-label="anchor" href="#sec17-3"><i class="fas fa-link"></i></a>
</h2>
<p>分析生存数据的第一步通常是绘制两组或多组数据的生存函数的 Kaplan-Meier 估计。要在 R 中执行此操作，请使用 <code>survival</code> 包中的 <code>survfit</code> 函数。以下代码可用于估计乳腺癌预后数据中两组女性的生存函数</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="chap17.html#cb14-1" tabindex="-1"></a><span class="sc">&gt;</span> km<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> stain,<span class="at">data=</span>bcancer)</span>
<span id="cb14-2"><a href="chap17.html#cb14-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(km)</span></code></pre></div>
<p><code>survfit</code> 函数包含一个 survival 对象 <code>Surv</code>，用于描述模型公式中的响应变量。它的参数是生存时间和删失指示符，在本例中是 <code>time</code> 和 <code>status</code>。然后使用符号 <code>~</code> 将其链接到模型公式。如果模型中没有项，则模型公式可能仅包含 <code>1</code>，否则它是一串用符号 <code>+</code> 连接的变量和因子名称。还可以使用冒号 <code>:</code> 来连接项以构成交互作用项，以便 <code>x</code> 中变量的系数取决于 <code>a</code> 中因子水平，这由 <code>a:x</code> 表示。</p>
<p>在前面的代码中，指示了对两个染色组 Kaplan-Meier 估计的请求，但忽略组别的总体估计将使用 <code>Surv(time,status) ~ 1</code> 获得。<code>summary</code> 函数给出了每个 <code>stain</code> 值的生存函数估计的数值总结，该值可以是变量也可以是因子。<code>stain=1</code> 的 <code>summary</code> 输出如下</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="chap17.html#cb15-1" tabindex="-1"></a><span class="sc">&gt;</span> km<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> stain,<span class="at">data=</span>bcancer)</span>
<span id="cb15-2"><a href="chap17.html#cb15-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(km)</span>
<span id="cb15-3"><a href="chap17.html#cb15-3" tabindex="-1"></a>Call<span class="sc">:</span> <span class="fu">survfit</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> stain, <span class="at">data =</span> bcancer)</span>
<span id="cb15-4"><a href="chap17.html#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="chap17.html#cb15-5" tabindex="-1"></a>                stain<span class="ot">=</span><span class="dv">1</span> </span>
<span id="cb15-6"><a href="chap17.html#cb15-6" tabindex="-1"></a> time n.risk n.event survival std.err lower <span class="dv">95</span><span class="sc">% CI upper 95%</span> CI</span>
<span id="cb15-7"><a href="chap17.html#cb15-7" tabindex="-1"></a>   <span class="dv">23</span>     <span class="dv">13</span>       <span class="dv">1</span>    <span class="fl">0.923</span>  <span class="fl">0.0739</span>        <span class="fl">0.789</span>        <span class="fl">1.000</span></span>
<span id="cb15-8"><a href="chap17.html#cb15-8" tabindex="-1"></a>   <span class="dv">47</span>     <span class="dv">12</span>       <span class="dv">1</span>    <span class="fl">0.846</span>  <span class="fl">0.1001</span>        <span class="fl">0.671</span>        <span class="fl">1.000</span></span>
<span id="cb15-9"><a href="chap17.html#cb15-9" tabindex="-1"></a>   <span class="dv">69</span>     <span class="dv">11</span>       <span class="dv">1</span>    <span class="fl">0.769</span>  <span class="fl">0.1169</span>        <span class="fl">0.571</span>        <span class="fl">1.000</span></span>
<span id="cb15-10"><a href="chap17.html#cb15-10" tabindex="-1"></a>  <span class="dv">148</span>      <span class="dv">6</span>       <span class="dv">1</span>    <span class="fl">0.641</span>  <span class="fl">0.1522</span>        <span class="fl">0.402</span>        <span class="fl">1.000</span></span>
<span id="cb15-11"><a href="chap17.html#cb15-11" tabindex="-1"></a>  <span class="dv">181</span>      <span class="dv">5</span>       <span class="dv">1</span>    <span class="fl">0.513</span>  <span class="fl">0.1673</span>        <span class="fl">0.271</span>        <span class="fl">0.972</span></span></code></pre></div>
<p>在这段代码中，<code>survfit</code> 的结果被保存到 <code>survfit</code> 对象 <code>km</code> 中。该对象包含可以提取或用于补充命令的信息。例如，使用带有 <code>km</code> 的 <code>plot</code> 函数可获得两个生存函数的图形，如</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="chap17.html#cb16-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(km,<span class="at">xlab=</span><span class="st">"Survival time"</span>,<span class="at">ylab=</span><span class="st">"Estimated survivor function"</span>)</span></code></pre></div>
<p>并得出与第 2 章图 2.9 所示非常相似的图。<code>plot</code> 函数有许多选项可用于自定义 CRAN 文档中描述的图形。还有其他的绘图函数，包括 <code>lattice</code> 包中的 <code>xyplot</code> 和 <code>ggplot2</code> 包。</p>
<details><summary><font color="#8B2232">图 2.9</font>
</summary><img src="figure/figure%202.9.png#center" style="width:80.0%"></details><p><br><code>survival</code> 包中的 R 函数 <code>surfdiff</code> 可用于执行第 2 章 <a href="chap2.html#sec2-6">2.6</a> 节描述的 log-rank 和 Peto-Peto 检验。该函数使用的检验统计量是 <span class="math inline">\(d_{1j}\)</span> 和 <span class="math inline">\(e_{1j}\)</span>（在 <span class="math inline">\(r\)</span> 个事件时间的第 <span class="math inline">\(j\)</span> 个事件时间，一组中观测的和预期的死亡人数）之差的加权和，由下式给出</p>
<p><span class="math display">\[\begin{aligned}U_T&amp;=\sum_{j=1}^rw_j(d_{1j}-e_{1j})\end{aligned}\]</span></p>
<p>权重为 <span class="math inline">\(w_j=[\hat{S}_{KM}(t_{(j)})]\rho\)</span>，其中 <span class="math inline">\(\hat{S}_{KM}(t_{(j)})\)</span> 为在假设两组生存函数之间没有差异的情况下，在第 <span class="math inline">\(j\)</span> 个有序事件时间 <span class="math inline">\(t_{(j)},j=1,2,\ldots,r\)</span> 处的总体生存函数。当 <span class="math inline">\(\rho=0\)</span> 时（这是 <span class="math inline">\(\rho\)</span> 的默认值），得到 log-rank 检验，<span class="math inline">\(\rho=1\)</span> 给出了 Peto-Peto 检验。</p>
<p>对于乳腺癌预后数据，其中数据包含在 R 数据框 <code>bcancer</code> 中，可以利用 <code>survediff</code> 使用以下代码进行 log-rank 检验</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="chap17.html#cb17-1" tabindex="-1"></a><span class="sc">&gt;</span> lr<span class="ot">&lt;-</span><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> stain,<span class="at">data=</span>bcancer)</span></code></pre></div>
<p>使用 <code>print(lr)</code> 得到以下输出，这与第 2 章<a href="chap2.html#exm:ex2-12">示例 2.12</a> 中的计算结果一致</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="chap17.html#cb18-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb18-2"><a href="chap17.html#cb18-2" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> stain, <span class="at">data =</span> bcancer)</span>
<span id="cb18-3"><a href="chap17.html#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="chap17.html#cb18-4" tabindex="-1"></a>         N Observed <span class="fu">Expected</span> (O<span class="sc">-</span>E)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="fu">E</span> (O<span class="sc">-</span>E)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>V</span>
<span id="cb18-5"><a href="chap17.html#cb18-5" tabindex="-1"></a>stain<span class="ot">=</span><span class="dv">1</span> <span class="dv">13</span>        <span class="dv">5</span>     <span class="fl">9.57</span>      <span class="fl">2.18</span>      <span class="fl">3.51</span></span>
<span id="cb18-6"><a href="chap17.html#cb18-6" tabindex="-1"></a>stain<span class="ot">=</span><span class="dv">2</span> <span class="dv">32</span>       <span class="dv">21</span>    <span class="fl">16.43</span>      <span class="fl">1.27</span>      <span class="fl">3.51</span></span>
<span id="cb18-7"><a href="chap17.html#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="chap17.html#cb18-8" tabindex="-1"></a> Chisq<span class="ot">=</span> <span class="fl">3.5</span>  on <span class="dv">1</span> degrees of freedom, p<span class="ot">=</span> <span class="fl">0.06</span> </span></code></pre></div>
<p>输出给出了每个染色组观测的和预期的事件数，最后一列中的检验统计量标题为 <code>(O-E)^2/V</code>。无论在计算中使用哪一组，检验统计量都是相同的。在这个例子中，默认的小数位数有时是不够的。输出中的位数可以通过使用 <code>print</code> 函数的 <code>digits=</code> 选项来更改，如 <code>print(lr,digits=5)</code>。结果输出的卡方值为 3.515（<span class="math inline">\(P=0.0608\)</span>）。</p>
<p>Wilcoxon 检验未在 <code>survival</code> 包中实现，但由于结果通常与 Peto-Peto 检验的结果非常相似，因此可以使用它来代替。为此，我们在 <code>survdiff</code> 中包含选项 <code>rho=1</code>。进行 Peto-Peto 检验所需的代码和输出如下</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="chap17.html#cb19-1" tabindex="-1"></a><span class="sc">&gt;</span> pp<span class="ot">&lt;-</span><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> stain,<span class="at">rho=</span><span class="dv">1</span>,<span class="at">data=</span>bcancer)</span>
<span id="cb19-2"><a href="chap17.html#cb19-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(pp)</span>
<span id="cb19-3"><a href="chap17.html#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="chap17.html#cb19-4" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb19-5"><a href="chap17.html#cb19-5" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> stain, <span class="at">data =</span> bcancer, </span>
<span id="cb19-6"><a href="chap17.html#cb19-6" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span>)</span>
<span id="cb19-7"><a href="chap17.html#cb19-7" tabindex="-1"></a></span>
<span id="cb19-8"><a href="chap17.html#cb19-8" tabindex="-1"></a>         N Observed <span class="fu">Expected</span> (O<span class="sc">-</span>E)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="fu">E</span> (O<span class="sc">-</span>E)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>V</span>
<span id="cb19-9"><a href="chap17.html#cb19-9" tabindex="-1"></a>stain<span class="ot">=</span><span class="dv">1</span> <span class="dv">13</span>      <span class="fl">3.0</span>      <span class="fl">6.6</span>      <span class="fl">1.97</span>      <span class="fl">4.11</span></span>
<span id="cb19-10"><a href="chap17.html#cb19-10" tabindex="-1"></a>stain<span class="ot">=</span><span class="dv">2</span> <span class="dv">32</span>     <span class="fl">15.7</span>     <span class="fl">12.1</span>      <span class="fl">1.08</span>      <span class="fl">4.11</span></span>
<span id="cb19-11"><a href="chap17.html#cb19-11" tabindex="-1"></a></span>
<span id="cb19-12"><a href="chap17.html#cb19-12" tabindex="-1"></a> Chisq<span class="ot">=</span> <span class="fl">4.1</span>  on <span class="dv">1</span> degrees of freedom, p<span class="ot">=</span> <span class="fl">0.04</span> </span></code></pre></div>
<p>结果与<a href="chap2.html#exm:ex2-13">示例 2.13</a> 中的计算一致。</p>
<p>如果特别需要 Wilcoxon 检验，则在首次安装 <code>PHInfiniteEstimates</code> 包后，可以按以下方式使用 <code>PHInfiniteEstimates</code> 包中的 R 函数 <code>gehan.wilcoxon.test</code></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="chap17.html#cb20-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(<span class="st">"PHInfiniteEstimates"</span>)</span>
<span id="cb20-2"><a href="chap17.html#cb20-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">gehan.wilcoxon.test</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> stain,<span class="at">data=</span>bcancer)</span>
<span id="cb20-3"><a href="chap17.html#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="chap17.html#cb20-4" tabindex="-1"></a>    Gehan<span class="sc">-</span>Wilcoxon</span>
<span id="cb20-5"><a href="chap17.html#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="chap17.html#cb20-6" tabindex="-1"></a>data<span class="sc">:</span>  </span>
<span id="cb20-7"><a href="chap17.html#cb20-7" tabindex="-1"></a><span class="er">=</span> <span class="fl">4.18</span>, p<span class="sc">-</span>value <span class="ot">=</span> <span class="fl">0.0409</span></span>
<span id="cb20-8"><a href="chap17.html#cb20-8" tabindex="-1"></a>alternative hypothesis<span class="sc">:</span> two<span class="sc">-</span>sided</span></code></pre></div>
<p>再次与<a href="chap2.html#exm:ex2-13">示例 2.13</a> 中的计算一致。</p>
<p>这些检验的 R 代码可以扩展为包含多个因子，并且可以通过在模型公式中包含 <code>strata</code> 项来实现第 2 章 <a href="chap2.html#sec2-8">2.8</a> 节描述的分层检验。</p>
</div>
<div id="sec17-4" class="section level2" number="17.4">
<h2>
<span class="header-section-number">17.4</span> Cox 回归模型<a class="anchor" aria-label="anchor" href="#sec17-4"><i class="fas fa-link"></i></a>
</h2>
<p>给出第 <span class="math inline">\(i\)</span> 个个体（共 <span class="math inline">\(n\)</span> 个）在时间 <span class="math inline">\(t\)</span> 发生事件风险的 Cox 回归模型为</p>
<p><span class="math display">\[\begin{aligned}h_i(t)=\exp(\boldsymbol{\beta'x}_i)h_0(t)\end{aligned}\]</span></p>
<p>其中 <span class="math inline">\(\boldsymbol{\beta}^{\prime}\boldsymbol{x}_i\)</span> 是第 <span class="math inline">\(i(i=1,2,\ldots,n)\)</span> 个个体解释变量值的线性组合。 <span class="math inline">\(h_0(t)\)</span> 是未指定的基线风险函数。该模型可以使用 <code>survival</code> 包中的 R 函数 <code>coxph</code> 进行拟合。指定模型的语法与函数 <code>surfit</code> 中使用的语法相同，因为 <code>Surv</code> 对象链接到模型公式。</p>
<p>如何处理结生存时间是一个重要的问题，这在第 3 章 <a href="chap3.html#sec3-3-2">3.3.2</a> 节讨论过。许多 Cox 回归分析软件包使用 Breslow 法作为默认方法，主要是因为它在计算上很简单。然而，R生存函数 <code>coxph</code> 默认使用 Efron 法，因为该法更准确。这意味着 R 的默认输出可能与其他软件包的输出不匹配。为了更改 <code>coxph</code> 中处理结的方法，包含选项 <code>ties="breslow"</code>，如下所示。输出将与本书中使用 Breslow 法的示例相对应。</p>
<p>为了说明 <code>coxph</code> 函数的使用，将使用第 1 章<a href="chap1.html#exm:ex1-3">示例 1.3</a> 中给出的 48 名多发性骨髓瘤患者的生存时间数据。下面给出了用于输入数据并拟合包含变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的 Cox 回归模型的 R 代码。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="chap17.html#cb21-1" tabindex="-1"></a><span class="sc">&gt;</span> myeloma<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival of multiple myeloma patients.dat"</span>, <span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb21-2"><a href="chap17.html#cb21-2" tabindex="-1"></a><span class="sc">&gt;</span> coxregfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> hb<span class="sc">+</span>bun,<span class="at">ties=</span><span class="st">"breslow"</span>, <span class="at">data=</span>myeloma)</span></code></pre></div>
<p>使用 <code>summary(coxregfit)</code> 将得到如下输出</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="chap17.html#cb22-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb22-2"><a href="chap17.html#cb22-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hb <span class="sc">+</span> bun, <span class="at">data =</span> myeloma, </span>
<span id="cb22-3"><a href="chap17.html#cb22-3" tabindex="-1"></a>    <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb22-4"><a href="chap17.html#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="chap17.html#cb22-5" tabindex="-1"></a>  n<span class="ot">=</span> <span class="dv">48</span>, number of events<span class="ot">=</span> <span class="dv">36</span> </span>
<span id="cb22-6"><a href="chap17.html#cb22-6" tabindex="-1"></a></span>
<span id="cb22-7"><a href="chap17.html#cb22-7" tabindex="-1"></a>         coef <span class="fu">exp</span>(coef)  <span class="fu">se</span>(coef)      z <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>z<span class="sc">|</span>)   </span>
<span id="cb22-8"><a href="chap17.html#cb22-8" tabindex="-1"></a>hb  <span class="sc">-</span><span class="fl">0.133639</span>  <span class="fl">0.874906</span>  <span class="fl">0.062051</span> <span class="sc">-</span><span class="fl">2.154</span>  <span class="fl">0.03126</span> <span class="sc">*</span> </span>
<span id="cb22-9"><a href="chap17.html#cb22-9" tabindex="-1"></a>bun  <span class="fl">0.018571</span>  <span class="fl">1.018745</span>  <span class="fl">0.005674</span>  <span class="fl">3.273</span>  <span class="fl">0.00106</span> <span class="sc">**</span></span>
<span id="cb22-10"><a href="chap17.html#cb22-10" tabindex="-1"></a><span class="sc">---</span></span>
<span id="cb22-11"><a href="chap17.html#cb22-11" tabindex="-1"></a>Signif. codes<span class="sc">:</span>  <span class="dv">0</span> ‘<span class="sc">**</span><span class="er">*</span>’ <span class="fl">0.001</span> ‘<span class="sc">**</span>’ <span class="fl">0.01</span> ‘<span class="sc">*</span>’ <span class="fl">0.05</span> ‘.’ <span class="fl">0.1</span> ‘ ’ <span class="dv">1</span></span>
<span id="cb22-12"><a href="chap17.html#cb22-12" tabindex="-1"></a></span>
<span id="cb22-13"><a href="chap17.html#cb22-13" tabindex="-1"></a>    <span class="fu">exp</span>(coef) <span class="fu">exp</span>(<span class="sc">-</span>coef) lower .<span class="dv">95</span> upper .<span class="dv">95</span></span>
<span id="cb22-14"><a href="chap17.html#cb22-14" tabindex="-1"></a>hb     <span class="fl">0.8749</span>     <span class="fl">1.1430</span>    <span class="fl">0.7747</span>     <span class="fl">0.988</span></span>
<span id="cb22-15"><a href="chap17.html#cb22-15" tabindex="-1"></a>bun    <span class="fl">1.0187</span>     <span class="fl">0.9816</span>    <span class="fl">1.0075</span>     <span class="fl">1.030</span></span>
<span id="cb22-16"><a href="chap17.html#cb22-16" tabindex="-1"></a></span>
<span id="cb22-17"><a href="chap17.html#cb22-17" tabindex="-1"></a>Concordance<span class="ot">=</span> <span class="fl">0.672</span>  (<span class="at">se =</span> <span class="fl">0.053</span> )</span>
<span id="cb22-18"><a href="chap17.html#cb22-18" tabindex="-1"></a>Likelihood ratio test<span class="ot">=</span> <span class="dv">13</span>  on <span class="dv">2</span> df,   p<span class="ot">=</span><span class="fl">0.002</span></span>
<span id="cb22-19"><a href="chap17.html#cb22-19" tabindex="-1"></a>Wald test            <span class="ot">=</span> <span class="fl">14.86</span>  on <span class="dv">2</span> df,   p<span class="ot">=</span><span class="fl">6e-04</span></span>
<span id="cb22-20"><a href="chap17.html#cb22-20" tabindex="-1"></a><span class="fu">Score</span> (logrank) test <span class="ot">=</span> <span class="fl">17.76</span>  on <span class="dv">2</span> df,   p<span class="ot">=</span><span class="fl">1e-04</span></span></code></pre></div>
<p>拟合的 Cox 回归模型中变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的系数估计分别为 -0.1336 和 0.0186，标准误分别为 0.0620 和 0.0057。输出中包括了基于统计量 <span class="math inline">\(z=\hat{\beta}/\text{se}(\hat{\beta})\)</span> 和相应 <span class="math inline">\(P\)</span> 值的 Wald 检验。还给出了风险比 <span class="math inline">\(\exp(\hat\beta)\)</span>，在标题为 <code>lower .95</code> 和 <code>upper .95</code> 的列中还包括了相应的 95% 置信限。然后是一致性度量，即第 3 章<a href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#sec3-12-1">3.12.1</a> 节中描述的 c 统计量，以及拟合模型中所有系数均为零的假设的似然比、Wald 和 得分检验结果。这些检验在附录 A 的 <a href="A.html#secA-2">A.2</a> 节中进行了定义，但很少使用 Wald 和得分检验。</p>
<p><code>coxph</code> 的输出不包括 <span class="math inline">\(−2\log\hat L\)</span> 统计量的值，但这可以使用从 <code>coxph</code> 对象的 <code>coxregfit</code> 中提取</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="chap17.html#cb23-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>coxregfit<span class="sc">$</span>loglik</span>
<span id="cb23-2"><a href="chap17.html#cb23-2" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">215.9399</span> <span class="fl">202.9382</span></span></code></pre></div>
<p>该输出的两个值分别是没有解释变量的模型（即零模型）和拟合模型的统计量的值，这些与第 <a href="chap3.html#chap3">3</a> 章表 3.9 中的值一致。</p>
<p>用于比较拟合模型与零模型的似然比检验的结果（如 <code>coxph</code> 的输出所示）是零模型和拟合模型的 <span class="math inline">\(−2\log\hat L\)</span> 值之差异，即 215.940 − 202.938 = 13.00。这可以与两个自由度的卡方分布的百分位点进行比较，以检验模型中是否需要 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span>。如第 3 章所述，模型构建方法通常按顺序包含变量，并且通常不关注该检验的结果通常。相反，我们应为每个模型获得 <span class="math inline">\(−2\log\hat L\)</span> 统计量，并将由于包含或省略项而引起的变化与卡方分布的百分位点进行比较。然而，当拟合了两个不同的模型时，R 输出中给出的似然比检验统计量之差将与 <span class="math inline">\(−2\log\hat L\)</span> 值之差相同。</p>
<p>使用 <code>coxph</code> 拟合的模型的 AIC 或 BIC 统计量可以通过分别将 <span class="math inline">\(2q\)</span> 或 <span class="math inline">\(q\log d\)</span> 添加到 <span class="math inline">\(−2\log\hat L\)</span> 的值来直接获得，其中 <span class="math inline">\(q\)</span> 是模型中 <span class="math inline">\(\beta\)</span> 参数的数量，<span class="math inline">\(d\)</span> 是未删失观测的数量。或者，函数 <code>extractAIC</code> 可以应用于 <code>coxph</code> 对象。默认给出 AIC，但使用选项 <code>k=</code> 可用于设置 <span class="math inline">\(\log d\)</span> 来给出 BIC。使用 <code>k=2</code>（默认值）将给出 AIC 的标准公式。</p>
<p>例如，确诊为多发性骨髓瘤患者的生存时间数据有 <span class="math inline">\(d=36\)</span> 个事件。该值可利用 <code>coxph</code> 对象 <code>coxregfit</code> 的 <code>coxregfit$nevent</code> 获取，下面的代码给出包含 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的模型的 AIC 和 BIC 统计量。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="chap17.html#cb24-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># AIC </span></span>
<span id="cb24-2"><a href="chap17.html#cb24-2" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">extractAIC</span>(coxregfit)</span>
<span id="cb24-3"><a href="chap17.html#cb24-3" tabindex="-1"></a>[<span class="dv">1</span>]   <span class="fl">2.0000</span> <span class="fl">206.9382</span></span>
<span id="cb24-4"><a href="chap17.html#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="chap17.html#cb24-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="co"># BIC </span></span>
<span id="cb24-6"><a href="chap17.html#cb24-6" tabindex="-1"></a><span class="er">&gt;</span> <span class="fu">extractAIC</span>(coxregfit,<span class="at">k=</span><span class="fu">log</span>(coxregfit<span class="sc">$</span>nevent))</span>
<span id="cb24-7"><a href="chap17.html#cb24-7" tabindex="-1"></a>[<span class="dv">1</span>]   <span class="fl">2.0000</span> <span class="fl">210.1052</span></span></code></pre></div>
<p>在该输出中，第一个数字是模型中参数数量 <span class="math inline">\(q\)</span> 的值，以及 AIC = 206.94，BIC = 210.10.</p>
<div id="sec17-4-1" class="section level3" number="17.4.1">
<h3>
<span class="header-section-number">17.4.1</span> 变量选择和 lasso<a class="anchor" aria-label="anchor" href="#sec17-4-1"><i class="fas fa-link"></i></a>
</h3>
<p>R 不包括用于变量选择的自动程序，因为它们有许多缺点，如第 3 章 <a href="chap3.html#sec3-6">3.6</a> 节所述。然而，<code>survival</code> 包中的 <code>anova</code> 函数给出当按照模型公式中出现的顺序依次向模型中添加项时得到的 <span class="math inline">\(−2\log\hat L\)</span> 的值。例如，<code>anova(coxregfit)</code> 的输出如下所示。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="chap17.html#cb25-1" tabindex="-1"></a>Analysis of Deviance Table</span>
<span id="cb25-2"><a href="chap17.html#cb25-2" tabindex="-1"></a> Cox model<span class="sc">:</span> response is <span class="fu">Surv</span>(time, status)</span>
<span id="cb25-3"><a href="chap17.html#cb25-3" tabindex="-1"></a>Terms added <span class="fu">sequentially</span> (first to last)</span>
<span id="cb25-4"><a href="chap17.html#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="chap17.html#cb25-5" tabindex="-1"></a>      loglik  Chisq Df <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>Chi<span class="sc">|</span>)   </span>
<span id="cb25-6"><a href="chap17.html#cb25-6" tabindex="-1"></a><span class="cn">NULL</span> <span class="sc">-</span><span class="fl">107.97</span>                        </span>
<span id="cb25-7"><a href="chap17.html#cb25-7" tabindex="-1"></a>hb   <span class="sc">-</span><span class="fl">105.53</span> <span class="fl">4.8717</span>  <span class="dv">1</span>   <span class="fl">0.027300</span> <span class="sc">*</span> </span>
<span id="cb25-8"><a href="chap17.html#cb25-8" tabindex="-1"></a>bun  <span class="sc">-</span><span class="fl">101.47</span> <span class="fl">8.1300</span>  <span class="dv">1</span>   <span class="fl">0.004354</span> <span class="sc">**</span></span>
<span id="cb25-9"><a href="chap17.html#cb25-9" tabindex="-1"></a><span class="sc">---</span></span>
<span id="cb25-10"><a href="chap17.html#cb25-10" tabindex="-1"></a>Signif. codes<span class="sc">:</span>  <span class="dv">0</span> ‘<span class="sc">**</span><span class="er">*</span>’ <span class="fl">0.001</span> ‘<span class="sc">**</span>’ <span class="fl">0.01</span> ‘<span class="sc">*</span>’ <span class="fl">0.05</span> ‘.’ <span class="fl">0.1</span> ‘ ’ <span class="dv">1</span></span></code></pre></div>
<p>这给出了最大化偏对数似然的值（从零模型开始，添加 <span class="math inline">\(Hb\)</span>，然后添加 <span class="math inline">\(Bun\)</span>），可以将其乘以 −2 以给出 <span class="math inline">\(−2\log\hat L\)</span> 统计量。标题为 <code>Pr(&gt;|Chi|)</code> 的列中的 <span class="math inline">\(P\)</span> 值指的是序贯地添加每个项时 <span class="math inline">\(−2\log\hat L\)</span> 的变化的显著性。将 <span class="math inline">\(Hb\)</span> 添加到零模型中会显著降低 <span class="math inline">\(−2\log\hat L\)</span>，将 <span class="math inline">\(Bun\)</span> 添加到包含 <span class="math inline">\(Hb\)</span> 的模型中也是如此。<span class="math inline">\(Bun\)</span> 的 <span class="math inline">\(P\)</span> 值 0.0043 对应于在考虑 <span class="math inline">\(Hb\)</span> 的效应后，该变量对死亡风险的效应的显著性。</p>
<p>为了了解调整 <span class="math inline">\(Bun\)</span> 后 <span class="math inline">\(Hb\)</span> 的显著性，在 <code>coxph</code> 命令中以相反的顺序给出这两个变量，如下所示</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="chap17.html#cb26-1" tabindex="-1"></a><span class="sc">&gt;</span> coxregfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> bun<span class="sc">+</span>hb,<span class="at">ties=</span><span class="st">"breslow"</span>,</span>
<span id="cb26-2"><a href="chap17.html#cb26-2" tabindex="-1"></a>                   <span class="at">data=</span>myeloma) </span>
<span id="cb26-3"><a href="chap17.html#cb26-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">anova</span>(coxregfit)</span></code></pre></div>
<p>第 3 章 <a href="chap3.html#sec3-7">3.7</a> 节描述了使用 lasso 来进行 Cox 回归模型的变量选择，这可以使用 <code>penalized</code> 包中的 R 函数 <code>penalized</code> 来实现。现使用 lasso 程序来确定在拟合多发性骨髓瘤患者生存数据的 Cox 回归模型中需要七个潜在解释变量中的哪一个，如第 3 章<a href="chap3.html#exm:ex3-7">示例 3.7</a> 所示。安装并加载 <code>penalized</code> 包后（如 <a href="chap17.html#sec17-2-2">17.2.2</a> 节所述），lasso 程序通过如下代码来实施</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="chap17.html#cb27-1" tabindex="-1"></a><span class="sc">&gt;</span> penfit<span class="ot">&lt;-</span><span class="fu">penalized</span>(<span class="fu">Surv</span>(time,status),<span class="at">penalized=</span> <span class="sc">~</span> hb<span class="sc">+</span>bun<span class="sc">+</span>age<span class="sc">+</span>sex<span class="sc">+</span></span>
<span id="cb27-2"><a href="chap17.html#cb27-2" tabindex="-1"></a>                      ca<span class="sc">+</span>protein<span class="sc">+</span>pcells,<span class="at">lambda1=</span><span class="dv">0</span>,<span class="at">steps=</span><span class="dv">20</span>,<span class="at">standardize=</span><span class="cn">TRUE</span>,</span>
<span id="cb27-3"><a href="chap17.html#cb27-3" tabindex="-1"></a>                  <span class="at">data=</span>myeloma)</span></code></pre></div>
<p><code>survival</code> 对象 <code>Surv(time,status)</code> 再次用作响应，但模型公式在 <code>penalized=</code> 选项中给出。请注意，公式开头需要一个 <code>~</code> 符号。如果只惩罚某些参数，则可以在 <code>unpenaltized=</code> 选项中声明其余参数。选项 <code>lambda1=0</code> 指定使用 <span class="math inline">\(L_1\)</span> 范数惩罚，它对应于 lasso，最小值为零。<code>steps=</code> 选项指定要使用 20 个 <span class="math inline">\(\lambda\)</span> 值。选项 <code>steps="Park"</code> 使用 Park and Hastie (2007) 中描述的方法自动选择步长。若选项 <code>standardize=</code> 设置为 <code>TRUE</code>，则将解释变量设置在类似的测量尺度上，如 <a href="chap3.html#sec3-7-2">3.7.2</a> 节所述。通过将 <code>penalized</code> 对象分配给 <code>penfit</code>，如下 R 命令</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="chap17.html#cb28-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(penfit) </span>
<span id="cb28-2"><a href="chap17.html#cb28-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plotpath</span>(penfit)</span></code></pre></div>
<p>给出对应于每个 lasso 参数 <span class="math inline">\(\lambda\)</span> 值的偏对数似然值，以及 <span class="math inline">\(\lambda\)</span> 值的系数估计的轨迹，如图 3.2 所示。</p>
<details><summary><font color="#8B2232">图 3.2</font>
</summary><img src="figure/figure%203.2.png#center" style="width:80.0%"></details>
</div>
<div id="sec17-4-2" class="section level3" number="17.4.2">
<h3>
<span class="header-section-number">17.4.2</span> 预测能力和解释的变异的度量<a class="anchor" aria-label="anchor" href="#sec17-4-2"><i class="fas fa-link"></i></a>
</h3>
<p>第 3 章 <a href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#sec3-12">3.12</a> 节总结了预测能力和解释的变异的各种度量。Harrell’s <span class="math inline">\(c\)</span> 统计量可使用 <code>survival</code> 包中的 <code>concordance</code> 函数计算，Gönen and Heller 的预测能力度量及其标准误可以使用 <code>CPE</code> 包中的函数 <code>phcpe</code> 计算，如下所示</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="chap17.html#cb29-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">concordance</span>(coxregfit) <span class="co"># Harrell's c 统计量</span></span>
<span id="cb29-2"><a href="chap17.html#cb29-2" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb29-3"><a href="chap17.html#cb29-3" tabindex="-1"></a><span class="fu">concordance.coxph</span>(<span class="at">object =</span> coxregfit)</span>
<span id="cb29-4"><a href="chap17.html#cb29-4" tabindex="-1"></a></span>
<span id="cb29-5"><a href="chap17.html#cb29-5" tabindex="-1"></a>n<span class="ot">=</span> <span class="dv">48</span> </span>
<span id="cb29-6"><a href="chap17.html#cb29-6" tabindex="-1"></a>Concordance<span class="ot">=</span> <span class="fl">0.6716</span> se<span class="ot">=</span> <span class="fl">0.05308</span></span>
<span id="cb29-7"><a href="chap17.html#cb29-7" tabindex="-1"></a>concordant discordant     tied.x     tied.y    tied.xy </span>
<span id="cb29-8"><a href="chap17.html#cb29-8" tabindex="-1"></a>       <span class="dv">585</span>        <span class="dv">286</span>          <span class="dv">0</span>         <span class="dv">20</span>          <span class="dv">0</span></span>
<span id="cb29-9"><a href="chap17.html#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="chap17.html#cb29-10" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">phcpe</span>(coxregfit,<span class="at">CPE.SE=</span><span class="cn">TRUE</span>) <span class="co"># Gonen-Heller statistic</span></span>
<span id="cb29-11"><a href="chap17.html#cb29-11" tabindex="-1"></a><span class="sc">$</span>CPE</span>
<span id="cb29-12"><a href="chap17.html#cb29-12" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.6694815</span></span>
<span id="cb29-13"><a href="chap17.html#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a href="chap17.html#cb29-14" tabindex="-1"></a><span class="sc">$</span>CPE.SE</span>
<span id="cb29-15"><a href="chap17.html#cb29-15" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.04128793</span></span></code></pre></div>
<p><span class="math inline">\(c\)</span> 统计量也包含在 <code>summary(coxregfit)</code> 的输出中。</p>
<p>总结预测能力的 <span class="math inline">\(D\)</span> 统计量以及表示为 <span class="math inline">\(R^2_P\)</span> 和 <span class="math inline">\(R^2_D\)</span> 的解释的变异的度量可以使用 <code>survival</code> 包中的 <code>royston</code> 函数获得。为多发性骨髓瘤数据拟合的包含 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的模型的这些统计量如下所示。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="chap17.html#cb30-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">royston</span>(coxregfit)</span>
<span id="cb30-2"><a href="chap17.html#cb30-2" tabindex="-1"></a>        D     <span class="fu">se</span>(D)       R.D      R.KO       R.N      C.GH </span>
<span id="cb30-3"><a href="chap17.html#cb30-3" tabindex="-1"></a><span class="fl">1.0076162</span> <span class="fl">0.3505868</span> <span class="fl">0.1950951</span> <span class="fl">0.2728951</span> <span class="fl">0.2399530</span> <span class="fl">0.6694815</span> </span></code></pre></div>
<p>在该输出中，前两项是 <span class="math inline">\(D\)</span> 统计量的值及其标准误，以第 3 章 <a href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#sec3-12">3.12</a> 节的表示法，<code>R.D</code> 为 <span class="math inline">\(R^2_D\)</span>，<code>R.KO</code> 为 <span class="math inline">\(R^2_P\)</span>。此外，<code>R.N</code> 为 Nagelkerke’s <span class="math inline">\(R^2\)</span> 值 (Nagelkerk, 1991)，<code>C.GH</code> 是 Gönen and Heller 的一致性度量。这些度量值与第 3 章表 3.20 所示值一致。</p>
</div>
<div id="sec17-4-3" class="section level3" number="17.4.3">
<h3>
<span class="header-section-number">17.4.3</span> 时依 ROC 曲线<a class="anchor" aria-label="anchor" href="#sec17-4-3"><i class="fas fa-link"></i></a>
</h3>
<p>函数 <code>survivalROC</code>（在同名包中）可用于为生存数据拟合模型后估计时依 ROC 曲线。ROC 曲线由拟合模型的风险评分或线性预测器形成，默认情况下，风险评分的唯一值用作计算真阳性率和假阳性率的阈值。由于 <code>survivalROC</code> 仅需要风险评分来估计时依 ROC 曲线，因此该函数可与任何参数生存模型以及 Cox 回归模型一起使用。</p>
<p>为多发性骨髓瘤数据拟合 Cox 回归模型后，可以使用以下命令从 <code>coxph</code> 对象 <code>coxregfit</code> 中提取风险评分或线性预测器</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lp1</span><span class="op">&lt;-</span><span class="va">coxregfit</span><span class="op">$</span><span class="va">linear.predictors</span></span></code></pre></div>
<p>然而，<code>lp1</code> 中风险评分的结果值基于以均值为中心的变量 Hb 和 Bun 的值。因为 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 值的平均值分别为 10.2521 和 33.9167，这意味着线性预测器或风险评分是</p>
<p><span class="math display">\[\begin{aligned}-0.13364~(Hb-10.2521)+0.01857~(Bun-33.9167)\end{aligned}\]</span></p>
<p>基于未转换变量的得分为 <span class="math inline">\(-0.13364Hb+0.01857Bun\)</span>，若要根据以零为中心的变量值计算，可以使用以下代码</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lp0</span><span class="op">&lt;-</span><span class="va">lp1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">coxregfit</span><span class="op">)</span><span class="op">*</span><span class="va">coxregfit</span><span class="op">$</span><span class="va">means</span><span class="op">)</span></span></code></pre></div>
<p>这样做的效果是将每个变量的系数和样本均值的乘积之和加到由变量的中心值形成的线性预测器中。</p>
<p>安装并加载 <code>survivalROC</code> 后，可以通过以下方式使用 <code>survivalROC</code> 函数获得 12 个月时的时依 ROC 曲线的坐标。</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mroc</span><span class="op">&lt;-</span><span class="fu">survivalROC</span><span class="op">(</span>Stime<span class="op">=</span><span class="va">myeloma</span><span class="op">$</span><span class="va">time</span>,status<span class="op">=</span><span class="va">myeloma</span><span class="op">$</span><span class="va">status</span>,marker<span class="op">=</span><span class="va">lp0</span>,</span>
<span>                  predict.time<span class="op">=</span><span class="fl">12</span>,method<span class="op">=</span><span class="st">"KM"</span><span class="op">)</span></span></code></pre></div>
<p>在该代码中，<code>Stime=</code> 和 <code>status=</code> 指定为骨髓瘤数据框中的生存时间和删失指示符，<code>marker=</code> 设置为 <code>lp0</code> 中的风险评分，时间点使用选项 <code>predict.time=12</code> 设置为 12 个月。使用 <code>method="KM"</code> 指定 Kaplan-Meier 估计方法。利用 <code>survivalROC</code> 对象 <code>mroc</code>，可使用 <code>TP12&lt;-mroc$TP</code> 和 <code>FP12&lt;-mroc$FP</code> 提取每个阈值的真阳性率和假阳性率 以及使用 <code>mroc$AUC</code> 获得 ROC 曲线下面积。之后，可以根据 <code>FP12</code> 绘制 <code>TP12</code> 的图形，得出 12 个月时的 ROC 曲线，如图 3.10 所示。</p>
<details><summary><font color="#8B2232">图 3.10</font>
</summary><img src="figure/figure%203.10.png#center" style="width:80.0%"></details><p><br>
还可使用选项 <code>method="NNE"</code> 来实现最近邻估计方法。此外，使用选项 <code>span=0.05</code>，将式 <a href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#eq:3-44">(3.44)</a> 中的平滑参数 <span class="math inline">\(\omega\)</span> 设为 0.05.</p>
</div>
</div>
<div id="sec17-5" class="section level2" number="17.5">
<h2>
<span class="header-section-number">17.5</span> Cox 回归模型中的模型检查<a class="anchor" aria-label="anchor" href="#sec17-5"><i class="fas fa-link"></i></a>
</h2>
<p>第 <a href="chap4.html#chap4">4</a> 章描述的许多模型检查诊断都是基于各种类型的残差。为了说明如何使用 R 获得残差，将再次使用<a href="chap1.html#exm:ex1-3">示例 1.3</a> 中首次给出的多发性骨髓瘤患者生存时间数据。</p>
<div id="sec17-5-1" class="section level3" number="17.5.1">
<h3>
<span class="header-section-number">17.5.1</span> 残差分析<a class="anchor" aria-label="anchor" href="#sec17-5-1"><i class="fas fa-link"></i></a>
</h3>
<p>通过将 <code>survival</code> 包中的 <code>residuals</code> 函数应用于 <code>survival</code> 对象，可以轻松获得残差。在 <a href="chap17.html#sec17-4">17.4</a> 节中，对多发性骨髓瘤数据拟合了 Cox 回归模型，并将结果存储在 <code>survival</code> 对象 <code>coxregfit</code> 中。然后可以得到鞅和偏差残差，并将其分配给变量 <code>martres</code> 和 <code>devres</code>，如下</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="chap17.html#cb34-1" tabindex="-1"></a><span class="sc">&gt;</span> martres<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"martingale"</span>))</span>
<span id="cb34-2"><a href="chap17.html#cb34-2" tabindex="-1"></a><span class="sc">&gt;</span> devres<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"deviance"</span>))</span></code></pre></div>
<p>Cox-Snell 和修正的 Cox-Snell 残差可以使用第 4 章的式 <a href="chap4.html#eq:4-6">(4.6)</a> 和 <a href="chap4.html#eq:4-4">(4.4)</a> 根据鞅残差计算</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="chap17.html#cb35-1" tabindex="-1"></a><span class="sc">&gt;</span> csres<span class="ot">&lt;-</span>myeloma<span class="sc">$</span>status<span class="sc">-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"martingale"</span>)) </span>
<span id="cb35-2"><a href="chap17.html#cb35-2" tabindex="-1"></a><span class="sc">&gt;</span> modcsres<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"martingale"</span>))</span></code></pre></div>
<p>得分、Schoenfeld 和缩放的 Schoenfeld 残差可分别使用 <code>residuals</code> 函数中的选项 <code>type=c("score")</code>, <code>type=c("schoenfeld")</code> 和 <code>type=c("scaledsch")</code> 获得。鞅和偏差残差对于每个个体都有一个单独的值，并且作为向量提供。然而，得分、Schoenfeld 和缩放的 Schoenfeld 残差是模型中每个个体和每个解释变量的值的矩阵。</p>
<p>对于多发性骨髓瘤数据，当 <code>residuals</code> 函数用于获得变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的得分残差时，得分残差矩阵具有与数据框相同顺序的 48 行，每行对应每个患者，列对应于 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的得分残差。这些列用数据框中的变量名（即 <code>hb</code> 和 <code>bun</code>）进行标记，但通常可以方便地更改这些名称，以避免与原始数据中的变量混淆。要获得得分残差并将列名更改为 <code>score.hb</code> 和 <code>score.bun</code>，请使用</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="chap17.html#cb36-1" tabindex="-1"></a><span class="sc">&gt;</span> scoreres<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"score"</span>)) </span>
<span id="cb36-2"><a href="chap17.html#cb36-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(scoreres)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"score.hb"</span>,<span class="st">"score.bun"</span>)</span></code></pre></div>
<p>将残差与原始数据一起置与数据框中也很有用，这样就可以很容易地对其进行操作。为此，使用 <code>cbind</code> 函数绑定包含残差的列。例如，若要将利用 <code>residuals</code> 函数计算的包含 Cox-Snell、鞅、偏差和得分残差的列绑定到名为 <code>myeloma</code> 的数据框，请使用</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="chap17.html#cb37-1" tabindex="-1"></a><span class="sc">&gt;</span> myeloma.res<span class="ot">&lt;-</span><span class="fu">cbind</span>(myeloma,csres,martres,devres,scoreres)</span></code></pre></div>
<p>可以使用 <code>print(myeloma.res)</code> 检查名为 <code>myloma.res</code> 的对象中变量的值，其中一些变量的前 10 个值如下所示。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="chap17.html#cb38-1" tabindex="-1"></a>   patient time status      csres     martres      devres      score.hb   score.bun</span>
<span id="cb38-2"><a href="chap17.html#cb38-2" tabindex="-1"></a><span class="dv">1</span>        <span class="dv">1</span>   <span class="dv">13</span>      <span class="dv">1</span> <span class="fl">0.23014540</span>  <span class="fl">0.76985460</span>  <span class="fl">1.18253068</span>  <span class="fl">3.2999546008</span>   <span class="fl">2.4140876</span></span>
<span id="cb38-3"><a href="chap17.html#cb38-3" tabindex="-1"></a><span class="dv">2</span>        <span class="dv">2</span>   <span class="dv">52</span>      <span class="dv">0</span> <span class="fl">0.90494858</span> <span class="sc">-</span><span class="fl">0.90494858</span> <span class="sc">-</span><span class="fl">1.34532419</span> <span class="sc">-</span><span class="fl">1.9303609057</span>  <span class="fl">13.8875587</span></span>
<span id="cb38-4"><a href="chap17.html#cb38-4" tabindex="-1"></a><span class="dv">3</span>        <span class="dv">3</span>    <span class="dv">6</span>      <span class="dv">1</span> <span class="fl">0.13748042</span>  <span class="fl">0.86251958</span>  <span class="fl">1.49783457</span>  <span class="fl">1.8290988299</span>  <span class="sc">-</span><span class="fl">7.3828723</span></span>
<span id="cb38-5"><a href="chap17.html#cb38-5" tabindex="-1"></a><span class="dv">4</span>        <span class="dv">4</span>   <span class="dv">40</span>      <span class="dv">1</span> <span class="fl">0.87666446</span>  <span class="fl">0.12333554</span>  <span class="fl">0.12880543</span>  <span class="fl">0.1792547576</span>   <span class="fl">1.9590824</span></span>
<span id="cb38-6"><a href="chap17.html#cb38-6" tabindex="-1"></a><span class="dv">5</span>        <span class="dv">5</span>   <span class="dv">10</span>      <span class="dv">1</span> <span class="fl">0.20639730</span>  <span class="fl">0.79360270</span>  <span class="fl">1.25247724</span>  <span class="fl">2.9277335613</span>  <span class="sc">-</span><span class="fl">2.6913044</span></span>
<span id="cb38-7"><a href="chap17.html#cb38-7" tabindex="-1"></a><span class="dv">6</span>        <span class="dv">6</span>    <span class="dv">7</span>      <span class="dv">0</span> <span class="fl">0.15889219</span> <span class="sc">-</span><span class="fl">0.15889219</span> <span class="sc">-</span><span class="fl">0.56372367</span> <span class="sc">-</span><span class="fl">0.0772011450</span>   <span class="fl">6.0619565</span></span>
<span id="cb38-8"><a href="chap17.html#cb38-8" tabindex="-1"></a><span class="dv">7</span>        <span class="dv">7</span>   <span class="dv">66</span>      <span class="dv">1</span> <span class="fl">1.34525433</span> <span class="sc">-</span><span class="fl">0.34525433</span> <span class="sc">-</span><span class="fl">0.31199757</span> <span class="sc">-</span><span class="fl">3.0274073993</span>   <span class="fl">7.0127113</span></span>
<span id="cb38-9"><a href="chap17.html#cb38-9" tabindex="-1"></a><span class="dv">8</span>        <span class="dv">8</span>   <span class="dv">10</span>      <span class="dv">0</span> <span class="fl">0.27393472</span> <span class="sc">-</span><span class="fl">0.27393472</span> <span class="sc">-</span><span class="fl">0.74018204</span> <span class="sc">-</span><span class="fl">1.2483218431</span>  <span class="sc">-</span><span class="fl">0.1676842</span></span>
<span id="cb38-10"><a href="chap17.html#cb38-10" tabindex="-1"></a><span class="dv">9</span>        <span class="dv">9</span>   <span class="dv">10</span>      <span class="dv">1</span> <span class="fl">0.60622895</span>  <span class="fl">0.39377105</span>  <span class="fl">0.46200976</span> <span class="sc">-</span><span class="fl">0.8189308283</span>  <span class="fl">12.1545183</span></span>
<span id="cb38-11"><a href="chap17.html#cb38-11" tabindex="-1"></a><span class="dv">10</span>      <span class="dv">10</span>   <span class="dv">14</span>      <span class="dv">1</span> <span class="fl">0.57177193</span>  <span class="fl">0.42822807</span>  <span class="fl">0.51144310</span> <span class="sc">-</span><span class="fl">0.0216079855</span>  <span class="fl">12.5389899</span></span></code></pre></div>
<p>对于一些诊断图，将生存时间的秩和风险评分与其他残差置于同一数据框中非常有用。通过将 <code>rank</code> 函数应用于生存时间，可以很容易地得出其秩，例如使用 <code>ranktime&lt;-rank(time)</code>。线性预测器 <span class="math inline">\(\hat{\boldsymbol{\beta}}^{\prime}\boldsymbol{x}_i\)</span> 可按照 <a href="chap17.html#sec17-4-3">17.4.3</a> 节描述的方式从 <code>coxph</code> 对象获得。所得评分以变量均值为中心，但除了横轴上的这种偏移外，残差与风险分数的关系图将与第 <a href="chap4.html#chap4">4</a> 章中所示的相同。然而，本书中使用的未中心化的风险评分可以使用如下命令获得</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="chap17.html#cb39-1" tabindex="-1"></a><span class="sc">&gt;</span> rscore<span class="ot">&lt;-</span>coxregfit<span class="sc">$</span>linear.predictors<span class="sc">+</span></span>
<span id="cb39-2"><a href="chap17.html#cb39-2" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">coef</span>(coxregfit)<span class="sc">*</span>coxregfit<span class="sc">$</span>means)</span></code></pre></div>
<p>然后可将其与数据框 <code>myeloma.res</code> 绑定</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="chap17.html#cb40-1" tabindex="-1"></a><span class="sc">&gt;</span> myeloma.res<span class="ot">&lt;-</span><span class="fu">cbind</span>(myeloma.res,rscore)</span></code></pre></div>
<p>然后可绘制残差图</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="chap17.html#cb41-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(devres <span class="sc">~</span> rscore,<span class="at">data=</span>myeloma.res)</span></code></pre></div>
<p>它给出了如图 4.6 所示的偏差残差与风险评分的关系图。<a href="chap4.html#sec4-2-1">4.2.1</a> 节中描述的 Cox-Snell 残差的累积风险图可以通过使用 <code>survfit</code> 函数并将残差指定为时间变量来获得。即</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="chap17.html#cb42-1" tabindex="-1"></a><span class="sc">&gt;</span>  cskm<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(csres,status) <span class="sc">~</span> <span class="dv">1</span>,<span class="at">data=</span>myeloma.res)</span></code></pre></div>
<details><summary><font color="#8B2232">图 4.6</font>
</summary><img src="figure/figure%204.6.png#center" style="width:80.0%"></details><p><br>
累计风险估计可从 <code>survfitc</code> 对象 <code>cskm</code> 中找到，即 <code>cskm$cum</code>，这给出了 <a href="chap2.html#sec2-3-3">2.3.3</a> 节中定义的累积风险函数的 Nelson-Aalen 估计。累积风险函数也可根据 <span class="math inline">\(-\log\hat{S}(r_{C{i}})\)</span> 估计，其中，<span class="math inline">\(\hat{S}(r_{C{i}})\)</span> 是 Cox-Snell 残差的生存函数的 Kaplan-Meier 估计，这是使用 <code>ch&lt;- -log(cskm$surv)</code> 计算的。然后，可绘制累积风险关于 Cox-Snell 残差（通过 <code>cskm$time</code> 获得）的图形，即 <code>plot(ch ~ cskm$time)</code>。所得图形与图 4.5 相似。</p>
<details><summary><font color="#8B2232">图 4.5</font>
</summary><img src="figure/figure%204.5.png#center" style="width:80.0%"></details><p><br>
Schoenfeld 残差矩阵对于数据集中的每个事件时间有一行，每个变量有一列。行按与事件时间相关的变量排序。这些很难与其他残差组合在一起，但 Schoenfeld 残差和缩放的 Schoenfeld 残差的矩阵的行以事件时间作为标签。例如，多发性骨髓瘤数据的 Schoenfeld 残差可使用如下代码获得</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="chap17.html#cb43-1" tabindex="-1"></a><span class="sc">&gt;</span> schoenres<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"schoenfeld"</span>))</span></code></pre></div>
<p>矩阵 <code>schoenres</code> 的前 10 行为</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="chap17.html#cb44-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(schoenres)</span>
<span id="cb44-2"><a href="chap17.html#cb44-2" tabindex="-1"></a>           hb       bun</span>
<span id="cb44-3"><a href="chap17.html#cb44-3" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span><span class="fl">0.04266125</span>  <span class="fl">78.30817</span></span>
<span id="cb44-4"><a href="chap17.html#cb44-4" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span><span class="fl">4.34266125</span> <span class="sc">-</span><span class="fl">66.69183</span></span>
<span id="cb44-5"><a href="chap17.html#cb44-5" tabindex="-1"></a><span class="dv">1</span>  <span class="fl">1.85733875</span> <span class="sc">-</span><span class="fl">30.69183</span></span>
<span id="cb44-6"><a href="chap17.html#cb44-6" tabindex="-1"></a><span class="dv">4</span>  <span class="fl">0.61182088</span> <span class="fl">100.34294</span></span>
<span id="cb44-7"><a href="chap17.html#cb44-7" tabindex="-1"></a><span class="dv">4</span> <span class="sc">-</span><span class="fl">2.98817912</span> <span class="sc">-</span><span class="fl">23.65706</span></span>
<span id="cb44-8"><a href="chap17.html#cb44-8" tabindex="-1"></a><span class="dv">5</span>  <span class="fl">0.25208340</span> <span class="sc">-</span><span class="fl">28.41657</span></span>
<span id="cb44-9"><a href="chap17.html#cb44-9" tabindex="-1"></a><span class="dv">5</span>  <span class="fl">0.95208340</span> <span class="sc">-</span><span class="fl">15.41657</span></span>
<span id="cb44-10"><a href="chap17.html#cb44-10" tabindex="-1"></a><span class="dv">5</span>  <span class="fl">0.75208340</span>  <span class="fl">88.58343</span></span>
<span id="cb44-11"><a href="chap17.html#cb44-11" tabindex="-1"></a><span class="dv">5</span> <span class="sc">-</span><span class="fl">0.44791660</span> <span class="sc">-</span><span class="fl">18.41657</span></span>
<span id="cb44-12"><a href="chap17.html#cb44-12" tabindex="-1"></a><span class="dv">6</span>  <span class="fl">2.10211724</span> <span class="sc">-</span><span class="fl">12.21550</span></span></code></pre></div>
<p>同样，列可以重新命名，将行标签中的列（即事件时间）转换为变量也很有用。然后将矩阵转换为数据框以进行进一步操作，这通过如下代码完成</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="chap17.html#cb45-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(schoenres)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"schoen.hb"</span>,<span class="st">"schoen.bun"</span>) </span>
<span id="cb45-2"><a href="chap17.html#cb45-2" tabindex="-1"></a><span class="sc">&gt;</span> schoenres<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="at">time=</span><span class="fu">rownames</span>(schoenres), </span>
<span id="cb45-3"><a href="chap17.html#cb45-3" tabindex="-1"></a>                   <span class="fu">data.frame</span>(schoenres,<span class="at">row.names=</span><span class="cn">NULL</span>)) </span>
<span id="cb45-4"><a href="chap17.html#cb45-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(schoenres)</span></code></pre></div>
<p>并得到包含变量 <code>time</code> 的数据框 <code>schoenres</code>。</p>
<p>获取并操作缩放的 Schoenfeld 残差矩阵也是类似地。这得到了一个数据框，可以轻松地用于生成缩放的 Schoenfeld 残差与事件时间的关系图，以检查比例风险的假设，如第 4 章 <a href="chap4.html#sec4-4-2">4.4.2</a> 节所述。</p>
</div>
<div id="sec17-5-2" class="section level3" number="17.5.2">
<h3>
<span class="header-section-number">17.5.2</span> 识别有影响的观测<a class="anchor" aria-label="anchor" href="#sec17-5-2"><i class="fas fa-link"></i></a>
</h3>
<p>delta-beta，即 <span class="math inline">\(\Delta_i\hat{\beta}_j\)</span> 是模型拟合过程中省略第 <span class="math inline">\(i\)</span> 个观测时第 <span class="math inline">\(j\)</span> 个参数估计的近似变化。该量也可以缩放以给出标准化的 delta-beta。这两个量均在第 4 章 <a href="chap4.html#sec4-3-1">4.3.1</a> 节进行了描述，用于探索特定观测如何影响参数估计及其显著性。这两个统计量都可从 <code>survival</code> 包中的 <code>residuals</code> 函数中获得。例如，对于为多发性骨髓瘤数据拟合的 Cox 回归模型中两个变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span>，其 delta-beta 和缩放的 delta-beta 可通过如下命令得到</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="chap17.html#cb46-1" tabindex="-1"></a><span class="sc">&gt;</span> db<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"dfbeta"</span>)) </span>
<span id="cb46-2"><a href="chap17.html#cb46-2" tabindex="-1"></a><span class="sc">&gt;</span> dbs<span class="ot">&lt;-</span><span class="fu">residuals</span>(coxregfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"dfbetas"</span>))</span></code></pre></div>
<p>这两个函数都会生成一个矩阵，其行对应于 48 名患者，列对应于两个解释变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span>。可以更改列名称，并将该矩阵与包含其他诊断的数据框 <code>myeloma.res</code> 合并，方法与 <a href="chap17.html#sec17-5-1">17.5.1</a> 节中的得分残差相同。</p>
<p>在第 4 章 <a href="chap4.html#sec4-3-2">4.3.2</a> 节介绍的两个统计量 <span class="math inline">\(LD_i\)</span> 和 <span class="math inline">\(|\boldsymbol{l}_{\max}|_i\)</span>，度量了个体观测对参数估计集的影响，可以很容易使用 R 的矩阵代数功能获得。具体而言，似然位移 <span class="math inline">\(LD_i\)</span> 是式 <a href="chap4.html#eq:4-16">(4.16)</a> 中矩阵 <span class="math inline">\(\boldsymbol B\)</span> 的第 <span class="math inline">\(i\)</span> 个对角元，<span class="math inline">\(|\boldsymbol l_\max|_i\)</span> 是与 <span class="math inline">\(\boldsymbol B\)</span> 的最大特征值相对应的特征向量。对于多发性骨髓瘤数据，这些诊断可从拟合模型中的得分残差、得分和参数估计的方差-协方差阵中获得，该矩阵是从 <code>coxph</code> 对象 <code>coxregfit</code> 的 <code>coxregfit$var</code> 获得的。下面的 R 代码实现了这一点。</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="chap17.html#cb47-1" tabindex="-1"></a><span class="sc">&gt;</span> B<span class="ot">&lt;-</span>scoreres<span class="sc">%*%</span>coxregfit<span class="sc">$</span>var<span class="sc">%*%</span><span class="fu">t</span>(scoreres) </span>
<span id="cb47-2"><a href="chap17.html#cb47-2" tabindex="-1"></a><span class="sc">&gt;</span> LD<span class="ot">&lt;-</span><span class="fu">diag</span>(B) </span>
<span id="cb47-3"><a href="chap17.html#cb47-3" tabindex="-1"></a><span class="sc">&gt;</span> e<span class="ot">&lt;-</span><span class="fu">eigen</span>(B) </span>
<span id="cb47-4"><a href="chap17.html#cb47-4" tabindex="-1"></a><span class="co"># 按递减顺序给出特征值</span></span>
<span id="cb47-5"><a href="chap17.html#cb47-5" tabindex="-1"></a><span class="sc">&gt;</span> lmax<span class="ot">&lt;-</span><span class="fu">abs</span>(e<span class="sc">$</span>vectors[,<span class="dv">1</span>])</span></code></pre></div>
<p>在此代码中，使用 <code>%*%</code> 运算符执行矩阵乘法，函数 <code>t</code> 用于获得矩阵的转置。矩阵运算 <code>diag</code> 给出 <span class="math inline">\(\boldsymbol B\)</span> 的对角元，函数 <code>eigen</code> 返回一个分量列表，包括按降序排列的特征值和相应的标准化特征向量。将该列表指定为 <code>e</code>，与最大特征值对应的特征向量是第一个特征向量，对应于特征向量形成的矩阵中的第一列，这可以使用 <code>e$vectors[,1]</code> 来访问。然后将这些值的绝对值指定为 <code>lmax</code>。可以使用 <code>cbind</code> 函数将变量 <code>LD</code> 和 <code>lmax</code> 添加到另一个数据框中，以进行进一步分析。</p>
</div>
<div id="sec17-5-3" class="section level3" number="17.5.3">
<h3>
<span class="header-section-number">17.5.3</span> 检验比例风险假设<a class="anchor" aria-label="anchor" href="#sec17-5-3"><i class="fas fa-link"></i></a>
</h3>
<p>第 4 章<a href="chap4.html#sec4-4-1">4.4.1</a> 节描述的数据的对数累积风险图可以根据生存函数的 Kaplan-Meier 估计得出。在第 4 章的<a href="chap4.html#exm:ex4-9">示例 4.9</a> 中，与血清血红蛋白水平相关的变量 <span class="math inline">\(Hb\)</span> 被重新定义为具有四个水平的因子，并检查了在这些水平上的比例风险假设。可通过如下命令在 <code>myeloma</code> 数据框中为因子 <code>hbfactor</code> 定义四个水平 1, 2, 3, 4</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="chap17.html#cb48-1" tabindex="-1"></a><span class="sc">&gt;</span> myeloma<span class="sc">$</span>hbfactor<span class="ot">&lt;-</span><span class="fu">as.factor</span>(<span class="fu">ifelse</span>(myeloma<span class="sc">$</span>hb<span class="sc">&lt;=</span><span class="dv">7</span>,<span class="st">"1"</span>,</span>
<span id="cb48-2"><a href="chap17.html#cb48-2" tabindex="-1"></a>                                     <span class="fu">ifelse</span>(myeloma<span class="sc">$</span>hb<span class="sc">&lt;=</span><span class="dv">10</span>,<span class="st">"2"</span>,</span>
<span id="cb48-3"><a href="chap17.html#cb48-3" tabindex="-1"></a>                                            <span class="fu">ifelse</span>(myeloma<span class="sc">$</span>hb<span class="sc">&lt;=</span><span class="dv">13</span>,<span class="st">"3"</span>,</span>
<span id="cb48-4"><a href="chap17.html#cb48-4" tabindex="-1"></a>                                                   <span class="fu">ifelse</span>(myeloma<span class="sc">$</span>hb<span class="sc">&gt;</span><span class="dv">13</span>,<span class="st">"4"</span>,<span class="dv">0</span>)))))</span></code></pre></div>
<p>并使用如下命令生成 <code>survfit</code> 对象 <code>km1</code></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="chap17.html#cb49-1" tabindex="-1"></a><span class="sc">&gt;</span> km1<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> hbfactor,<span class="at">data=</span>myeloma)</span></code></pre></div>
<p><code>survfit</code> 对象包括变量 <code>km1$time</code> 和生存函数 <code>km1$surv</code> 的 Kaplan-Meier 估计。要绘制对数累积风险，必须将 <span class="math inline">\(Hb\)</span> 的因子水平附加给 <code>km1</code> 对象。由于该对象与原始数据框的长度不同，因此无法直接将 <code>km1</code> 对象与 <code>hblevels</code> 中的因子水平合并。然而，<code>km1</code> 包含了与血红蛋白水平相关的变量 <code>km1$strata</code>，该变量可用于生成 <span class="math inline">\(Hb\)</span> 的因子水平，如下</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="chap17.html#cb50-1" tabindex="-1"></a><span class="sc">&gt;</span> hblevels<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>),km1<span class="sc">$</span>strata)</span></code></pre></div>
<p>该命令将值 1, 2, 3, 4 分配给 <code>hblevels</code>，并根据四个层中的观测数重复每个水平。对数累积风险图可使用对数累积风险的 Nelson-Aalen 估计或 Kaplan-Meier 估计来获得，通过如下的 <code>plot</code> 函数获得</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="chap17.html#cb51-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(<span class="fu">log</span>(km1<span class="sc">$</span>cum) <span class="sc">~</span> <span class="fu">log</span>(km1<span class="sc">$</span>time),<span class="at">pch=</span>hblevels)</span>
<span id="cb51-2"><a href="chap17.html#cb51-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(<span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(km1<span class="sc">$</span>surv)) <span class="sc">~</span> <span class="fu">log</span>(km1<span class="sc">$</span>time),<span class="at">pch=</span>hblevels)</span></code></pre></div>
<p><code>plot</code> 中的选项 <code>pch=</code> 为每个 <span class="math inline">\(Hb\)</span> 水平提供了不同的绘图符号。这两个图非常相似，但第二张图得到了图 4.13.</p>
<div class="rmdnote">
<details open><summary><font color="#8B2232">作者勘误</font>
</summary><p><br>
事实上第二张图与图 4.13 稍有不同。为复现图 4.13，生存函数估计和 <code>km1</code> 对象中的生存时间需要限制在事件时间内。一种方法是将生存函数估计值、生存时间、变量 <code>hblevels</code> 和每次事件的数量保存到数据框 <code>lchplotdata</code> 中。然后使用如下命令选择 <code>km1$n.event&gt;0</code> 的行的子集</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lchplotdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">km1</span><span class="op">$</span><span class="va">time</span>,<span class="va">km1</span><span class="op">$</span><span class="va">surv</span>,</span>
<span>                        <span class="va">km1</span><span class="op">$</span><span class="va">n.event</span>,<span class="va">hblevels</span><span class="op">)</span> </span>
<span><span class="va">lchplotdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">lchplotdata</span>, <span class="va">km1</span><span class="op">$</span><span class="va">n.event</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">km1.surv</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">km1.time</span><span class="op">)</span>,pch<span class="op">=</span><span class="va">hblevels</span>,</span>
<span>     data<span class="op">=</span><span class="va">lchplotdata</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<details><summary><font color="#8B2232">图 4.13</font>
</summary><img src="figure/figure%204.13.png#center" style="width:80.0%"></details><p><br>
第 4 章 <a href="chap4.html#sec4-4-2">4.4.2</a> 节描述的缩放的 Schoenfeld 残差与生存时间的关系图也可用于评估比例风险假设的有效性。该图可按照 <a href="chap17.html#sec17-5-1">17.5.1</a> 节末尾描述的方式从缩放的 Schoenfeld 残差矩阵中获得。</p>
<p>第 4 章 <a href="chap4.html#sec4-4-3">4.4.3</a> 节描述的检验统计量可使用 <code>coxph</code> 对象应用 <code>survival</code> 包中的函数 <code>cox.zph</code> 得到。例如，对于多发性骨髓瘤数据</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="chap17.html#cb53-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">cox.zph</span>(coxregfit)</span></code></pre></div>
<p>给出了拟合模型中变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的各个 Grambsch and Therneau 检验的卡方统计量及其 <span class="math inline">\(P\)</span> 值以及总体 zph 检验。</p>
</div>
</div>
<div id="sec17-6" class="section level2" number="17.6">
<h2>
<span class="header-section-number">17.6</span> 参数生存模型<a class="anchor" aria-label="anchor" href="#sec17-6"><i class="fas fa-link"></i></a>
</h2>
<p>生存数据的参数模型，如第 <a href="chap5.html#chap5">5</a> 章所述，可以使用 <code>survival</code> 包中的 <code>survreg</code> 函数进行拟合。该函数使用 <a href="%E5%8F%82%E6%95%B0%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#sec5-11">5.11</a> 节中描述的模型的对数线性表示来拟合加速失效时间模型，并且可用于对假定具有指数, Weibull, lognormal 或 loglogistic 等分布的生存时间进行建模。</p>
<p>在与第 <span class="math inline">\(i\)</span> 个（共 <span class="math inline">\(n\)</span> 个）生存时间相关的随机变量 <span class="math inline">\(T_i\)</span> 的加速失效时间模型中，</p>
<p><span class="math display" id="eq:17-1">\[\begin{align}
\log T_i=\mu+\alpha_1x_i+\alpha_2x_{2i}+\cdots+\alpha_px_{pi}+\sigma\epsilon_i
\tag{17.1}
\end{align}\]</span></p>
<p>其中 <span class="math inline">\(\mu\)</span> 和 <span class="math inline">\(\sigma\)</span> 分别是截距和尺度参数，<span class="math inline">\(\alpha\)</span> 是模型中 <span class="math inline">\(p\)</span> 个解释变量的系数，<span class="math inline">\(\epsilon_i\)</span> 是一个随机变量，其概率分布取决于 <span class="math inline">\(T_i\)</span> 的分布。解释变量对生存的效应可总结为时间比 <span class="math inline">\(\exp(\alpha)\)</span>，这是对应解释变量值每增加一个单位时，生存时间所乘的倍数。</p>
<p><code>survreg</code> 函数的语法与 <code>coxph</code> 的语法非常相似，默认情况下拟合 Weibull 模型。例如，以下代码可用于为第 1 章<a href="chap1.html#exm:ex1-3">示例 1.3</a> 中首次给出的确诊多发性骨髓瘤后的生存时间数据拟合 Weibull 模型。</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="chap17.html#cb54-1" tabindex="-1"></a><span class="sc">&gt;</span> weibfit<span class="ot">&lt;-</span><span class="fu">survreg</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> hb<span class="sc">+</span>bun,<span class="at">data=</span>myeloma)</span></code></pre></div>
<p>使用 <code>summary(weibfit)</code> 获得如下输出</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="chap17.html#cb55-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb55-2"><a href="chap17.html#cb55-2" tabindex="-1"></a><span class="fu">survreg</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hb <span class="sc">+</span> bun, <span class="at">data =</span> myeloma)</span>
<span id="cb55-3"><a href="chap17.html#cb55-3" tabindex="-1"></a>               Value Std. Error     z       p</span>
<span id="cb55-4"><a href="chap17.html#cb55-4" tabindex="-1"></a>(Intercept)  <span class="fl">2.70425</span>    <span class="fl">0.57769</span>  <span class="fl">4.68</span> <span class="fl">2.9e-06</span></span>
<span id="cb55-5"><a href="chap17.html#cb55-5" tabindex="-1"></a>hb           <span class="fl">0.11456</span>    <span class="fl">0.05375</span>  <span class="fl">2.13</span> <span class="fl">0.03306</span></span>
<span id="cb55-6"><a href="chap17.html#cb55-6" tabindex="-1"></a>bun         <span class="sc">-</span><span class="fl">0.01580</span>    <span class="fl">0.00423</span> <span class="sc">-</span><span class="fl">3.74</span> <span class="fl">0.00019</span></span>
<span id="cb55-7"><a href="chap17.html#cb55-7" tabindex="-1"></a><span class="fu">Log</span>(scale)  <span class="sc">-</span><span class="fl">0.10644</span>    <span class="fl">0.12746</span> <span class="sc">-</span><span class="fl">0.84</span> <span class="fl">0.40365</span></span>
<span id="cb55-8"><a href="chap17.html#cb55-8" tabindex="-1"></a></span>
<span id="cb55-9"><a href="chap17.html#cb55-9" tabindex="-1"></a>Scale<span class="ot">=</span> <span class="fl">0.899</span> </span>
<span id="cb55-10"><a href="chap17.html#cb55-10" tabindex="-1"></a></span>
<span id="cb55-11"><a href="chap17.html#cb55-11" tabindex="-1"></a>Weibull distribution</span>
<span id="cb55-12"><a href="chap17.html#cb55-12" tabindex="-1"></a><span class="fu">Loglik</span>(model)<span class="ot">=</span> <span class="sc">-</span><span class="fl">153.5</span>   <span class="fu">Loglik</span>(intercept only)<span class="ot">=</span> <span class="sc">-</span><span class="fl">159.8</span></span>
<span id="cb55-13"><a href="chap17.html#cb55-13" tabindex="-1"></a>    Chisq<span class="ot">=</span> <span class="fl">12.57</span> on <span class="dv">2</span> degrees of freedom, p<span class="ot">=</span> <span class="fl">0.0019</span> </span>
<span id="cb55-14"><a href="chap17.html#cb55-14" tabindex="-1"></a>Number of Newton<span class="sc">-</span>Raphson Iterations<span class="sc">:</span> <span class="dv">5</span> </span>
<span id="cb55-15"><a href="chap17.html#cb55-15" tabindex="-1"></a>n<span class="ot">=</span> <span class="dv">48</span></span></code></pre></div>
<p>根据该输出，式 <a href="chap17.html#eq:17-1">(17.1)</a> 的加速失效时间模型中的参数估计为 <span class="math inline">\(\hat\mu = 2.704，\hat\sigma = 0.899\)</span>，变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的系数估计分别为 0.1146 和 -0.0158. 输出中的 <code>Log(scale)</code> 参数就是 <span class="math inline">\(\log \hat\sigma\)</span>。这部分输出给出了每个参数估计的标准误、Wald 统计量（计算为 <span class="math inline">\(z=\hat{\alpha}/\mathrm{se}\left(\hat{\alpha}\right)\)</span> ）以及相应的 <span class="math inline">\(P\)</span> 值。<span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 均显著影响生存。<span class="math inline">\(Hb\)</span> 值每增加一个单位，生存时间就会增加为原来的 <span class="math inline">\(\exp(0.1146) = 1.121\)</span> 倍，即增加 12%，而 <span class="math inline">\(Bun\)</span> 值每增加一个单位，生存时间就会减少 1.4%.</p>
<p>模型的对数似然 <code>Loglik(model)</code> 使用第 5 章的式 <a href="chap5.html#eq:5-46">(5.46)</a> 计算，并且 <span class="math inline">\(-2\log\hat{L}\)</span> 统计量的值根据 <code>-2*weibfit$loglik</code> 计算，结果为 306.996. 该统计量用于比较替代模型。仅具有截距的模型的对数似然，标记为 <code>Loglik(intercept only),</code>，是零模型的对数似然，输出中的卡方统计量将拟合模型与该零模型进行比较，这种比较通常为意义不大。输出还给出了拟合模型所需的迭代次数以及数据框中的观测值数 <code>n</code>。</p>
<p>Weibull 加速失效时间模型也可表示为比例风险模型，其中第 <span class="math inline">\(i\)</span> 个个体在时间 <span class="math inline">\(t\)</span> 的死亡风险为</p>
<p><span class="math display">\[\begin{aligned}h_{\boldsymbol{i}}(t)=\exp(\boldsymbol{\beta'x}_{\boldsymbol{i}})h_{0}(t)\end{aligned}\]</span></p>
<p>假定所有解释变量为零的个体的生存时间具有尺度参数为 <span class="math inline">\(\lambda\)</span> 和形状参数为 <span class="math inline">\(\gamma\)</span> 的 Weibull 分布，基线风险函数由 <span class="math inline">\(h_0(t)=\lambda\gamma t^{\gamma-1}\)</span> 给出。加速失效时间的参数与 Weibull 模型的比例风险版本之间的对应关系如第 5 章的式 <a href="chap5.html#eq:5-53">(5.53)</a> 所示。具体来说，模型比例风险版本中的对数风险比为<span class="math inline">\(\beta=-\alpha/\sigma\)</span>。<span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 值单位变化的对数风险比估计分别为 <span class="math inline">\(−0.1146/0.899=−0.1275\)</span> 和 <span class="math inline">\(0.0158/0.899=0.0176\)</span>，从而风险比分别为 0.88 和 1.02.</p>
<p>可以使用 <code>survreg</code> 和选项 <code>dist=</code> 来拟合具有其他生存时间分布的加速失效时间模型，该选项具有 <code>"exponential"</code>, <code>"loglogistic"</code> 或 <code>"lognormal"</code> 等值。在每种情况下，均会给出式 <a href="chap17.html#eq:17-1">(17.1)</a> 中对数线性模型中的截距、尺度和 <span class="math inline">\(\alpha\)</span> 参数。这些模型和其他模型参数之间的对应关系在第 <a href="chap5.html#chap5">5</a> 章中进行了描述。在每种情况下，输出都与 Weibull 模型获得的输出非常相似，并且使用 <span class="math inline">\(-2\log\hat{L}\)</span> 统计量来比较替代模型。例如，使用以下代码为多发性骨髓瘤数据拟合 loglogistic 加速失效时间模型</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="chap17.html#cb56-1" tabindex="-1"></a><span class="sc">&gt;</span> llfit<span class="ot">&lt;-</span><span class="fu">survreg</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> hb<span class="sc">+</span>bun,<span class="at">dist=</span><span class="st">"loglogistic"</span>, </span>
<span id="cb56-2"><a href="chap17.html#cb56-2" tabindex="-1"></a>                 <span class="at">data=</span>myeloma)</span></code></pre></div>
<p><code>summary(llfit)</code> 得到</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="chap17.html#cb57-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb57-2"><a href="chap17.html#cb57-2" tabindex="-1"></a><span class="fu">survreg</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hb <span class="sc">+</span> bun, <span class="at">data =</span> myeloma, </span>
<span id="cb57-3"><a href="chap17.html#cb57-3" tabindex="-1"></a>    <span class="at">dist =</span> <span class="st">"loglogistic"</span>)</span>
<span id="cb57-4"><a href="chap17.html#cb57-4" tabindex="-1"></a>               Value Std. Error     z       p</span>
<span id="cb57-5"><a href="chap17.html#cb57-5" tabindex="-1"></a>(Intercept)  <span class="fl">2.05628</span>    <span class="fl">0.68561</span>  <span class="fl">3.00</span> <span class="fl">0.00271</span></span>
<span id="cb57-6"><a href="chap17.html#cb57-6" tabindex="-1"></a>hb           <span class="fl">0.12619</span>    <span class="fl">0.06328</span>  <span class="fl">1.99</span> <span class="fl">0.04612</span></span>
<span id="cb57-7"><a href="chap17.html#cb57-7" tabindex="-1"></a>bun         <span class="sc">-</span><span class="fl">0.01392</span>    <span class="fl">0.00429</span> <span class="sc">-</span><span class="fl">3.25</span> <span class="fl">0.00116</span></span>
<span id="cb57-8"><a href="chap17.html#cb57-8" tabindex="-1"></a><span class="fu">Log</span>(scale)  <span class="sc">-</span><span class="fl">0.45293</span>    <span class="fl">0.13562</span> <span class="sc">-</span><span class="fl">3.34</span> <span class="fl">0.00084</span></span>
<span id="cb57-9"><a href="chap17.html#cb57-9" tabindex="-1"></a></span>
<span id="cb57-10"><a href="chap17.html#cb57-10" tabindex="-1"></a>Scale<span class="ot">=</span> <span class="fl">0.636</span> </span>
<span id="cb57-11"><a href="chap17.html#cb57-11" tabindex="-1"></a></span>
<span id="cb57-12"><a href="chap17.html#cb57-12" tabindex="-1"></a>Log logistic distribution</span>
<span id="cb57-13"><a href="chap17.html#cb57-13" tabindex="-1"></a><span class="fu">Loglik</span>(model)<span class="ot">=</span> <span class="sc">-</span><span class="fl">153.6</span>   <span class="fu">Loglik</span>(intercept only)<span class="ot">=</span> <span class="sc">-</span><span class="fl">159.9</span></span>
<span id="cb57-14"><a href="chap17.html#cb57-14" tabindex="-1"></a>    Chisq<span class="ot">=</span> <span class="fl">12.62</span> on <span class="dv">2</span> degrees of freedom, p<span class="ot">=</span> <span class="fl">0.0018</span> </span>
<span id="cb57-15"><a href="chap17.html#cb57-15" tabindex="-1"></a>Number of Newton<span class="sc">-</span>Raphson Iterations<span class="sc">:</span> <span class="dv">4</span> </span>
<span id="cb57-16"><a href="chap17.html#cb57-16" tabindex="-1"></a>n<span class="ot">=</span> <span class="dv">48</span> </span></code></pre></div>
<p>Weibull 模型和 loglogistic 模型的时间比和对数似然值非常相似。</p>
</div>
<div id="sec17-7" class="section level2" number="17.7">
<h2>
<span class="header-section-number">17.7</span> 灵活的参数模型<a class="anchor" aria-label="anchor" href="#sec17-7"><i class="fas fa-link"></i></a>
</h2>
<p>第 <a href="chap6.html#chap6">6</a> 章中介绍的分段指数模型和基于样条函数的灵活参数模型可以很容易地使用 R 进行拟合。</p>
<div id="sec17-7-1" class="section level3" number="17.7.1">
<h3>
<span class="header-section-number">17.7.1</span> 分段指数模型<a class="anchor" aria-label="anchor" href="#sec17-7-1"><i class="fas fa-link"></i></a>
</h3>
<p>第 6 章 <a href="chap6.html#sec6-1">6.1</a> 节描述的分段指数模型可使用 <code>eha</code> 包中的 <code>phreg</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;在较新版本的 &lt;code&gt;eha&lt;/code&gt; 中使用 &lt;code&gt;phreg&lt;/code&gt; 会提示：&lt;code&gt;Warning: Use the function pchreg instead. This will soon be deprecated.&lt;/code&gt;，因此可改用 &lt;code&gt;pchreg&lt;/code&gt;。&lt;/p&gt;"><sup>34</sup></a> 函数进行拟合。第 3 章<a href="chap3.html#exm:ex3-4">示例 3.4</a> 中关于 36 名肾癌患者生存时间的数据将用于说明该函数，第 6 章<a href="chap6.html#exm:ex6-1">示例 6.1</a> 中拟合了分段指数模型。首先输入关于生存时间、生存状态以及变量<span class="math inline">\(Age\)</span> 和 <span class="math inline">\(Nephrectomy\)</span> 的数据，并使用以下代码将变量 <span class="math inline">\(Age\)</span> 定义为水平 &lt;60, 60-70 和 &gt;70 的因子。</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="chap17.html#cb58-1" tabindex="-1"></a><span class="sc">&gt;</span> kidney<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Treatment of hypernephroma.dat"</span>,<span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb58-2"><a href="chap17.html#cb58-2" tabindex="-1"></a><span class="sc">&gt;</span> kidney<span class="sc">$</span>agef<span class="ot">&lt;-</span><span class="fu">factor</span>(kidney<span class="sc">$</span>age) </span>
<span id="cb58-3"><a href="chap17.html#cb58-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">levels</span>(kidney<span class="sc">$</span>agef)<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"&lt;60"</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">"60-70"</span><span class="ot">=</span><span class="dv">2</span>,<span class="st">"&gt;70"</span><span class="ot">=</span><span class="dv">3</span>)</span></code></pre></div>
<p>为拟合基线风险函数具有 22 个区间的模型，使其等价于 Cox 回归模型，使用</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="chap17.html#cb59-1" tabindex="-1"></a><span class="sc">&gt;</span> pefit <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> agef<span class="sc">+</span>nephrectomy, <span class="at">dist=</span><span class="st">"pch"</span>,</span>
<span id="cb59-2"><a href="chap17.html#cb59-2" tabindex="-1"></a>                 <span class="at">cuts=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">12</span>,<span class="dv">14</span>,<span class="dv">15</span>,<span class="dv">17</span>,<span class="dv">18</span>,<span class="dv">21</span>,<span class="dv">26</span>,<span class="dv">35</span>,<span class="dv">36</span>,<span class="dv">38</span>,<span class="dv">48</span>,<span class="dv">52</span>,<span class="dv">56</span>, <span class="dv">68</span>,<span class="dv">72</span>,<span class="dv">84</span>,<span class="dv">108</span>,<span class="dv">115</span>),<span class="at">data=</span>kidney)</span></code></pre></div>
<p>函数 <code>phreg</code> 可用于拟合许多分布，默认为 Weibull. 使用选项 <code>dist="pch"</code> 拟合分段指数模型，选项 <code>cuts=</code> 指定基线风险函数的分割点。使用 <code>print(pefit)</code> 会生成以下输出</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="chap17.html#cb60-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb60-2"><a href="chap17.html#cb60-2" tabindex="-1"></a><span class="fu">phreg</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> agef <span class="sc">+</span> nephrectomy, <span class="at">data =</span> kidney, </span>
<span id="cb60-3"><a href="chap17.html#cb60-3" tabindex="-1"></a>    <span class="at">dist =</span> <span class="st">"pch"</span>, <span class="at">cuts =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">17</span>, <span class="dv">18</span>, </span>
<span id="cb60-4"><a href="chap17.html#cb60-4" tabindex="-1"></a>        <span class="dv">21</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">36</span>, <span class="dv">38</span>, <span class="dv">48</span>, <span class="dv">52</span>, <span class="dv">56</span>, <span class="dv">68</span>, <span class="dv">72</span>, <span class="dv">84</span>, <span class="dv">108</span>, <span class="dv">115</span>))</span>
<span id="cb60-5"><a href="chap17.html#cb60-5" tabindex="-1"></a></span>
<span id="cb60-6"><a href="chap17.html#cb60-6" tabindex="-1"></a>Covariate          W.mean      Coef <span class="fu">Exp</span>(Coef)  <span class="fu">se</span>(Coef)    Wald p</span>
<span id="cb60-7"><a href="chap17.html#cb60-7" tabindex="-1"></a>agef </span>
<span id="cb60-8"><a href="chap17.html#cb60-8" tabindex="-1"></a>             <span class="sc">&lt;</span><span class="dv">60</span>    <span class="fl">0.643</span>     <span class="dv">0</span>         <span class="dv">1</span>           (reference)</span>
<span id="cb60-9"><a href="chap17.html#cb60-9" tabindex="-1"></a>           <span class="dv">60-70</span>    <span class="fl">0.316</span>     <span class="fl">0.117</span>     <span class="fl">1.124</span>     <span class="fl">0.427</span>     <span class="fl">0.784</span> </span>
<span id="cb60-10"><a href="chap17.html#cb60-10" tabindex="-1"></a>             <span class="sc">&gt;</span><span class="dv">70</span>    <span class="fl">0.041</span>     <span class="fl">1.508</span>     <span class="fl">4.518</span>     <span class="fl">0.608</span>     <span class="fl">0.013</span> </span>
<span id="cb60-11"><a href="chap17.html#cb60-11" tabindex="-1"></a>nephrectomy         <span class="fl">0.934</span>    <span class="sc">-</span><span class="fl">1.536</span>     <span class="fl">0.215</span>     <span class="fl">0.530</span>     <span class="fl">0.004</span> </span>
<span id="cb60-12"><a href="chap17.html#cb60-12" tabindex="-1"></a></span>
<span id="cb60-13"><a href="chap17.html#cb60-13" tabindex="-1"></a></span>
<span id="cb60-14"><a href="chap17.html#cb60-14" tabindex="-1"></a>Events                    <span class="dv">32</span> </span>
<span id="cb60-15"><a href="chap17.html#cb60-15" tabindex="-1"></a>Total time at risk          <span class="dv">1340</span> </span>
<span id="cb60-16"><a href="chap17.html#cb60-16" tabindex="-1"></a>Max. log. likelihood      <span class="sc">-</span><span class="fl">124.35</span> </span>
<span id="cb60-17"><a href="chap17.html#cb60-17" tabindex="-1"></a>LR test statistic         <span class="fl">13.95</span> </span>
<span id="cb60-18"><a href="chap17.html#cb60-18" tabindex="-1"></a>Degrees of freedom        <span class="dv">3</span> </span>
<span id="cb60-19"><a href="chap17.html#cb60-19" tabindex="-1"></a>Overall p<span class="sc">-</span>value           <span class="fl">0.00296981</span></span></code></pre></div>
<p>输出中标题为 <code>W.mean</code> 的列中的条目是变量的加权平均值或因子水平的相对频率。权重是每个因子水平或变量值的患者所占的总观测生存时间的比例。在这个数据集中，36 名患者的总生存时间是 1340 个月，这在输出中标记为 <code>Total time at risk</code>。对于因子 <span class="math inline">\(Age\)</span> 的第 1 水平，有 19 名患者，该组的生存时间总和为 862. 第一年龄组患者所经历的总体生存时间的比例则为 <span class="math inline">\(862/1340 = 0.643\)</span>，如输出所示。类似地，对于变量 <span class="math inline">\(Nephrectomy\)</span>，<span class="math inline">\(Nephrectomy=0\)</span> 的患者的总生存时间是 88 个月，而 <span class="math inline">\(Nephrectomy=1\)</span> 的患者的总生存时间是 1252 个月。该变量的加权平均值则为 <span class="math inline">\((88 × 0 + 1252 × 1)/1340 = 0.934\)</span>，如输出所示。</p>
<p>下一个输出块给出模型中每一项的系数和风险比，以及它们的标准误和从统计量 <span class="math inline">\(z=\hat{\beta}/\text{se}(\hat{\beta})\)</span> 导出的 Wald <span class="math inline">\(P\)</span> 值。因子的风险比是相对于第一水平的，并且与<a href="chap6.html#exm:ex6-1">示例 6.1</a> 中使用的一致。统计量 <code>Max. log. likelihood</code> 是拟合模型的最大对数似然，使用 <code>-2*pefit$loglik</code> 将其乘以 -2 即可获得 <span class="math inline">\(-2\log\hat{L}\)</span> 统计量。<code>LR test statistic</code> 和相应的 <code>Overall p-value</code> 是拟合模型和零模型之间的比较。</p>
<p><code>phreg</code> 对象 <code>pefit</code> 包含许多其他变量，包括使用 <code>pefit$hazards</code> 得出的 22 个区间中的基线风险函数值。</p>
</div>
<div id="sec17-7-2" class="section level3" number="17.7.2">
<h3>
<span class="header-section-number">17.7.2</span> 风险函数的模型<a class="anchor" aria-label="anchor" href="#sec17-7-2"><i class="fas fa-link"></i></a>
</h3>
<p>基线风险函数对数的 B 样条模型在贝叶斯生存分析中得到了更广泛的应用，稍后将在 <a href="chap17.html#sec17-15">17.15</a> 节中进行说明。</p>
</div>
<div id="sec17-7-3" class="section level3" number="17.7.3">
<h3>
<span class="header-section-number">17.7.3</span> 对数累积风险函数的模型<a class="anchor" aria-label="anchor" href="#sec17-7-3"><i class="fas fa-link"></i></a>
</h3>
<p>如第 6 章 <a href="chap6.html#sec6-4">6.4</a> 节所述，使用限制性立方样条对对数风险风险进行建模的 Royston and Parmar 模型可以使用软件包 <code>flexsurv</code> 中的函数 <code>flexsurfsurf</code> 进行拟合。一旦安装并加载了该包，就可以轻松拟合具有不同结数的模型。再次考虑第 1 章<a href="chap1.html#exm:ex1-3">示例 1.3</a> 中介绍的多发性骨髓瘤确诊后的生存数据，以及 <a href="chap17.html#sec17-4">17.4</a> - <a href="chap17.html#sec17-6">17.6</a> 节使用的数据。如第 6 章 <a href="chap6.html#sec6-4">6.4</a> 节所述，没有内部结的 Royston and Parmar 模型对应于 Weibull 模型。选项 <code>k=</code> 用于指定结数，因此包含变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的 Weibull 模型也可以使用如下命令拟合</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="chap17.html#cb61-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">flexsurvspline</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> hb<span class="sc">+</span>bun,<span class="at">k=</span><span class="dv">0</span>,<span class="at">data=</span>myeloma)</span></code></pre></div>
<p>这会生成如下输出</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="chap17.html#cb62-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb62-2"><a href="chap17.html#cb62-2" tabindex="-1"></a><span class="fu">flexsurvspline</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> hb <span class="sc">+</span> bun, <span class="at">data =</span> myeloma, </span>
<span id="cb62-3"><a href="chap17.html#cb62-3" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">0</span>)</span>
<span id="cb62-4"><a href="chap17.html#cb62-4" tabindex="-1"></a></span>
<span id="cb62-5"><a href="chap17.html#cb62-5" tabindex="-1"></a>Estimates<span class="sc">:</span> </span>
<span id="cb62-6"><a href="chap17.html#cb62-6" tabindex="-1"></a>        data mean  est       L95<span class="sc">%      U95%</span>      se        <span class="fu">exp</span>(est)  L95<span class="sc">%      U95%</span>    </span>
<span id="cb62-7"><a href="chap17.html#cb62-7" tabindex="-1"></a>gamma0        <span class="cn">NA</span>   <span class="sc">-</span><span class="fl">3.00773</span>  <span class="sc">-</span><span class="fl">4.57689</span>  <span class="sc">-</span><span class="fl">1.43858</span>   <span class="fl">0.80060</span>        <span class="cn">NA</span>        <span class="cn">NA</span>        <span class="cn">NA</span></span>
<span id="cb62-8"><a href="chap17.html#cb62-8" tabindex="-1"></a>gamma1        <span class="cn">NA</span>    <span class="fl">1.11229</span>   <span class="fl">0.83442</span>   <span class="fl">1.39015</span>   <span class="fl">0.14177</span>        <span class="cn">NA</span>        <span class="cn">NA</span>        <span class="cn">NA</span></span>
<span id="cb62-9"><a href="chap17.html#cb62-9" tabindex="-1"></a>hb      <span class="fl">10.25208</span>   <span class="sc">-</span><span class="fl">0.12744</span>  <span class="sc">-</span><span class="fl">0.24453</span>  <span class="sc">-</span><span class="fl">0.01036</span>   <span class="fl">0.05974</span>   <span class="fl">0.88034</span>   <span class="fl">0.78307</span>   <span class="fl">0.98970</span></span>
<span id="cb62-10"><a href="chap17.html#cb62-10" tabindex="-1"></a>bun     <span class="fl">33.91667</span>    <span class="fl">0.01758</span>   <span class="fl">0.00730</span>   <span class="fl">0.02786</span>   <span class="fl">0.00525</span>   <span class="fl">1.01773</span>   <span class="fl">1.00733</span>   <span class="fl">1.02825</span></span>
<span id="cb62-11"><a href="chap17.html#cb62-11" tabindex="-1"></a></span>
<span id="cb62-12"><a href="chap17.html#cb62-12" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">48</span>,  Events<span class="sc">:</span> <span class="dv">36</span>,  Censored<span class="sc">:</span> <span class="dv">12</span></span>
<span id="cb62-13"><a href="chap17.html#cb62-13" tabindex="-1"></a>Total time at risk<span class="sc">:</span> <span class="dv">1122</span></span>
<span id="cb62-14"><a href="chap17.html#cb62-14" tabindex="-1"></a>Log<span class="sc">-</span>likelihood <span class="ot">=</span> <span class="sc">-</span><span class="fl">153.4981</span>, df <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb62-15"><a href="chap17.html#cb62-15" tabindex="-1"></a>AIC <span class="ot">=</span> <span class="fl">314.9963</span></span></code></pre></div>
<p>输出的第一部分给出变量 <span class="math inline">\(Hb\)</span> 和 <span class="math inline">\(Bun\)</span> 的样本均值，后面是模型的参数估计。在第 6 章 <a href="chap6.html#sec6-4">6.4</a> 节的表示法中，<span class="math inline">\(\hat{\gamma}_0=-3.0077,\hat{\gamma}_1=1.1123\)</span>，模型线性部分中两个变量的 <span class="math inline">\(\beta\)</span> 系数估计分别为 -0.1274 和 0.0176. 由于这里使用 Weibull 模型的比例风险版本，这些系数估计是对数风险比，它们的值与 <a href="chap17.html#sec17-4">17.4</a> 节中拟合的 Cox 回归模型得到的值非常相似。<span class="math inline">\(\gamma\)</span> 与 Weibull 基线风险中的参数 <span class="math inline">\(h_0(t)=\lambda\gamma t^{\boldsymbol{\gamma}-1}\)</span> 相关，并且根据第 6 章 <a href="chap6.html#sec6-4">6.4</a> 节，<span class="math inline">\(\gamma_0=\log\lambda\)</span> 且 <span class="math inline">\(\gamma_1 = \gamma\)</span>。输出展示了系数的标准误及其 95% 置信限。标题为 <code>exp(est)</code> 的列给出了系数的指数，即风险比及其 95% 置信限。在输出观测数、事件数和删失数的总结后，将生存时间的总和展示为 <code>Total time at risk</code>。然后是拟合模型的最大对数似然和自由度数，即未知模型参数的数量，以及模型比较中使用的 AIC 统计量。</p>
<p>使用一系列具有不同选项 <code>k=</code> 值的 <code>flexsurvspline</code> 函数可以轻松拟合结数不断增加的模型，并使用 AIC 进行比较。第 6 章 <a href="chap6.html#sec6-5">6.5</a> 节中描述的具有限制性立方样条函数的比例几率模型也可以使用带有选项 <code>scale="odds"</code> 的 <code>flexsurvspline</code> 函数进行拟合。输出非常相似，但拟合模型的系数估计现在是对数几率比。</p>
</div>
</div>
<div id="sec17-8" class="section level2" number="17.8">
<h2>
<span class="header-section-number">17.8</span> 参数模型中的模型检查<a class="anchor" aria-label="anchor" href="#sec17-8"><i class="fas fa-link"></i></a>
</h2>
<p>第 7 章 <a href="chap7.html#sec7-1">7.1</a> 节描述的参数模型的残差很容易获得。<code>survreg</code> 对象包含了加速失效时间模型的线性部分估计，由下式给出</p>
<p><span class="math display">\[\begin{aligned}\hat{\eta}_i=\hat{\mu}+\hat{\alpha}_1x_i+\hat{\alpha}_2x_{2i}+\cdots+\hat{\alpha}_px_{pi}\end{aligned}\]</span></p>
<p>从中可以得到标准化残差。为多发性骨髓瘤数据拟合后 Weibull 加速失效时间模型后，<code>survreg</code> 对象 <code>weibfit</code> 在 <code>weibfit$linear.prpredictors</code> 中包含了线性预测器 <span class="math inline">\(\hat{\eta}_i\)</span>，以及在 <code>weibfit$scale</code> 中包含了尺度参数 <span class="math inline">\(\hat\sigma\)</span>。然后使用如下命令得到标准化残差 <span class="math inline">\(r_{Si}\)</span></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="chap17.html#cb63-1" tabindex="-1"></a><span class="sc">&gt;</span> stres<span class="ot">&lt;-</span>(<span class="fu">log</span>(myeloma<span class="sc">$</span>time)<span class="sc">-</span>weibfit<span class="sc">$</span>linear.predictors)<span class="sc">/</span>weibfit<span class="sc">$</span>scale</span></code></pre></div>
<p>Cox-Snell 残差是使用第 7 章的式 <a href="chap7.html#eq:7-3">(7.3)</a> 和 <a href="chap7.html#eq:7-2">(7.2)</a> 获得的，其中对于 Weibull 分布的特定情况，<span class="math inline">\(S_{\epsilon_i}(\epsilon)=\exp(-e^{\epsilon})\)</span>，如式 <a href="chap7.html#eq:7-7">(7.7)</a> 所示，因此 <span class="math inline">\(r_{Ci} = \exp(r_{Si})\)</span>。这些残差可简单地使用 <code>csres&lt;-exp(stres)</code> 计算。然后使用如下命令计算鞅和偏差残差</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="chap17.html#cb64-1" tabindex="-1"></a><span class="sc">&gt;</span> martres<span class="ot">&lt;-</span>myeloma<span class="sc">$</span>status<span class="sc">-</span>csres </span>
<span id="cb64-2"><a href="chap17.html#cb64-2" tabindex="-1"></a><span class="sc">&gt;</span> devres<span class="ot">=</span><span class="fu">sign</span>(martres)<span class="sc">*</span><span class="fu">sqrt</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(martres<span class="sc">+</span></span>
<span id="cb64-3"><a href="chap17.html#cb64-3" tabindex="-1"></a>                                  myeloma<span class="sc">$</span>status<span class="sc">*</span>(<span class="fu">log</span>(myeloma<span class="sc">$</span>status<span class="sc">-</span>martres))))</span></code></pre></div>
<p>偏差残差也可以直接使用</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="chap17.html#cb65-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">residuals</span>(weibfit,<span class="at">type=</span><span class="fu">c</span>(<span class="st">"deviance"</span>))</span></code></pre></div>
<p>来获得。然而，如此得到的偏差残差将与根据鞅残差计算出的偏差残差的符号相反。第 7 章 <a href="chap7.html#sec7-1-4">7.1.4</a> 节解释了这种符号差异的原因。</p>
<p>与从拟合的 Cox 回归模型中获得的残差一样，残差列可以与数据框绑定，以便按照 @ref*sec17-5-1) 节所述的方式在绘图和进一步分析中使用。</p>
<div id="sec17-8-1" class="section level3" number="17.8.1">
<h3>
<span class="header-section-number">17.8.1</span> 有影响的值<a class="anchor" aria-label="anchor" href="#sec17-8-1"><i class="fas fa-link"></i></a>
</h3>
<p>可以使用第 7 章 <a href="chap7.html#sec7-4">7.4</a> 节描述的 delta-beta 统计量来研究拟合参数生存模型中观测对参数估计 <span class="math inline">\(\hat\alpha\)</span> 的影响。可以对 <code>survreg</code> 对象应用 <code>residuals</code> ，带上选项 <code>type=c("dfbeta")</code> 或 <code>type=c("dfbetas")</code> 以提取未缩放和缩放的 delta-beta. 第 7 章 <a href="chap7.html#sec7-4-2">7.4.2</a> 节描述的似然位移统计量可使用选项 <code>type=c("ldcase")</code> 得到。</p>
</div>
<div id="sec17-8-2" class="section level3" number="17.8.2">
<h3>
<span class="header-section-number">17.8.2</span> 比较观测的和拟合的生存函数<a class="anchor" aria-label="anchor" href="#sec17-8-2"><i class="fas fa-link"></i></a>
</h3>
<p>将基于模型的生存函数估计与观测的 Kaplan-Meier 估计进行比较，提供了一种评估模型拟合的非正式方法，如第 7 章 <a href="chap7.html#sec7-3">7.3</a> 节所述。需要进行一些操作，以获得具有不同风险评分水平的个体的生存函数，使用 26 名女性接受两种卵巢癌化疗后的生存时间数据来说明该过程，如第 5 章<a href="chap5.html#exm:ex5-11">示例 5.11</a> 所示。</p>
<p>数据首先被输入并且被指定为数据框 <code>ovarian</code>。然后为数据拟合包含变量 <span class="math inline">\(Age\)</span> 和 <span class="math inline">\(Treat\)</span> 的 Weibull 模型并保存为 <code>survreg</code> 对象 <code>ofit</code>。这是通过如下命令实现的。</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="chap17.html#cb66-1" tabindex="-1"></a><span class="sc">&gt;</span> ovarian<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Chemotherapy in ovarian cancer patients.dat"</span>,</span>
<span id="cb66-2"><a href="chap17.html#cb66-2" tabindex="-1"></a>                      <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-3"><a href="chap17.html#cb66-3" tabindex="-1"></a><span class="sc">&gt;</span> ofit<span class="ot">&lt;-</span><span class="fu">survreg</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> age<span class="sc">+</span>treat,<span class="at">data=</span>ovarian)</span></code></pre></div>
<p>然后从 Weibull 模型拟合的加速失效时间版本中提取每个患者的风险评分，并将其保存在变量 <code>eta</code> 中。此外，获得每个评分的秩，此外，还获得了每个评分的秩，以便根据评分的秩是否在 1-8, 9-17 或 18-26 的范围内，将患者分为三个风险组。这个变量被添加到数据框中，并得到了第 7 章表 7.2 中所示的分组。完成此操作的代码如下所示。</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="chap17.html#cb67-1" tabindex="-1"></a><span class="sc">&gt;</span> ovarian<span class="sc">$</span>lp<span class="ot">=</span>ofit<span class="sc">$</span>linear.predictors <span class="sc">&gt;</span> ovarian<span class="sc">$</span>ranklp<span class="ot">&lt;-</span><span class="fu">rank</span>(ovarian<span class="sc">$</span>lp) </span>
<span id="cb67-2"><a href="chap17.html#cb67-2" tabindex="-1"></a><span class="sc">&gt;</span> ovarian<span class="sc">$</span>group<span class="ot">&lt;-</span><span class="fu">as.factor</span>(<span class="fu">ifelse</span>(ovarian<span class="sc">$</span>ranklp<span class="sc">&lt;=</span><span class="dv">8</span>,<span class="st">"1"</span>, </span>
<span id="cb67-3"><a href="chap17.html#cb67-3" tabindex="-1"></a>                                  <span class="fu">ifelse</span>(ovarian<span class="sc">$</span>ranklp<span class="sc">&lt;=</span><span class="dv">17</span>,<span class="st">"2"</span>,</span>
<span id="cb67-4"><a href="chap17.html#cb67-4" tabindex="-1"></a>                                         <span class="fu">ifelse</span>(ovarian<span class="sc">$</span>ranklp<span class="sc">&gt;</span><span class="dv">17</span>,<span class="st">"3"</span>,<span class="dv">0</span>))))</span></code></pre></div>
<details><summary><font color="#8B2232">表 7.2</font>
</summary><img src="figure/table%207.2.png#center" style="width:80.0%"></details><p><br>
接下来，对于 26 名女性中的每一位，计算 Weibull 模型拟合的生存函数，其生存时间 t 的值从 0 到 1200，步长为 50. 这是通过如下代码完成的。</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="chap17.html#cb68-1" tabindex="-1"></a><span class="sc">&gt;</span> ov1<span class="ot">&lt;-</span>ovarian[<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="dv">26</span>),<span class="at">each=</span><span class="dv">25</span>),]</span>
<span id="cb68-2"><a href="chap17.html#cb68-2" tabindex="-1"></a><span class="sc">&gt;</span> tt<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">tt=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1200</span>,<span class="at">by=</span><span class="dv">50</span>))</span>
<span id="cb68-3"><a href="chap17.html#cb68-3" tabindex="-1"></a><span class="sc">&gt;</span> tt<span class="ot">&lt;-</span>tt[<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(tt)),<span class="dv">26</span>),]</span>
<span id="cb68-4"><a href="chap17.html#cb68-4" tabindex="-1"></a><span class="sc">&gt;</span> sdata<span class="ot">&lt;-</span><span class="fu">cbind.data.frame</span>(ov1,tt)</span></code></pre></div>
<p>结果是一个新的数据框 <code>sdata</code>，具有 <span class="math inline">\(25×26=650\)</span> 行。最后，使用下式计算生存函数估计</p>
<p><span class="math display">\[\hat{S}(t_i)=\exp\left\{-\exp\left(\frac{\log t_i-\hat{\eta}_i}{\hat{\sigma}}\right)\right\}\]</span></p>
<p>其中 <span class="math inline">\(\hat{\eta}_i=\hat{\mu}+\hat{\alpha}_1Age_i+\hat{\alpha}_2\)</span> 为线性预测器。<span class="math inline">\(Age_i\)</span> 和 <span class="math inline">\(Treat_i\)</span> 是第 <span class="math inline">\(i\)</span> 个女性的 <span class="math inline">\(Age\)</span> 和 <span class="math inline">\(Treat\)</span> 的值。此 R 代码基于函数 <code>aggregate</code> 来形成 <code>tt</code> 和 <code>group</code> 中值的组合的组均值，如下所示。</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="chap17.html#cb69-1" tabindex="-1"></a><span class="sc">&gt;</span> sdata<span class="sc">$</span>survest<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>((<span class="fu">log</span>(sdata<span class="sc">$</span>tt)<span class="sc">-</span>sdata<span class="sc">$</span>lp)<span class="sc">/</span>ofit<span class="sc">$</span>scale)) </span>
<span id="cb69-2"><a href="chap17.html#cb69-2" tabindex="-1"></a><span class="sc">&gt;</span> avsurv<span class="ot">&lt;-</span><span class="fu">aggregate</span>(survest <span class="sc">~</span> group<span class="sc">+</span>tt,<span class="at">FUN=</span>mean,<span class="at">data=</span>sdata)</span></code></pre></div>
<p>然后，数据框 <code>avsurv</code> 包含按风险组 <code>group</code> 和时间 <code>tt</code> 划分的 <code>survest</code> 中生存函数估计的均值。最后，可以使用以下命令轻松获得每个风险组的生存函数的 Kaplan-Meir 估计</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="chap17.html#cb70-1" tabindex="-1"></a><span class="sc">&gt;</span> KMest<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> group,<span class="at">data=</span>ovarian)</span></code></pre></div>
<p>然后，可以将平均生存函数叠加在每组的 Kaplan-Meier 估计图上，该图是从 <code>survival</code> 对象 <code>KMest</code> 使用如下命令获得的</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="chap17.html#cb71-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plot</span>(KMest,<span class="at">xlab=</span><span class="st">"Survival time"</span>,<span class="at">ylab=</span><span class="st">"Survivor function"</span>) </span>
<span id="cb71-2"><a href="chap17.html#cb71-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">lines</span>(survest <span class="sc">~</span> tt,<span class="at">pch=</span><span class="fu">c</span>(<span class="st">"o"</span>,<span class="st">"+"</span>,<span class="st">"*"</span>)[<span class="fu">as.numeric</span>(group)],<span class="at">type=</span><span class="st">"p"</span>, <span class="at">data=</span>avsurv)</span></code></pre></div>
<p>给出的图形类似于图 7.5，但在 <code>plot</code> 函数中使用额外的选项来控制布局会得到一个更令人满意的图。</p>
</div>
</div>
<div id="sec17-9" class="section level2" number="17.9">
<h2>
<span class="header-section-number">17.9</span> 时依变量<a class="anchor" aria-label="anchor" href="#sec17-9"><i class="fas fa-link"></i></a>
</h2>
<p>通过以计数过程格式表示数据，可以将时依变量纳入 Cox 回归模型。第 8 章 <a href="chap8.html#sec8-3">8.3</a> 节概述了该数据格式，第 13 章<a href="chap13.html#sec13-1">13.1</a> 节对其进行了更详细的描述。为了实现这一点，通常需要进行一定量的数据操作，并且需要小心避免代码错误。</p>
<p><code>survival</code> 包中的 R 函数 <code>tmerge</code> 可用于表示计数过程格式的数据集。该函数在关于时依变量的 R vignette中进行了描述 (Therneau, Crowson and Atkinson, 2022). 总之，该函数用于指定添加时依变量的基础数据集。然后，在函数的后续调用中定义时依变量，并与基础数据集合并。此过程最好用一个例子来说明，将使用骨髓移植治疗白血病的数据。该数据集在第 8 章的<a href="chap8.html#exm:ex8-2">示例 8.2</a> 中进行了描述，数据列于表 8.2 中。当患者在血小板水平恢复正常之前死亡时，这在变量 <span class="math inline">\(Ptime\)</span> 中为缺失值，用 <code>.</code> 表示。因此，选项 <code>na.strings=c(".")</code> 附加于 <code>read</code> 语句中，从而为缺失值创建 <code>NA</code>。这里不需要变量 <span class="math inline">\(Precovery\)</span>，因此从数据框中删除。使用以下代码还定义了与三个疾病组相关的因子，并删除了疾病组的原始变量。</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="chap17.html#cb72-1" tabindex="-1"></a><span class="sc">&gt;</span> leukaemia<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Bone marrow transplantation in the treatment</span></span>
<span id="cb72-2"><a href="chap17.html#cb72-2" tabindex="-1"></a><span class="st">                        of leukaemia.dat"</span>,<span class="at">header=</span><span class="cn">TRUE</span>,<span class="at">na.strings=</span><span class="fu">c</span>(<span class="st">"."</span>))</span>
<span id="cb72-3"><a href="chap17.html#cb72-3" tabindex="-1"></a><span class="sc">&gt;</span> leukaemia<span class="sc">$</span>fgroup<span class="ot">&lt;-</span><span class="fu">as.factor</span>(leukaemia<span class="sc">$</span>group)</span>
<span id="cb72-4"><a href="chap17.html#cb72-4" tabindex="-1"></a><span class="sc">&gt;</span> leukaemia<span class="ot">&lt;-</span><span class="fu">subset</span>(leukaemia,<span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(group,precovery))</span></code></pre></div>
<details><summary><font color="#8B2232">表 8.2</font>
</summary><img src="figure/table%208.2.png#center" style="width:80.0%"></details><p><br>
然后使用 <code>tmerge</code> 函数以计数过程格式表示数据</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="chap17.html#cb73-1" tabindex="-1"></a><span class="sc">&gt;</span> tdvdata<span class="ot">&lt;-</span><span class="fu">tmerge</span>(<span class="at">data1=</span>leukaemia,<span class="at">data2=</span>leukaemia,<span class="at">id=</span>patient, </span>
<span id="cb73-2"><a href="chap17.html#cb73-2" tabindex="-1"></a>                  <span class="at">death=</span><span class="fu">event</span>(time,status))</span></code></pre></div>
<p>这导致三个新变量被添加到基础数据框 <code>leukaemia</code> 中。变量 <code>tstart</code> 和 <code>tstop</code> 分别给出每个区间的开始和停止时间（这里都为零），而变量 <span class="math inline">\(Time\)</span> 中的值代表实际的生存时间。选项 <code>id=</code> 指定用于合并使用 <code>tmerge</code> 创建的数据框的标识符，选项 <code>death=event(time,status)</code> 指定新变量 <code>death</code> 用于表示每个时间区间（<code>tstart</code> 到 <code>tstop</code>）结束时个体的状态。数据框 <code>tdvdata</code> 有 23 行，前 5 行如下所示。</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="chap17.html#cb74-1" tabindex="-1"></a>  patient time status page dage ptime fgroup tstart tstop death</span>
<span id="cb74-2"><a href="chap17.html#cb74-2" tabindex="-1"></a><span class="dv">1</span>       <span class="dv">1</span> <span class="dv">1199</span>      <span class="dv">0</span>   <span class="dv">24</span>   <span class="dv">40</span>    <span class="dv">29</span>      <span class="dv">1</span>      <span class="dv">0</span>  <span class="dv">1199</span>     <span class="dv">0</span></span>
<span id="cb74-3"><a href="chap17.html#cb74-3" tabindex="-1"></a><span class="dv">2</span>       <span class="dv">2</span> <span class="dv">1111</span>      <span class="dv">0</span>   <span class="dv">19</span>   <span class="dv">28</span>    <span class="dv">22</span>      <span class="dv">1</span>      <span class="dv">0</span>  <span class="dv">1111</span>     <span class="dv">0</span></span>
<span id="cb74-4"><a href="chap17.html#cb74-4" tabindex="-1"></a><span class="dv">3</span>       <span class="dv">3</span>  <span class="dv">530</span>      <span class="dv">0</span>   <span class="dv">17</span>   <span class="dv">28</span>    <span class="dv">34</span>      <span class="dv">1</span>      <span class="dv">0</span>   <span class="dv">530</span>     <span class="dv">0</span></span>
<span id="cb74-5"><a href="chap17.html#cb74-5" tabindex="-1"></a><span class="dv">4</span>       <span class="dv">4</span> <span class="dv">1279</span>      <span class="dv">1</span>   <span class="dv">17</span>   <span class="dv">20</span>    <span class="dv">22</span>      <span class="dv">1</span>      <span class="dv">0</span>  <span class="dv">1279</span>     <span class="dv">1</span></span>
<span id="cb74-6"><a href="chap17.html#cb74-6" tabindex="-1"></a><span class="dv">5</span>       <span class="dv">5</span>  <span class="dv">110</span>      <span class="dv">1</span>   <span class="dv">28</span>   <span class="dv">25</span>    <span class="dv">49</span>      <span class="dv">1</span>      <span class="dv">0</span>   <span class="dv">110</span>     <span class="dv">1</span></span></code></pre></div>
<p>接下来，第二次调用 <code>tmerge</code> 函数用于指定 <span class="math inline">\(Ptime\)</span> 是表示血小板恢复时间的变量。然后，从这个变量中导出的时变血小板水平指示符与先前创建的数据框 <code>tdvdata</code> 进行合并。选项 <code>tdc=</code> 指定 <code>Plate</code> 为新的时依变量，并将其添加到第一次调用 <code>tmerge</code> 得到的数据中。以下是执行此操作的代码。</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="chap17.html#cb75-1" tabindex="-1"></a><span class="sc">&gt;</span> tdvdata<span class="ot">&lt;-</span><span class="fu">tmerge</span>(<span class="at">data1=</span>tdvdata,<span class="at">data2=</span>leukaemia,<span class="at">id=</span>patient,</span>
<span id="cb75-2"><a href="chap17.html#cb75-2" tabindex="-1"></a>                  <span class="at">Plate=</span><span class="fu">tdc</span>(ptime))</span></code></pre></div>
<p>现在得到的数据框 <code>tdvdata</code> 中，除了两名血小板没有恢复到正常水平的患者外，每位患者都有两行数据。数据现在处于计数过程格式，前六行如下所示。</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="chap17.html#cb76-1" tabindex="-1"></a>  patient time status page dage ptime fgroup tstart tstop death Plate</span>
<span id="cb76-2"><a href="chap17.html#cb76-2" tabindex="-1"></a><span class="dv">1</span>       <span class="dv">1</span> <span class="dv">1199</span>      <span class="dv">0</span>   <span class="dv">24</span>   <span class="dv">40</span>    <span class="dv">29</span>      <span class="dv">1</span>      <span class="dv">0</span>    <span class="dv">29</span>     <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb76-3"><a href="chap17.html#cb76-3" tabindex="-1"></a><span class="dv">2</span>       <span class="dv">1</span> <span class="dv">1199</span>      <span class="dv">0</span>   <span class="dv">24</span>   <span class="dv">40</span>    <span class="dv">29</span>      <span class="dv">1</span>     <span class="dv">29</span>  <span class="dv">1199</span>     <span class="dv">0</span>     <span class="dv">1</span></span>
<span id="cb76-4"><a href="chap17.html#cb76-4" tabindex="-1"></a><span class="dv">3</span>       <span class="dv">2</span> <span class="dv">1111</span>      <span class="dv">0</span>   <span class="dv">19</span>   <span class="dv">28</span>    <span class="dv">22</span>      <span class="dv">1</span>      <span class="dv">0</span>    <span class="dv">22</span>     <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb76-5"><a href="chap17.html#cb76-5" tabindex="-1"></a><span class="dv">4</span>       <span class="dv">2</span> <span class="dv">1111</span>      <span class="dv">0</span>   <span class="dv">19</span>   <span class="dv">28</span>    <span class="dv">22</span>      <span class="dv">1</span>     <span class="dv">22</span>  <span class="dv">1111</span>     <span class="dv">0</span>     <span class="dv">1</span></span>
<span id="cb76-6"><a href="chap17.html#cb76-6" tabindex="-1"></a><span class="dv">5</span>       <span class="dv">3</span>  <span class="dv">530</span>      <span class="dv">0</span>   <span class="dv">17</span>   <span class="dv">28</span>    <span class="dv">34</span>      <span class="dv">1</span>      <span class="dv">0</span>    <span class="dv">34</span>     <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb76-7"><a href="chap17.html#cb76-7" tabindex="-1"></a><span class="dv">6</span>       <span class="dv">3</span>  <span class="dv">530</span>      <span class="dv">0</span>   <span class="dv">17</span>   <span class="dv">28</span>    <span class="dv">34</span>      <span class="dv">1</span>     <span class="dv">34</span>   <span class="dv">530</span>     <span class="dv">0</span>     <span class="dv">1</span></span></code></pre></div>
<p>在这种格式中，第一个患者的血小板水平指示符为零，当他的血小板水平恢复正常（第 29 天），血小板水平指示符变为一，其余患者以此类推。</p>
<p>现在，可以拟合包含新时依变量的 Cox 回归模型。为此，<code>coxph</code> 函数中的 <code>Surv</code> 对象用于指定开始和停止时间以及每个时间区间结束时患者的状态。使用以下函数调用拟合包含与疾病组相关的因子和时依变量的模型。</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="chap17.html#cb77-1" tabindex="-1"></a><span class="sc">&gt;</span> tdvmodel<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,tstop,death) <span class="sc">~</span> Plate<span class="sc">+</span>fgroup,</span>
<span id="cb77-2"><a href="chap17.html#cb77-2" tabindex="-1"></a>                  <span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>tdvdata)</span></code></pre></div>
<p>下面展示了输出结果的一部分，与前面 <a href="chap17.html#sec17-4">17.4</a> 节描述的非常相似。</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="chap17.html#cb78-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb78-2"><a href="chap17.html#cb78-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(tstart, tstop, death) <span class="sc">~</span> Plate <span class="sc">+</span> fgroup, </span>
<span id="cb78-3"><a href="chap17.html#cb78-3" tabindex="-1"></a>    <span class="at">data =</span> tdvdata, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb78-4"><a href="chap17.html#cb78-4" tabindex="-1"></a></span>
<span id="cb78-5"><a href="chap17.html#cb78-5" tabindex="-1"></a>            coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)      z      p</span>
<span id="cb78-6"><a href="chap17.html#cb78-6" tabindex="-1"></a>Plate   <span class="sc">-</span><span class="fl">2.31956</span>   <span class="fl">0.09832</span>  <span class="fl">1.22938</span> <span class="sc">-</span><span class="fl">1.887</span> <span class="fl">0.0592</span></span>
<span id="cb78-7"><a href="chap17.html#cb78-7" tabindex="-1"></a>fgroup2 <span class="sc">-</span><span class="fl">2.07610</span>   <span class="fl">0.12542</span>  <span class="fl">1.15105</span> <span class="sc">-</span><span class="fl">1.804</span> <span class="fl">0.0713</span></span>
<span id="cb78-8"><a href="chap17.html#cb78-8" tabindex="-1"></a>fgroup3  <span class="fl">0.38943</span>   <span class="fl">1.47614</span>  <span class="fl">0.61825</span>  <span class="fl">0.630</span> <span class="fl">0.5288</span></span></code></pre></div>
<p>根据该输出，时依变量的系数为 −2.3196. 因子 <code>fgroup</code> 的三个水平分别对应于 ALL、低风险 AML 和高风险 AML，并且由第一个水平 <code>fgroup1</code> 的效应设为零。ALL 患者在给定时间相对于低风险 AML 患者的风险比为 <span class="math inline">\(\exp(0+2.0761)=7.97\)</span>，并且高风险 AML 患者相对于低风险患者在给定时间的风险比是 <span class="math inline">\(\exp(0.3894+2.0761)=11.77\)</span>，正如<a href="chap8.html#exm:ex8-2">示例 8.2</a> 中发现的。</p>
<p>为了进一步说明函数 <code>tmerge</code> 的使用，给出了 R 代码用于分析<a href="chap8.html#exm:ex8-4">示例 8.4</a> 来自肝硬化治疗假设研究的数据。第一步是将表 8.4 中的基本数据与表 8.5 中的数据结合起来，给出时变的 log(bilirubin) 值。首先使用以下命令输入两个数据集</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="chap17.html#cb79-1" tabindex="-1"></a><span class="sc">&gt;</span> liverbase<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Data from a cirrhosis study (baseline).dat"</span>,</span>
<span id="cb79-2"><a href="chap17.html#cb79-2" tabindex="-1"></a>                        <span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb79-3"><a href="chap17.html#cb79-3" tabindex="-1"></a><span class="sc">&gt;</span> lbrdata0<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Data from a cirrhosis study (lbr data).dat"</span>, </span>
<span id="cb79-4"><a href="chap17.html#cb79-4" tabindex="-1"></a>                       <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<details><summary><font color="#8B2232">表 8.4</font>
</summary><img src="figure/table%208.4.png#center" style="width:80.0%"></details><br><details><summary><font color="#8B2232">表 8.5</font>
</summary><img src="figure/table%208.5.png#center" style="width:80.0%"></details><p><br>
要创建的时变变量需要包括时间起点的 log(bilirubin) 值，即表 8.4 中的基线值。这可以通过构建一个包含患者编号、时间起点和基线 log(bilirubin) 值的数据框，然后将其与表 8.5 中的数据结合，并确保合并后的数据集按患者和随访时间顺序排列来实现。以下是实现这一目标的代码。</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="chap17.html#cb80-1" tabindex="-1"></a><span class="sc">&gt;</span> baselbr<span class="ot">&lt;-</span>liverbase[<span class="fu">c</span>(<span class="st">"patient"</span>,<span class="st">"time"</span>,<span class="st">"lbr"</span>)]</span>
<span id="cb80-2"><a href="chap17.html#cb80-2" tabindex="-1"></a><span class="sc">&gt;</span> baselbr<span class="sc">$</span>time<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>)</span>
<span id="cb80-3"><a href="chap17.html#cb80-3" tabindex="-1"></a><span class="sc">&gt;</span> lbrdata1<span class="ot">&lt;-</span><span class="fu">rbind</span>(baselbr,lbrdata0)</span>
<span id="cb80-4"><a href="chap17.html#cb80-4" tabindex="-1"></a><span class="sc">&gt;</span> lbrdata<span class="ot">&lt;-</span>lbrdata1[<span class="fu">order</span>(lbrdata1<span class="sc">$</span>patient,lbrdata1<span class="sc">$</span>time),]</span></code></pre></div>
<p>数据框 <code>lbrdata</code> 现在与基线数据合并，以生成计数过程格式的数据集。这可以使用下面两个 <code>tmerge</code> 函数调用来完成。</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="chap17.html#cb81-1" tabindex="-1"></a><span class="sc">&gt;</span> tdvlbr<span class="ot">&lt;-</span><span class="fu">tmerge</span>(<span class="at">data1=</span>liverbase,<span class="at">data2=</span>liverbase,<span class="at">id=</span>patient,</span>
<span id="cb81-2"><a href="chap17.html#cb81-2" tabindex="-1"></a>                 <span class="at">death=</span><span class="fu">event</span>(time,status)) </span>
<span id="cb81-3"><a href="chap17.html#cb81-3" tabindex="-1"></a><span class="sc">&gt;</span> tdvlbr<span class="ot">&lt;-</span><span class="fu">tmerge</span>(<span class="at">data1=</span>tdvlbr,<span class="at">data2=</span>lbrdata,<span class="at">id=</span>patient,</span>
<span id="cb81-4"><a href="chap17.html#cb81-4" tabindex="-1"></a>                 <span class="at">lbrt=</span><span class="fu">tdc</span>(time,lbr))</span></code></pre></div>
<p>患者 5 和 8 在其死亡的同一天记录了 log(bilirubin) 值。当使用时依变量时，在给定时间记录的值在该时间之后立即应用，因此，在第 341 天为患者 5 记录的 log(bilirubin) 的新值和在第 182 天为患者 8 记录的 log(bilirubin) 的新值将不会出现在分析中。合并后的数据框有 52 个观测，log(bilirubin) 水平的基线值在变量 <code>lbr</code> 中，时依值在 <code>lbrt</code> 中。使用如下命令</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coxlbr</span><span class="op">&lt;-</span><span class="fu">coxph</span><span class="op">(</span>formula <span class="op">=</span> <span class="fu">Surv</span><span class="op">(</span><span class="va">tstart</span>, <span class="va">tstop</span>, <span class="va">death</span><span class="op">)</span> <span class="op">~</span> <span class="va">lbrt</span> <span class="op">+</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">tdvlbr</span>, </span>
<span>    ties <span class="op">=</span> <span class="st">"breslow"</span><span class="op">)</span></span></code></pre></div>
<p>拟合包括治疗和时依 log(bilirubin) 值的 Cox 回归模型后，使用 <code>summary(coxlbr)</code> 获得以下输出。</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="chap17.html#cb83-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb83-2"><a href="chap17.html#cb83-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(tstart, tstop, death) <span class="sc">~</span> lbrt <span class="sc">+</span> treat, <span class="at">data =</span> tdvlbr, </span>
<span id="cb83-3"><a href="chap17.html#cb83-3" tabindex="-1"></a>    <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb83-4"><a href="chap17.html#cb83-4" tabindex="-1"></a></span>
<span id="cb83-5"><a href="chap17.html#cb83-5" tabindex="-1"></a>         coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)      z     p</span>
<span id="cb83-6"><a href="chap17.html#cb83-6" tabindex="-1"></a>lbrt   <span class="fl">3.6048</span>   <span class="fl">36.7731</span>   <span class="fl">2.2449</span>  <span class="fl">1.606</span> <span class="fl">0.108</span></span>
<span id="cb83-7"><a href="chap17.html#cb83-7" tabindex="-1"></a>treat <span class="sc">-</span><span class="fl">1.4791</span>    <span class="fl">0.2278</span>   <span class="fl">1.3403</span> <span class="sc">-</span><span class="fl">1.104</span> <span class="fl">0.270</span></span>
<span id="cb83-8"><a href="chap17.html#cb83-8" tabindex="-1"></a></span>
<span id="cb83-9"><a href="chap17.html#cb83-9" tabindex="-1"></a>Likelihood ratio test<span class="ot">=</span><span class="fl">14.45</span>  on <span class="dv">2</span> df, p<span class="ot">=</span><span class="fl">0.0007299</span></span>
<span id="cb83-10"><a href="chap17.html#cb83-10" tabindex="-1"></a>n<span class="ot">=</span> <span class="dv">52</span>, number of events<span class="ot">=</span> <span class="dv">8</span></span></code></pre></div>
<p>使用 <code>&gt; -2*logLik(coxlbr)</code> 获得 <span class="math inline">\(−2\log\hat L\)</span> 统计量，为</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="chap17.html#cb84-1" tabindex="-1"></a><span class="st">'log Lik.'</span> <span class="fl">10.6762</span> (<span class="at">df=</span><span class="dv">2</span>)</span></code></pre></div>
<p>这与第 8 章<a href="chap8.html#exm:ex8-4">示例 8.4</a> 中引用的值一致。</p>
<p>不包含时依变量的模型可以拟合到计数过程格式下的扩展数据集 <code>lbrdata</code>，或者拟合到数据框 <code>liverbase</code> 中的 12 个观测。两者都会得到相同的结果。</p>
<div id="sec17-9-1" class="section level3" number="17.9.1">
<h3>
<span class="header-section-number">17.9.1</span> 时变系数<a class="anchor" aria-label="anchor" href="#sec17-9-1"><i class="fas fa-link"></i></a>
</h3>
<p>具有时变系数的模型已在第 4 章的 <a href="chap4.html#sec4-4-4">4.4.4</a> 节描述，这与检验比例风险假设有关，并在 <a href="chap11.html#sec11-2">11.2</a> 节中描述了通过阶跃函数对治疗效应进行建模。这样的模型也可使用函数 <code>coxph</code> 进行拟合。</p>
<p>在第 4 章 <a href="chap4.html#sec4-4-4">4.4.4</a> 节中，Cox 回归模型的系数是时间的函数，用于评估比例风险。<code>coxph</code> 函数的时间变换功能 (time
transform facility) 可用于在模型中包含项 <span class="math inline">\(\beta(t)=\beta t\)</span>。为此，在 <code>coxph</code> 中定义一个函数 <code>tt</code>以形成变量与某个时间函数的乘积，命令为 <code>tt=function(x,t,...) x*g(t)</code>，其中 <code>g(t)</code> 是 <code>t</code> 的指定函数，如 <code>t</code>, <code>log(t)</code> 甚至是样条函数。</p>
<p>为了说明这一点，我们回到第 4 章<a href="chap4.html#exm:ex4-1">示例 4.1</a> 中给出的透析患者感染发生率数据。在<a href="chap4.html#exm:ex4-12">示例 4.12</a> 中，我们通过为变量 <span class="math inline">\(Age\)</span> 和 <span class="math inline">\(Sex\)</span> 添加时变系数，来扩展包含这两个变量的 Cox 回归模型，以检查年龄和性别效应是否随时间保持不变。将数据输入到名为 <code>dialysis</code> 的 R 数据框后（<code>dialysis &lt;- read.table("Infection in patients on dialysis.dat", header=TRUE)</code>），可以使用以下代码来拟合包括 <span class="math inline">\(Age\)</span> 和 <span class="math inline">\(Sex\)</span> 以及 <span class="math inline">\(Sex\)</span> 的时变系数的 Cox 回归模型。</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="chap17.html#cb85-1" tabindex="-1"></a><span class="sc">&gt;</span> tdcfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> age<span class="sc">+</span>sex<span class="sc">+</span><span class="fu">tt</span>(sex),<span class="at">ties=</span><span class="st">"breslow"</span>,</span>
<span id="cb85-2"><a href="chap17.html#cb85-2" tabindex="-1"></a>                <span class="at">tt=</span><span class="cf">function</span>(x,t,...)x<span class="sc">*</span>t,<span class="at">data=</span>dialysis)</span></code></pre></div>
<p>下面是使用 <code>summary(tdcfit)</code> 的部分输出。</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="chap17.html#cb86-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb86-2"><a href="chap17.html#cb86-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> <span class="fu">tt</span>(sex), <span class="at">data =</span> dialysis, </span>
<span id="cb86-3"><a href="chap17.html#cb86-3" tabindex="-1"></a>    <span class="at">ties =</span> <span class="st">"breslow"</span>, <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) x <span class="sc">*</span> t)</span>
<span id="cb86-4"><a href="chap17.html#cb86-4" tabindex="-1"></a></span>
<span id="cb86-5"><a href="chap17.html#cb86-5" tabindex="-1"></a>  n<span class="ot">=</span> <span class="dv">13</span>, number of events<span class="ot">=</span> <span class="dv">12</span> </span>
<span id="cb86-6"><a href="chap17.html#cb86-6" tabindex="-1"></a></span>
<span id="cb86-7"><a href="chap17.html#cb86-7" tabindex="-1"></a>            coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)      z <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>z<span class="sc">|</span>)</span>
<span id="cb86-8"><a href="chap17.html#cb86-8" tabindex="-1"></a>age      <span class="fl">0.03318</span>   <span class="fl">1.03374</span>  <span class="fl">0.02686</span>  <span class="fl">1.235</span>    <span class="fl">0.217</span></span>
<span id="cb86-9"><a href="chap17.html#cb86-9" tabindex="-1"></a>sex     <span class="sc">-</span><span class="fl">1.28076</span>   <span class="fl">0.27782</span>  <span class="fl">2.53323</span> <span class="sc">-</span><span class="fl">0.506</span>    <span class="fl">0.613</span></span>
<span id="cb86-10"><a href="chap17.html#cb86-10" tabindex="-1"></a><span class="fu">tt</span>(sex) <span class="sc">-</span><span class="fl">0.07422</span>   <span class="fl">0.92847</span>  <span class="fl">0.12190</span> <span class="sc">-</span><span class="fl">0.609</span>    <span class="fl">0.543</span></span></code></pre></div>
<p>对于该模型，使用 <code>-2*logLik(tdcfit)</code> 得出 <span class="math inline">\(−2\log\hat L\)</span> 的值为 34.104，并且当省略项 <code>tt(sex)</code> 时，<span class="math inline">\(−2\log\hat L\)</span> 增加 0.364 至 34.468，如<a href="chap4.html#exm:ex4-12">示例 4.12</a> 所示。拟合的模型具有时变的性别系数，其估计为 <span class="math inline">\(\hat{\beta}(t)=-1.281-0.074t\)</span>。这表明性别效应随着时间的推移而增加，但并不显著。</p>
<p>在连续时间区间内具有不同系数的项会产生分段 Cox 模型，用于对治疗之间的非比例性进行建模，如第 11 章 <a href="chap11.html#sec11-2-1">11.2.1</a> 节所述。可以使用 <code>survival</code> 包中的 <code>survSplit</code> 函数将时变系数的阶跃函数纳入 Cox 回归模型。此函数用于将时间尺度划分为所需数量的区间，并使用所得数据框来拟合分层模型。</p>
<p>使用第 11 章<a href="chap11.html#exm:ex11-2">示例 11.2</a> 中给出的前列腺癌患者生存时间数据来说明该过程。在该示例中，假定治疗效应在 1–360, 361–720, 721–1080 天和 1080 天以上的时间区间内是恒定的，但允许它们之间有所不同。数据首先通过如下命令输入以形成 R 数据框 gcancer</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="chap17.html#cb87-1" tabindex="-1"></a><span class="sc">&gt;</span> gcancer<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival of patients with gastric cancer.dat"</span>,</span>
<span id="cb87-2"><a href="chap17.html#cb87-2" tabindex="-1"></a>                      <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>在所得数据框中，治疗效应由变量 <code>treat</code> 表示，单独化疗为零，联合治疗为一。然后使用 <code>surveSplit</code> 函数对时间段进行分层</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="chap17.html#cb88-1" tabindex="-1"></a><span class="sc">&gt;</span> gcancer1<span class="ot">&lt;-</span><span class="fu">survSplit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> .,<span class="at">data=</span>gcancer,</span>
<span id="cb88-2"><a href="chap17.html#cb88-2" tabindex="-1"></a>                      <span class="at">cut=</span><span class="fu">c</span>(<span class="dv">360</span>,<span class="dv">720</span>,<span class="dv">1080</span>),<span class="at">episode=</span><span class="st">"tperiod"</span>)</span></code></pre></div>
<p>这段代码得到 <code>survSplit</code> 对象 <code>gcancer1</code>，时间段缩短为 360、720 和 1080 天。选项 <code>episode=</code> 指定用于标记结果数据框中的时间段的变量名称。原始数据框第 50–58 行中患者 32, 33 和 34 的数据如下。</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="chap17.html#cb89-1" tabindex="-1"></a>patient treat tstart time status tperiod</span>
<span id="cb89-2"><a href="chap17.html#cb89-2" tabindex="-1"></a>     <span class="dv">32</span>     <span class="dv">0</span>      <span class="dv">0</span>  <span class="dv">360</span>      <span class="dv">0</span>       <span class="dv">1</span></span>
<span id="cb89-3"><a href="chap17.html#cb89-3" tabindex="-1"></a>     <span class="dv">32</span>     <span class="dv">0</span>    <span class="dv">360</span>  <span class="dv">720</span>      <span class="dv">0</span>       <span class="dv">2</span></span>
<span id="cb89-4"><a href="chap17.html#cb89-4" tabindex="-1"></a>     <span class="dv">32</span>     <span class="dv">0</span>    <span class="dv">720</span>  <span class="dv">778</span>      <span class="dv">1</span>       <span class="dv">3</span></span>
<span id="cb89-5"><a href="chap17.html#cb89-5" tabindex="-1"></a>     <span class="dv">33</span>     <span class="dv">0</span>      <span class="dv">0</span>  <span class="dv">360</span>      <span class="dv">0</span>       <span class="dv">1</span></span>
<span id="cb89-6"><a href="chap17.html#cb89-6" tabindex="-1"></a>     <span class="dv">33</span>     <span class="dv">0</span>    <span class="dv">360</span>  <span class="dv">720</span>      <span class="dv">0</span>       <span class="dv">2</span></span>
<span id="cb89-7"><a href="chap17.html#cb89-7" tabindex="-1"></a>     <span class="dv">33</span>     <span class="dv">0</span>    <span class="dv">720</span>  <span class="dv">786</span>      <span class="dv">1</span>       <span class="dv">3</span></span>
<span id="cb89-8"><a href="chap17.html#cb89-8" tabindex="-1"></a>     <span class="dv">34</span>     <span class="dv">0</span>      <span class="dv">0</span>  <span class="dv">360</span>      <span class="dv">0</span>       <span class="dv">1</span></span>
<span id="cb89-9"><a href="chap17.html#cb89-9" tabindex="-1"></a>     <span class="dv">34</span>     <span class="dv">0</span>    <span class="dv">360</span>  <span class="dv">720</span>      <span class="dv">0</span>       <span class="dv">2</span></span>
<span id="cb89-10"><a href="chap17.html#cb89-10" tabindex="-1"></a>     <span class="dv">34</span>     <span class="dv">0</span>    <span class="dv">720</span>  <span class="dv">797</span>      <span class="dv">1</span>       <span class="dv">3</span></span></code></pre></div>
<p>数据采用计数过程格式，并使用新变量 <code>tstart</code> 以及原始变量 <code>time</code> 和 <code>status</code> 定义时间段和状态。时变的治疗效应可以通过按时间段分层并包括治疗与时间段的交互作用来建模。治疗与分层变量之间的交互作用在模型公式中表示为 <code>treat:strata(tperiod)</code>，并且使用以下命令拟合包含 <code>treat</code> 和交互项的 Cox 回归模型</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="chap17.html#cb90-1" tabindex="-1"></a><span class="sc">&gt;</span> gcfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,time,status) <span class="sc">~</span> treat<span class="sc">+</span>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod),</span>
<span id="cb90-2"><a href="chap17.html#cb90-2" tabindex="-1"></a>               <span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>gcancer1)</span></code></pre></div>
<p>下面给出了部分输出。</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="chap17.html#cb91-1" tabindex="-1"></a>                                 coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)     z <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>z<span class="sc">|</span>)</span>
<span id="cb91-2"><a href="chap17.html#cb91-2" tabindex="-1"></a>                         treat  <span class="fl">0.877</span>     <span class="fl">2.405</span>    <span class="fl">0.335</span>  <span class="fl">2.62</span>   <span class="fl">0.0088</span></span>
<span id="cb91-3"><a href="chap17.html#cb91-3" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">2</span> <span class="sc">-</span><span class="fl">1.129</span>     <span class="fl">0.323</span>    <span class="fl">0.535</span> <span class="sc">-</span><span class="fl">2.11</span>   <span class="fl">0.0348</span></span>
<span id="cb91-4"><a href="chap17.html#cb91-4" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">3</span> <span class="sc">-</span><span class="fl">1.978</span>     <span class="fl">0.138</span>    <span class="fl">0.870</span> <span class="sc">-</span><span class="fl">2.27</span>   <span class="fl">0.0229</span></span>
<span id="cb91-5"><a href="chap17.html#cb91-5" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">4</span> <span class="sc">-</span><span class="fl">2.060</span>     <span class="fl">0.128</span>    <span class="fl">0.786</span> <span class="sc">-</span><span class="fl">2.62</span>   <span class="fl">0.0088</span></span></code></pre></div>
<p>根据该输出，在四个时间区间内，联合治疗相对于单独化疗的对数风险比分别为 <span class="math inline">\(0.877,0.877 − 1.129 = −0.25,0.877 − 1.978 = −1.10\)</span> 和 <span class="math inline">\(0.877 − 2.060 = −1.18\)</span>。此外，<code>anova(gcfit)</code> 还可以检验治疗效应在四个时期内是否恒定。该模型过度参数化，这就是为什么没有给出 <code>treat:strata(tperiod)tperiod=1</code> 的项。使用如下命令可获得更易解释的结果。</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="chap17.html#cb92-1" tabindex="-1"></a><span class="sc">&gt;</span> gcfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,time,status) <span class="sc">~</span> treat<span class="sc">:</span><span class="fu">strata</span>(tperiod),</span>
<span id="cb92-2"><a href="chap17.html#cb92-2" tabindex="-1"></a>               <span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>gcancer1)</span></code></pre></div>
<p>交互项 <code>treat:strata(tperiod)</code> 现在会在每个时间段产生单独的治疗效应，部分输出如下所示。</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="chap17.html#cb93-1" tabindex="-1"></a>                                  coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)     z <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>z<span class="sc">|</span>) </span>
<span id="cb93-2"><a href="chap17.html#cb93-2" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">1</span>   <span class="fl">0.877</span>     <span class="fl">2.405</span>    <span class="fl">0.335</span>  <span class="fl">2.62</span>   <span class="fl">0.0088</span></span>
<span id="cb93-3"><a href="chap17.html#cb93-3" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">2</span>  <span class="sc">-</span><span class="fl">0.251</span>     <span class="fl">0.778</span>    <span class="fl">0.417</span> <span class="sc">-</span><span class="fl">0.60</span>   <span class="fl">0.5464</span></span>
<span id="cb93-4"><a href="chap17.html#cb93-4" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">3</span>  <span class="sc">-</span><span class="fl">1.101</span>     <span class="fl">0.333</span>    <span class="fl">0.802</span> <span class="sc">-</span><span class="fl">1.37</span>   <span class="fl">0.1701</span></span>
<span id="cb93-5"><a href="chap17.html#cb93-5" tabindex="-1"></a>treat<span class="sc">:</span><span class="fu">strata</span>(tperiod)tperiod<span class="ot">=</span><span class="dv">4</span>  <span class="sc">-</span><span class="fl">1.182</span>     <span class="fl">0.307</span>    <span class="fl">0.711</span> <span class="sc">-</span><span class="fl">1.66</span>   <span class="fl">0.0964</span></span></code></pre></div>
<p>风险比和区间估计可直接从此输出中读取，并且与表 11.3 中列出的一致。</p>
<details><summary><font color="#8B2232">表 11.3</font>
</summary><img src="figure/table%2011.3.png#center" style="width:80.0%"></details>
</div>
<div id="sec17-9-2" class="section level3" number="17.9.2">
<h3>
<span class="header-section-number">17.9.2</span> 纵向数据和生存数据的联合建模<a class="anchor" aria-label="anchor" href="#sec17-9-2"><i class="fas fa-link"></i></a>
</h3>
<p>可以使用 <code>JM</code> 包为纵向数据和生存时间拟合联合模型，但也可以使用其他包，比如 <code>joineR</code> 包。首先使用 <code>nlme</code> 包中的 <code>lme</code> 函数通过线性混合模型对纵向变量进行建模。该函数要求指定模型中的固定效应和随机效应。然后使用 <code>coxph</code> 对生存时间进行建模，以生成生存对象。最后，使用 <code>jointModel</code> 函数将这些单独的纵向模型和生存模型组合成一个联合模型。</p>
<p>使用第 8 章<a href="chap8.html#exm:ex8-5">示例 8.5</a> 给出的主动脉瓣置换术后患者生存数据来说明该过程。该数据集包括患者生存时间和与左心室质量指数 LVMI 相关的变量的纵向值，以及在研究开始时测量的解释变量。首先使用如下命令将数据输入到数据框 <code>valve</code>。</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="chap17.html#cb94-1" tabindex="-1"></a><span class="sc">&gt;</span> valve<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival following aortic valve replacement.dat"</span>,</span>
<span id="cb94-2"><a href="chap17.html#cb94-2" tabindex="-1"></a>                    <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>纵向变量将使用与时间的直线关系进行建模，每个患者具有随机截距和斜率。代表患者性别和术前糖尿病状态的变量也将包括在内，因为这些变量在第 8 章的<a href="chap8.html#exm:ex8-8">示例 8.8</a> 中被证明是显著的，拟合该模型的 <code>lme</code> 函数如下。</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="chap17.html#cb95-1" tabindex="-1"></a><span class="sc">&gt;</span> lmefit<span class="ot">&lt;-</span><span class="fu">lme</span>(lvmi <span class="sc">~</span> sex<span class="sc">+</span>dm<span class="sc">+</span>time,<span class="at">random=</span> <span class="sc">~</span> time<span class="sc">|</span>id,<span class="at">data=</span>valve)</span></code></pre></div>
<p>在该函数中，<code>random=</code> 选项指定随机效应的模型为 <code>~ time</code>，分组变量 <code>id</code> 在 <code>|</code> 符号后指定。</p>
<p>为了对生存时间进行建模，需要一个数据框，其中每行代表一个患者。为了从包含每个患者多行数据的数据框 <code>valve</code> 中构建该数据框，可以使用以下代码。</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="chap17.html#cb96-1" tabindex="-1"></a><span class="sc">&gt;</span> lsurv<span class="ot">&lt;-</span>valve[<span class="sc">!</span><span class="fu">duplicated</span>(valve<span class="sc">$</span>id),]</span></code></pre></div>
<p><code>!</code> 符号用于选择数据框 <code>valve</code> 中变量 <code>id</code> 值不重复的行。使用如下命令删除变量 <code>lvmi</code> 和 <code>time</code>，因为它们不再需要。</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="chap17.html#cb97-1" tabindex="-1"></a><span class="sc">&gt;</span> lsurv<span class="ot">&lt;-</span><span class="fu">subset</span>(lsurv,<span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(lvmi,time))</span></code></pre></div>
<p>这会产生一个数据框 <code>lsurv</code>，其前 5 行如下。</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="chap17.html#cb98-1" tabindex="-1"></a>id futime status age sex redo emerg dm type</span>
<span id="cb98-2"><a href="chap17.html#cb98-2" tabindex="-1"></a> <span class="dv">1</span>  <span class="fl">4.956</span>      <span class="dv">0</span>  <span class="dv">75</span>   <span class="dv">0</span>    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">0</span>    <span class="dv">2</span></span>
<span id="cb98-3"><a href="chap17.html#cb98-3" tabindex="-1"></a> <span class="dv">2</span>  <span class="fl">9.663</span>      <span class="dv">0</span>  <span class="dv">46</span>   <span class="dv">0</span>    <span class="dv">1</span>     <span class="dv">0</span>  <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb98-4"><a href="chap17.html#cb98-4" tabindex="-1"></a> <span class="dv">3</span>  <span class="fl">7.915</span>      <span class="dv">0</span>  <span class="dv">63</span>   <span class="dv">0</span>    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb98-5"><a href="chap17.html#cb98-5" tabindex="-1"></a> <span class="dv">4</span>  <span class="fl">4.038</span>      <span class="dv">0</span>  <span class="dv">61</span>   <span class="dv">0</span>    <span class="dv">1</span>     <span class="dv">0</span>  <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb98-6"><a href="chap17.html#cb98-6" tabindex="-1"></a> <span class="dv">5</span>  <span class="fl">8.816</span>      <span class="dv">0</span>  <span class="dv">54</span>   <span class="dv">0</span>    <span class="dv">1</span>     <span class="dv">0</span>  <span class="dv">0</span>    <span class="dv">1</span></span></code></pre></div>
<p>在<a href="chap8.html#exm:ex8-8">示例 8.8</a> 中，患者年龄是显著影响生存的唯一变量。然后以通常的方式拟合仅包含该变量的 Cox 回归模型，但包括选项 <code>x=TRUE</code>，以在模型中保留解释变量的值矩阵以供以后使用。</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="chap17.html#cb99-1" tabindex="-1"></a><span class="sc">&gt;</span> coxfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(futime,status) <span class="sc">~</span> age,<span class="at">x=</span><span class="cn">TRUE</span>,<span class="at">ties=</span><span class="st">"breslow"</span>,</span>
<span id="cb99-2"><a href="chap17.html#cb99-2" tabindex="-1"></a>                <span class="at">data=</span>lsurv)</span></code></pre></div>
<p>然后，使用函数 <code>jointModel</code> 将 <code>lme</code> 对象 <code>lmefit</code> 与 <code>coxph</code> 对象 <code>coxfit</code> 相结合，并使用 <code>timeVar=</code> 选项指定与纵向测量时间相关的变量。在这个阶段，有许多模型可以用于联合模型中的生存时间，包括 Cox 回归模型、分段指数模型、全参数模型和基于样条的灵活模型。此处将使用基线风险函数对数的样条模型，如第 8 章<a href="chap8.html#exm:ex8-9">示例 8.9</a> 所示。生成以下代码<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;该模型拟合需要一定时间。&lt;/p&gt;"><sup>35</sup></a>。</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="chap17.html#cb100-1" tabindex="-1"></a><span class="sc">&gt;</span> jmod<span class="ot">&lt;-</span><span class="fu">jointModel</span>(lmefit,coxfit,<span class="at">timeVar=</span><span class="st">"time"</span>,<span class="at">method=</span><span class="st">"spline-PH-GH"</span>)</span></code></pre></div>
<p><code>method=</code> 选项指定使用默认为五个内部结的比例风险样条曲线模型，并使用 Gauss-Hermite 求积进行所需的数值积分。可以使用 <code>lng.in.kn=</code> 选项设置不同的内部结数。可以类似的方式指定替代的比例风险模型，例如 <code>method="Cox-PH-GH"</code>, <code>method="piecewise-PH-GH"</code> 或 <code>method="weibull-PH-GH"</code>。</p>
<p><code>summary(jmod)</code>的部分输出如下。</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="chap17.html#cb101-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb101-2"><a href="chap17.html#cb101-2" tabindex="-1"></a><span class="fu">jointModel</span>(<span class="at">lmeObject =</span> lmefit, <span class="at">survObject =</span> coxfit, <span class="at">timeVar =</span> <span class="st">"time"</span>, </span>
<span id="cb101-3"><a href="chap17.html#cb101-3" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"spline-PH-GH"</span>)</span>
<span id="cb101-4"><a href="chap17.html#cb101-4" tabindex="-1"></a></span>
<span id="cb101-5"><a href="chap17.html#cb101-5" tabindex="-1"></a>Data Descriptives<span class="sc">:</span></span>
<span id="cb101-6"><a href="chap17.html#cb101-6" tabindex="-1"></a>Longitudinal Process        Event Process</span>
<span id="cb101-7"><a href="chap17.html#cb101-7" tabindex="-1"></a>Number of Observations<span class="sc">:</span> <span class="dv">988</span> Number of Events<span class="sc">:</span> <span class="dv">54</span> (<span class="fl">21.1</span>%)</span>
<span id="cb101-8"><a href="chap17.html#cb101-8" tabindex="-1"></a>Number of Groups<span class="sc">:</span> <span class="dv">256</span></span>
<span id="cb101-9"><a href="chap17.html#cb101-9" tabindex="-1"></a></span>
<span id="cb101-10"><a href="chap17.html#cb101-10" tabindex="-1"></a>Joint Model Summary<span class="sc">:</span></span>
<span id="cb101-11"><a href="chap17.html#cb101-11" tabindex="-1"></a>Longitudinal Process<span class="sc">:</span> Linear mixed<span class="sc">-</span>effects model</span>
<span id="cb101-12"><a href="chap17.html#cb101-12" tabindex="-1"></a>Event Process<span class="sc">:</span> Relative risk model with spline<span class="sc">-</span>approximated</span>
<span id="cb101-13"><a href="chap17.html#cb101-13" tabindex="-1"></a>        baseline risk <span class="cf">function</span></span>
<span id="cb101-14"><a href="chap17.html#cb101-14" tabindex="-1"></a>Parameterization<span class="sc">:</span> Time<span class="sc">-</span>dependent </span>
<span id="cb101-15"><a href="chap17.html#cb101-15" tabindex="-1"></a></span>
<span id="cb101-16"><a href="chap17.html#cb101-16" tabindex="-1"></a>   log.Lik      AIC      BIC</span>
<span id="cb101-17"><a href="chap17.html#cb101-17" tabindex="-1"></a> <span class="sc">-</span><span class="fl">5437.314</span> <span class="fl">10912.63</span> <span class="fl">10979.99</span></span>
<span id="cb101-18"><a href="chap17.html#cb101-18" tabindex="-1"></a></span>
<span id="cb101-19"><a href="chap17.html#cb101-19" tabindex="-1"></a>Variance Components<span class="sc">:</span></span>
<span id="cb101-20"><a href="chap17.html#cb101-20" tabindex="-1"></a>              StdDev    Corr</span>
<span id="cb101-21"><a href="chap17.html#cb101-21" tabindex="-1"></a>(Intercept)  <span class="fl">59.6043</span>  (Intr)</span>
<span id="cb101-22"><a href="chap17.html#cb101-22" tabindex="-1"></a>time          <span class="fl">7.4949</span> <span class="sc">-</span><span class="fl">0.5819</span></span>
<span id="cb101-23"><a href="chap17.html#cb101-23" tabindex="-1"></a>Residual     <span class="fl">36.1661</span>        </span>
<span id="cb101-24"><a href="chap17.html#cb101-24" tabindex="-1"></a></span>
<span id="cb101-25"><a href="chap17.html#cb101-25" tabindex="-1"></a>Coefficients<span class="sc">:</span></span>
<span id="cb101-26"><a href="chap17.html#cb101-26" tabindex="-1"></a>Longitudinal Process</span>
<span id="cb101-27"><a href="chap17.html#cb101-27" tabindex="-1"></a>               Value Std.Err z<span class="sc">-</span>value p<span class="sc">-</span>value</span>
<span id="cb101-28"><a href="chap17.html#cb101-28" tabindex="-1"></a>(Intercept) <span class="fl">175.0903</span>  <span class="fl">5.1812</span> <span class="fl">33.7932</span> <span class="sc">&lt;</span><span class="fl">0.0001</span></span>
<span id="cb101-29"><a href="chap17.html#cb101-29" tabindex="-1"></a>sex         <span class="sc">-</span><span class="fl">29.6409</span> <span class="fl">10.0306</span> <span class="sc">-</span><span class="fl">2.9551</span>  <span class="fl">0.0031</span></span>
<span id="cb101-30"><a href="chap17.html#cb101-30" tabindex="-1"></a>dm          <span class="sc">-</span><span class="fl">20.9350</span> <span class="fl">10.2557</span> <span class="sc">-</span><span class="fl">2.0413</span>  <span class="fl">0.0412</span></span>
<span id="cb101-31"><a href="chap17.html#cb101-31" tabindex="-1"></a>time         <span class="sc">-</span><span class="fl">1.4126</span>  <span class="fl">0.9104</span> <span class="sc">-</span><span class="fl">1.5516</span>  <span class="fl">0.1208</span></span>
<span id="cb101-32"><a href="chap17.html#cb101-32" tabindex="-1"></a></span>
<span id="cb101-33"><a href="chap17.html#cb101-33" tabindex="-1"></a>Event Process</span>
<span id="cb101-34"><a href="chap17.html#cb101-34" tabindex="-1"></a>          Value Std.Err z<span class="sc">-</span>value p<span class="sc">-</span>value</span>
<span id="cb101-35"><a href="chap17.html#cb101-35" tabindex="-1"></a>age      <span class="fl">0.0859</span>  <span class="fl">0.0160</span>  <span class="fl">5.3598</span> <span class="sc">&lt;</span><span class="fl">0.0001</span></span>
<span id="cb101-36"><a href="chap17.html#cb101-36" tabindex="-1"></a>Assoct   <span class="fl">0.0052</span>  <span class="fl">0.0030</span>  <span class="fl">1.7325</span>  <span class="fl">0.0832</span></span></code></pre></div>
<p>在给出最大化对数似然值 <span class="math inline">\(\log\hat{L}\)</span>，AIC 和 BIC 统计量后，随机截距标准差估计 <span class="math inline">\(\hat u_{0i}\)</span> 和随机斜率标准差估计 <span class="math inline">\(\hat u_{1i}\)</span> 与残差项的标准差估计 <span class="math inline">\(\hat \sigma_\epsilon\)</span> 在题为 <code>StdDev</code> 的列中给出。下一列给出了截距和斜率之间的相关系数为 −0.582.</p>
<p>纵向过程的系数是对 <span class="math inline">\(m_i(t)\)</span> 的拟合模型中的 <span class="math inline">\(\beta\)</span> 系数的估计，<span class="math inline">\(m_i\)</span> 是第 <span class="math inline">\(i\)</span> 名患者的基本响应曲线。这里，拟合模型在时间 <span class="math inline">\(t\)</span> 上是线性的，包括第 <span class="math inline">\(i\)</span> 名患者的性别 <span class="math inline">\(s_i\)</span> 和糖尿病状况 <span class="math inline">\(d_i\)</span>，并在式 <a href="chap8.html#eq:8-12">(8.12)</a> 中给出，其中根据第 8 章<a href="chap8.html#exm:ex8-9">示例 8.9</a>：</p>
<p><span class="math display">\[\begin{aligned}\hat{m}_i(t)=175.09-1.41t-29.64s_i-20.93d_i\end{aligned}\]</span></p>
<p>系数估计的标准误、<span class="math inline">\(z\)</span> 值和 <span class="math inline">\(P\)</span> 值得到了区间估计和假设检验。</p>
<p>联合模型的风险函数估计是根据标记为 <code>Event Process</code> 的部分获得的，其中联合模型中的系数估计 <span class="math inline">\(m_i(t)\)</span> 标记为 <code>Assect</code>。与第 8 章的<a href="chap8.html#exm:ex8-9">示例 8.9</a> 一样，这是</p>
<p><span class="math display">\[\begin{aligned}\hat h_i(t)=\exp\{0.0857a_i+0.0051\hat m_i(t)\}\end{aligned}\]</span></p>
<p>该输出的 <code>Event Process</code> 部分还包含对数基线风险的样条模型指定所需的 9 个立方 B 样条基函数的系数，但这些已被省略。</p>
<p>接下来，可以对 <code>jointModel</code> 对象应用许多操作，包括 <code>predict</code> 以获得纵向变量的拟合值，<code>plot</code> 以获得模型的各种图形总结，以及 <code>residuals</code> 以导出拟合的联合模型的各种残差。</p>
</div>
</div>
<div id="sec17-10" class="section level2" number="17.10">
<h2>
<span class="header-section-number">17.10</span> 区间删失数据<a class="anchor" aria-label="anchor" href="#sec17-10"><i class="fas fa-link"></i></a>
</h2>
<p>如第 9 章 <a href="chap9.html#sec9-1">9.1</a> 节所述，精确事件时间、左删失事件时间和右删失事件时间都可以以区间删失数据的形式表示。右删失事件时间具有无限上限的区间，左删失时间具有零下限，而精确事件时间的区间上下限相等。上限为 <span class="math inline">\(L\)</span>、下限为 <span class="math inline">\(R\)</span> 的区间删失数据可以表示为 <code>survival</code> 对象，以便在模型公式 <code>Surv(L,R,type="interval2")</code> 中使用。无限上限可以指定为 <code>Inf</code> 或 <code>NA</code>。</p>
<p>本节将使用第 9 章<a href="chap9.html#exm:ex9-1">示例 9.1</a> 给出的溃疡复发时间数据进行说明。第一步是输入表 9.1 中的数据并执行必要的操作将其表示为区间删失格式，表 9.2 总结了这一点。变量 <span class="math inline">\(Treat\)</span> 和 <span class="math inline">\(Dur\)</span> 的值也被转换，使得 <span class="math inline">\(Treat\)</span> 对于治疗 <span class="math inline">\(B\)</span> 为 1，否则为 0，并且如果疾病持续时间至少为五年，则 <span class="math inline">\(Dur\)</span> 为 1，否则为 0. “基线”个体是指接受治疗 A 且疾病持续时间少于五年的个体。这可以通过以下方式来完成。</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="chap17.html#cb102-1" tabindex="-1"></a><span class="sc">&gt;</span> ulcer <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"Recurrence of an ulcer.dat"</span>,<span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb102-2"><a href="chap17.html#cb102-2" tabindex="-1"></a><span class="sc">&gt;</span> ulcer<span class="sc">$</span>left<span class="ot">&lt;-</span><span class="fu">ifelse</span>(ulcer<span class="sc">$</span>result<span class="sc">==</span><span class="dv">1</span>,ulcer<span class="sc">$</span>time, <span class="fu">ifelse</span>((ulcer<span class="sc">$</span>result<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> ulcer<span class="sc">$</span>time<span class="sc">&lt;=</span><span class="dv">6</span>),<span class="dv">0</span>,</span>
<span id="cb102-3"><a href="chap17.html#cb102-3" tabindex="-1"></a>                                                        <span class="fu">ifelse</span>((ulcer<span class="sc">$</span>result<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> ulcer<span class="sc">$</span>time<span class="sc">&gt;</span><span class="dv">6</span>),<span class="dv">6</span>,<span class="dv">0</span>))) </span>
<span id="cb102-4"><a href="chap17.html#cb102-4" tabindex="-1"></a><span class="sc">&gt;</span> ulcer<span class="sc">$</span>right<span class="ot">&lt;-</span><span class="fu">ifelse</span>(ulcer<span class="sc">$</span>result<span class="sc">==</span><span class="dv">1</span>,<span class="cn">NA</span>,ulcer<span class="sc">$</span>time) </span>
<span id="cb102-5"><a href="chap17.html#cb102-5" tabindex="-1"></a><span class="sc">&gt;</span> ulcer<span class="sc">$</span>duration<span class="ot">&lt;-</span>ulcer<span class="sc">$</span>duration<span class="dv">-1</span> </span>
<span id="cb102-6"><a href="chap17.html#cb102-6" tabindex="-1"></a><span class="sc">&gt;</span> ulcer<span class="sc">$</span>treatment<span class="ot">&lt;-</span>ulcer<span class="sc">$</span>treatment<span class="dv">-1</span></span></code></pre></div>
<details><summary><font color="#8B2232">表 9.1</font>
</summary><img src="figure/table%209.1.png#center" style="width:80.0%"></details><br><details><summary><font color="#8B2232">表 9.2</font>
</summary><img src="figure/table%209.2.png#center" style="width:80.0%"></details><p><br>
数据框 <code>ulcer</code> 的前十行如下。</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="chap17.html#cb103-1" tabindex="-1"></a>   patient age duration treatment time result left right</span>
<span id="cb103-2"><a href="chap17.html#cb103-2" tabindex="-1"></a><span class="dv">1</span>        <span class="dv">1</span>  <span class="dv">48</span>        <span class="dv">1</span>         <span class="dv">1</span>    <span class="dv">7</span>      <span class="dv">2</span>    <span class="dv">6</span>     <span class="dv">7</span></span>
<span id="cb103-3"><a href="chap17.html#cb103-3" tabindex="-1"></a><span class="dv">2</span>        <span class="dv">2</span>  <span class="dv">73</span>        <span class="dv">0</span>         <span class="dv">1</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-4"><a href="chap17.html#cb103-4" tabindex="-1"></a><span class="dv">3</span>        <span class="dv">3</span>  <span class="dv">54</span>        <span class="dv">0</span>         <span class="dv">1</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-5"><a href="chap17.html#cb103-5" tabindex="-1"></a><span class="dv">4</span>        <span class="dv">4</span>  <span class="dv">58</span>        <span class="dv">1</span>         <span class="dv">1</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-6"><a href="chap17.html#cb103-6" tabindex="-1"></a><span class="dv">5</span>        <span class="dv">5</span>  <span class="dv">56</span>        <span class="dv">0</span>         <span class="dv">0</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-7"><a href="chap17.html#cb103-7" tabindex="-1"></a><span class="dv">6</span>        <span class="dv">6</span>  <span class="dv">49</span>        <span class="dv">1</span>         <span class="dv">0</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-8"><a href="chap17.html#cb103-8" tabindex="-1"></a><span class="dv">7</span>        <span class="dv">7</span>  <span class="dv">71</span>        <span class="dv">0</span>         <span class="dv">1</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-9"><a href="chap17.html#cb103-9" tabindex="-1"></a><span class="dv">8</span>        <span class="dv">8</span>  <span class="dv">41</span>        <span class="dv">0</span>         <span class="dv">0</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-10"><a href="chap17.html#cb103-10" tabindex="-1"></a><span class="dv">9</span>        <span class="dv">9</span>  <span class="dv">23</span>        <span class="dv">0</span>         <span class="dv">1</span>   <span class="dv">12</span>      <span class="dv">1</span>   <span class="dv">12</span>    <span class="cn">NA</span></span>
<span id="cb103-11"><a href="chap17.html#cb103-11" tabindex="-1"></a><span class="dv">10</span>      <span class="dv">10</span>  <span class="dv">37</span>        <span class="dv">0</span>         <span class="dv">1</span>    <span class="dv">5</span>      <span class="dv">2</span>    <span class="dv">0</span>     <span class="dv">5</span></span></code></pre></div>
<div id="sec17-10-1" class="section level3" number="17.10.1">
<h3>
<span class="header-section-number">17.10.1</span> 生存函数的非参数最大似然估计<a class="anchor" aria-label="anchor" href="#sec17-10-1"><i class="fas fa-link"></i></a>
</h3>
<p>第 9 章 <a href="chap9.html#sec9-2">9.2</a> 节描述并说明了区间删失数据生存函数的非参数最大似然估计。可以使用 <code>icfit</code> 函数获得该估计，该函数是 <code>interval</code> 包的一部分，代码如下。</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="chap17.html#cb104-1" tabindex="-1"></a><span class="sc">&gt;</span> icsurv<span class="ot">&lt;-</span><span class="fu">icfit</span>(<span class="fu">Surv</span>(left,right,<span class="at">type=</span><span class="st">"interval2"</span>) <span class="sc">~</span> treatment, <span class="at">data=</span>ulcer)</span></code></pre></div>
<div class="rmdnote">
<p>译者注：可能需要如下通过命令安装 <code>interval</code> 所依赖的包 <code>Icens</code>：</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://bioconductor.github.io/BiocManager/">"BiocManager"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html">install</a></span><span class="op">(</span><span class="st">"Icens"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>使用 <code>summary(icsurv)</code> 会得到以下输出。</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="chap17.html#cb106-1" tabindex="-1"></a>treatment<span class="ot">=</span><span class="dv">0</span><span class="sc">:</span></span>
<span id="cb106-2"><a href="chap17.html#cb106-2" tabindex="-1"></a>  Interval Probability</span>
<span id="cb106-3"><a href="chap17.html#cb106-3" tabindex="-1"></a><span class="dv">1</span>    (<span class="dv">0</span>,<span class="dv">2</span>]      <span class="fl">0.1579</span></span>
<span id="cb106-4"><a href="chap17.html#cb106-4" tabindex="-1"></a><span class="dv">2</span>   (<span class="dv">6</span>,<span class="dv">12</span>]      <span class="fl">0.0648</span></span>
<span id="cb106-5"><a href="chap17.html#cb106-5" tabindex="-1"></a><span class="dv">3</span> (<span class="dv">12</span>,<span class="cn">Inf</span>)      <span class="fl">0.7773</span></span>
<span id="cb106-6"><a href="chap17.html#cb106-6" tabindex="-1"></a><span class="at">treatment=</span><span class="dv">1</span><span class="sc">:</span></span>
<span id="cb106-7"><a href="chap17.html#cb106-7" tabindex="-1"></a>  Interval Probability</span>
<span id="cb106-8"><a href="chap17.html#cb106-8" tabindex="-1"></a><span class="dv">1</span>    (<span class="dv">0</span>,<span class="dv">5</span>]      <span class="fl">0.0833</span></span>
<span id="cb106-9"><a href="chap17.html#cb106-9" tabindex="-1"></a><span class="dv">2</span>    (<span class="dv">6</span>,<span class="dv">7</span>]      <span class="fl">0.2083</span></span>
<span id="cb106-10"><a href="chap17.html#cb106-10" tabindex="-1"></a><span class="dv">3</span> (<span class="dv">12</span>,<span class="cn">Inf</span>)      <span class="fl">0.7083</span></span></code></pre></div>
<p>如果需要，可以对 <code>Surv</code> 对象 <code>Surv(left,right,type="interval2") ~ 1</code> 应用 <code>icfit</code> 来拟合总体生存函数。</p>
<p><code>summary</code> 函数的输出给出了每个治疗组的 Turnbull 区间中的生存概率。据此，治疗 A（<span class="math inline">\(Treat=0\)</span>）患者的生存函数估计在时间起点为 1，对于 2-6 个月之间的复发时间，为 <span class="math inline">\(1 − 0.1579 = 0.8421\)</span>，在 12 个月时为 <span class="math inline">\(1 − 0.1579 − 0.0648 = 0.7773\)</span>，而对于超过 12 个月是未定义的，如第 9 章<a href="chap9.html#exm:ex9-4">示例 9.4</a> 所示。</p>
<p><code>interval</code> 包中的函数 <code>getsurv</code> 还可用于获取每种治疗在指定时间的生存函数估计。由于生存函数在 Turnbull 区间内不是唯一定义的，因此该函数使用线性插值从连接 Turnbull 区间开始和结束处的生存估计的线上的点获取估计。以下代码捕获了每个治疗组在事件时间为 <span class="math inline">\(0,1, 2,\ldots,12\)</span> 时的估计，并将这些值形成一个矩阵 <code>surv_ests</code>，用于打印和进一步分析。</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="chap17.html#cb107-1" tabindex="-1"></a><span class="sc">&gt;</span> times<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">12</span>)</span>
<span id="cb107-2"><a href="chap17.html#cb107-2" tabindex="-1"></a><span class="sc">&gt;</span> icsurvests<span class="ot">&lt;-</span><span class="fu">getsurv</span>(times,icsurv)</span>
<span id="cb107-3"><a href="chap17.html#cb107-3" tabindex="-1"></a><span class="sc">&gt;</span> surv_ests<span class="ot">&lt;-</span><span class="fu">cbind</span>(times,icsurvests[[<span class="dv">1</span>]]<span class="sc">$</span>S,icsurvests[[<span class="dv">2</span>]]<span class="sc">$</span>S)</span>
<span id="cb107-4"><a href="chap17.html#cb107-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(surv_ests)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Time"</span>,<span class="st">"S(0)"</span>,<span class="st">"S(1)"</span>)</span>
<span id="cb107-5"><a href="chap17.html#cb107-5" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">print</span>(surv_ests)</span></code></pre></div>
<p>这会产生以下输出，该输出可以与从 <code>summary(icsurv)</code> 输出中的生存概率获得的生存函数估计进行核对和统一。</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="chap17.html#cb108-1" tabindex="-1"></a>     Time      <span class="fu">S</span>(<span class="dv">0</span>)      <span class="fu">S</span>(<span class="dv">1</span>)</span>
<span id="cb108-2"><a href="chap17.html#cb108-2" tabindex="-1"></a> [<span class="dv">1</span>,]    <span class="dv">0</span> <span class="fl">1.0000000</span> <span class="fl">1.0000000</span></span>
<span id="cb108-3"><a href="chap17.html#cb108-3" tabindex="-1"></a> [<span class="dv">2</span>,]    <span class="dv">1</span> <span class="fl">0.9210526</span> <span class="fl">0.9833333</span></span>
<span id="cb108-4"><a href="chap17.html#cb108-4" tabindex="-1"></a> [<span class="dv">3</span>,]    <span class="dv">2</span> <span class="fl">0.8421053</span> <span class="fl">0.9666667</span></span>
<span id="cb108-5"><a href="chap17.html#cb108-5" tabindex="-1"></a> [<span class="dv">4</span>,]    <span class="dv">3</span> <span class="fl">0.8421053</span> <span class="fl">0.9500000</span></span>
<span id="cb108-6"><a href="chap17.html#cb108-6" tabindex="-1"></a> [<span class="dv">5</span>,]    <span class="dv">4</span> <span class="fl">0.8421053</span> <span class="fl">0.9333333</span></span>
<span id="cb108-7"><a href="chap17.html#cb108-7" tabindex="-1"></a> [<span class="dv">6</span>,]    <span class="dv">5</span> <span class="fl">0.8421053</span> <span class="fl">0.9166667</span></span>
<span id="cb108-8"><a href="chap17.html#cb108-8" tabindex="-1"></a> [<span class="dv">7</span>,]    <span class="dv">6</span> <span class="fl">0.8421053</span> <span class="fl">0.9166667</span></span>
<span id="cb108-9"><a href="chap17.html#cb108-9" tabindex="-1"></a> [<span class="dv">8</span>,]    <span class="dv">7</span> <span class="fl">0.8313090</span> <span class="fl">0.7083333</span></span>
<span id="cb108-10"><a href="chap17.html#cb108-10" tabindex="-1"></a> [<span class="dv">9</span>,]    <span class="dv">8</span> <span class="fl">0.8205128</span> <span class="fl">0.7083333</span></span>
<span id="cb108-11"><a href="chap17.html#cb108-11" tabindex="-1"></a>[<span class="dv">10</span>,]    <span class="dv">9</span> <span class="fl">0.8097166</span> <span class="fl">0.7083333</span></span>
<span id="cb108-12"><a href="chap17.html#cb108-12" tabindex="-1"></a>[<span class="dv">11</span>,]   <span class="dv">10</span> <span class="fl">0.7989204</span> <span class="fl">0.7083333</span></span>
<span id="cb108-13"><a href="chap17.html#cb108-13" tabindex="-1"></a>[<span class="dv">12</span>,]   <span class="dv">11</span> <span class="fl">0.7881242</span> <span class="fl">0.7083333</span></span>
<span id="cb108-14"><a href="chap17.html#cb108-14" tabindex="-1"></a>[<span class="dv">13</span>,]   <span class="dv">12</span> <span class="fl">0.7773279</span> <span class="fl">0.7083333</span></span></code></pre></div>
<p><code>icfit</code> 对象 <code>icsurv</code> 也可直接使用 <code>plot(icsurv)</code> 绘制，这会产生类似于图 9.2 所示的图形。</p>
<details><summary><font color="#8B2232">图 9.2</font>
</summary><img src="figure/figure%209.2.png#center" style="width:80.0%"></details><p><br>
使用 <code>icenReg</code> 包中的 R 函数 <code>ic_np</code> 也可以得到区间删失数据生存函数的非参数最大似然估计。要使用此函数，必须按以下方式指定区间上下限的矩阵，而不是 <code>Surv</code> 对象。</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="chap17.html#cb109-1" tabindex="-1"></a><span class="sc">&gt;</span> icsurv1<span class="ot">&lt;-</span><span class="fu">ic_np</span>(<span class="fu">cbind</span>(left,right) <span class="sc">~</span> treatment,<span class="at">data=</span>ulcer)</span></code></pre></div>
<p><code>summary</code> 函数的输出内容较少，但 <code>ic_np</code> 对象 <code>icsurv1</code> 中包含了 <code>icsurv1$scurves</code>，可以通过 <code>print(icsurv1$scurves)</code> 进行展示，其产生的输出结果就包括了生存函数估计。</p>
</div>
<div id="sec17-10-2" class="section level3" number="17.10.2">
<h3>
<span class="header-section-number">17.10.2</span> 区间删失数据的半参数模型<a class="anchor" aria-label="anchor" href="#sec17-10-2"><i class="fas fa-link"></i></a>
</h3>
<p>第 9 章 <a href="chap9.html#sec9-3">9.3</a> 节描述的半参数 Turnbull 模型可以使用 <code>icenReg</code> 包中的 <code>ic_sp</code> 函数拟合区间删失数据。例如，要为溃疡复发时间数据拟合仅包含治疗效应的模型，请使用<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;该模型拟合需要一定时间。&lt;/p&gt;"><sup>36</sup></a></p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="chap17.html#cb110-1" tabindex="-1"></a><span class="sc">&gt;</span> icfit<span class="ot">&lt;-</span><span class="fu">ic_sp</span>(<span class="fu">Surv</span>(left,right,<span class="at">type=</span><span class="st">"interval2"</span>) <span class="sc">~</span> treatment,</span>
<span id="cb110-2"><a href="chap17.html#cb110-2" tabindex="-1"></a>               <span class="at">bs_samples=</span><span class="dv">10000</span>,<span class="at">data=</span>ulcer)</span></code></pre></div>
<p>选项 <code>bs_samples=</code> 指定在计算拟合模型中参数估计的标准误差的 bootstrap 估计时使用的 bootstrap 样本数。</p>
<p>第 9 章的<a href="chap9.html#exm:ex9-5">示例 9.5</a> 概述了此过程。可以使用 <code>summary(icfit)</code> 获得输出并给出</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="chap17.html#cb111-1" tabindex="-1"></a>Model<span class="sc">:</span>  Cox PH</span>
<span id="cb111-2"><a href="chap17.html#cb111-2" tabindex="-1"></a>Dependency structure assumed<span class="sc">:</span> Independence</span>
<span id="cb111-3"><a href="chap17.html#cb111-3" tabindex="-1"></a>Baseline<span class="sc">:</span>  semi<span class="sc">-</span>parametric </span>
<span id="cb111-4"><a href="chap17.html#cb111-4" tabindex="-1"></a>Call<span class="sc">:</span> <span class="fu">ic_sp</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(left, right, <span class="at">type =</span> <span class="st">"interval2"</span>) <span class="sc">~</span> treatment, </span>
<span id="cb111-5"><a href="chap17.html#cb111-5" tabindex="-1"></a>    <span class="at">data =</span> ulcer, <span class="at">bs_samples =</span> <span class="dv">10000</span>)</span>
<span id="cb111-6"><a href="chap17.html#cb111-6" tabindex="-1"></a></span>
<span id="cb111-7"><a href="chap17.html#cb111-7" tabindex="-1"></a>          Estimate <span class="fu">Exp</span>(Est) Std.Error z<span class="sc">-</span>value      p</span>
<span id="cb111-8"><a href="chap17.html#cb111-8" tabindex="-1"></a>treatment   <span class="fl">0.1953</span>    <span class="fl">1.216</span>     <span class="fl">1.502</span>    <span class="fl">0.13</span> <span class="fl">0.8966</span></span>
<span id="cb111-9"><a href="chap17.html#cb111-9" tabindex="-1"></a></span>
<span id="cb111-10"><a href="chap17.html#cb111-10" tabindex="-1"></a>final llk <span class="ot">=</span>  <span class="sc">-</span><span class="fl">31.44204</span> </span>
<span id="cb111-11"><a href="chap17.html#cb111-11" tabindex="-1"></a>Iterations <span class="ot">=</span>  <span class="dv">6</span> </span>
<span id="cb111-12"><a href="chap17.html#cb111-12" tabindex="-1"></a>Bootstrap Samples <span class="ot">=</span>  <span class="dv">10000</span></span></code></pre></div>
<p>根据该输出，接受治疗 B 的患者相对于接受治疗 A 的患者的对数风险比估计为 0.195，标准误为 1.488. 该标准误差是使用 bootstrap 模拟获得的，因此不能完复现。<span class="math inline">\(-2\log\hat{L}\)</span> 统计量的值根据 <code>final llk</code> 的值计算为 <span class="math inline">\(−2(−31.442) = 62.884\)</span>，如<a href="chap9.html#exm:ex9-5">示例 9.5</a> 所示。</p>
<p><code>getSCurves</code> 函数可用于获取每个治疗组的生存函数估计</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="chap17.html#cb112-1" tabindex="-1"></a><span class="sc">&gt;</span> treatment<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb112-2"><a href="chap17.html#cb112-2" tabindex="-1"></a><span class="sc">&gt;</span> newdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(treatment)</span>
<span id="cb112-3"><a href="chap17.html#cb112-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">getSCurves</span>(icfit,newdata)</span></code></pre></div>
<p>这将产生以下的简略输出。</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="chap17.html#cb113-1" tabindex="-1"></a><span class="sc">$</span>Tbull_ints</span>
<span id="cb113-2"><a href="chap17.html#cb113-2" tabindex="-1"></a>       lower upper</span>
<span id="cb113-3"><a href="chap17.html#cb113-3" tabindex="-1"></a>[<span class="dv">1</span>,] <span class="fl">1.0e-10</span> <span class="fl">1e-10</span></span>
<span id="cb113-4"><a href="chap17.html#cb113-4" tabindex="-1"></a>[<span class="dv">2</span>,] <span class="fl">1.0e-10</span> <span class="fl">2e+00</span></span>
<span id="cb113-5"><a href="chap17.html#cb113-5" tabindex="-1"></a>[<span class="dv">3</span>,] <span class="fl">6.0e+00</span> <span class="fl">7e+00</span></span>
<span id="cb113-6"><a href="chap17.html#cb113-6" tabindex="-1"></a>[<span class="dv">4</span>,] <span class="fl">1.2e+01</span>   <span class="cn">Inf</span></span>
<span id="cb113-7"><a href="chap17.html#cb113-7" tabindex="-1"></a></span>
<span id="cb113-8"><a href="chap17.html#cb113-8" tabindex="-1"></a><span class="sc">$</span>S_curves</span>
<span id="cb113-9"><a href="chap17.html#cb113-9" tabindex="-1"></a><span class="sc">$</span>S_curves<span class="sc">$</span><span class="st">`</span><span class="at">1</span><span class="st">`</span></span>
<span id="cb113-10"><a href="chap17.html#cb113-10" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.0000000</span> <span class="fl">0.8957260</span> <span class="fl">0.7585258</span> <span class="fl">0.0000000</span></span>
<span id="cb113-11"><a href="chap17.html#cb113-11" tabindex="-1"></a></span>
<span id="cb113-12"><a href="chap17.html#cb113-12" tabindex="-1"></a><span class="sc">$</span>S_curves<span class="sc">$</span><span class="st">`</span><span class="at">2</span><span class="st">`</span></span>
<span id="cb113-13"><a href="chap17.html#cb113-13" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.0000000</span> <span class="fl">0.8747077</span> <span class="fl">0.7146427</span> <span class="fl">0.0000000</span></span>
<span id="cb113-14"><a href="chap17.html#cb113-14" tabindex="-1"></a></span>
<span id="cb113-15"><a href="chap17.html#cb113-15" tabindex="-1"></a></span>
<span id="cb113-16"><a href="chap17.html#cb113-16" tabindex="-1"></a><span class="fu">attr</span>(,<span class="st">"class"</span>)</span>
<span id="cb113-17"><a href="chap17.html#cb113-17" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"sp_curves"</span></span></code></pre></div>
<p>Turnbull 区间和生存函数估计与第 9 章表 9.4 给出的值相对应。请注意，<code>getSCurves</code> 函数的默认设置是根据拟合模型中变量值的均值来估计生存函数。因此，<code>getSCurves(icfit)</code> 给出了 <code>Treat=0.5881</code> 的生存函数（因为 0.5881 是该变量在 43 名患者中的样本均值），但这没有意义。</p>
<details><summary><font color="#8B2232">表 9.4</font>
</summary><img src="figure/table%209.4.png#center" style="width:80.0%"></details>
</div>
<div id="sec17-10-3" class="section level3" number="17.10.3">
<h3>
<span class="header-section-number">17.10.3</span> 区间删失数据的参数模型<a class="anchor" aria-label="anchor" href="#sec17-10-3"><i class="fas fa-link"></i></a>
</h3>
<p>利用 <code>survival</code> 包中的 <code>survreg</code> 函数，可以对区间删失数据拟合参数模型。该函数中使用的 <code>Surv</code> 对象与其他用于处理区间删失数据的函数所使用的相同，并且其输出结果与 <a href="chap17.html#sec17-6">17.6</a> 节描述的使用survreg拟合参数模型时的情况相似。唯一需要注意的是，对于左删失时间为零的情况，必须将其替换为 <code>NA</code>。例如，要对溃疡复发时间的区间删失数据拟合 Weibull 模型，请使用以下命令：</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="chap17.html#cb114-1" tabindex="-1"></a><span class="sc">&gt;</span> ulcer<span class="sc">$</span>left1<span class="ot">&lt;-</span><span class="fu">ifelse</span>(ulcer<span class="sc">$</span>left<span class="sc">==</span><span class="dv">0</span>,<span class="cn">NA</span>,ulcer<span class="sc">$</span>left)</span>
<span id="cb114-2"><a href="chap17.html#cb114-2" tabindex="-1"></a><span class="sc">&gt;</span> icweib<span class="ot">&lt;-</span><span class="fu">survreg</span>(<span class="fu">Surv</span>(left1,right,<span class="at">type=</span><span class="st">"interval2"</span>) <span class="sc">~</span> treatment,</span>
<span id="cb114-3"><a href="chap17.html#cb114-3" tabindex="-1"></a>                  <span class="at">data=</span>ulcer)</span></code></pre></div>
<p>在计算逻辑表达式以给出 <code>True</code> 或 <code>False</code> 的结果时，<code>ifelse</code> 语句中需使用双等号。有关解释此输出的详细信息，请参见 <a href="chap17.html#sec17-6">17.6</a> 节。结果与第 9 章<a href="chap9.html#exm:ex9-7">示例 9.7</a> 中给出的结果一致。</p>
</div>
</div>
<div id="sec17-11" class="section level2" number="17.11">
<h2>
<span class="header-section-number">17.11</span> 脆弱模型<a class="anchor" aria-label="anchor" href="#sec17-11"><i class="fas fa-link"></i></a>
</h2>
<p>包含个体随机效应或组内个体共享的随机效应的生存时间模型称为脆弱模型。这类模型可能是参数化的或半参数化的，并在第 <a href="chap10.html#chap10">10</a> 章有详细描述。</p>
<div id="sec17-11-1" class="section level3" number="17.11.1">
<h3>
<span class="header-section-number">17.11.1</span> 拟合具有个体脆弱性的参数脆弱模型<a class="anchor" aria-label="anchor" href="#sec17-11-1"><i class="fas fa-link"></i></a>
</h3>
<p>时间 <span class="math inline">\(t\)</span> 时事件风险的比例风险模型，其中第 <span class="math inline">\(i\)</span> 个个体（共 <span class="math inline">\(n\)</span> 个）的随机效应为 <span class="math inline">\(u_i\)</span> ，为</p>
<p><span class="math display">\[h_i(t)=\exp(\boldsymbol{\beta'x}_i+u_i)h_0(t)\]</span></p>
<p>其中 <span class="math inline">\(\boldsymbol{\beta}^{\prime}\boldsymbol{x}_i\)</span> 是解释变量 <span class="math inline">\(\boldsymbol x_i\)</span> 值与系数 <span class="math inline">\(\boldsymbol\beta\)</span> 的线性组合，<span class="math inline">\(h_0(t)\)</span> 是基线风险函数。该模型也可写为</p>
<p><span class="math display" id="eq:17-2">\[\begin{align}
h_i(t)=z_i\exp(\boldsymbol{\beta'x}_i)h_0(t)
\tag{17.2}
\end{align}\]</span></p>
<p>其中 <span class="math inline">\(z_i = \exp(u_i)\)</span> 称为脆弱性。尽管某些 R 包中使用脆弱性一词指代 <span class="math inline">\(u_i\)</span> 或 <span class="math inline">\(z_i\)</span>，但在后续讨论中，我们将保持随机效应 <span class="math inline">\(u_i\)</span> 与其对应的脆弱项 <span class="math inline">\(z_i\)</span> 之间的这种区分。</p>
<p>参数脆弱模型可以使用 <code>parfm</code> 包中的 R 函数 <code>parfm</code> 进行拟合。该函数可为假定有有指数, Weibull, loglogstic 或 lognormal 分布的数据进行建模，其中脆弱性分布包括 gamma 和 lognormal. <code>parfm</code> 函数中的基线分布以与 <code>survreg</code> 函数不同的方式进行参数化。具体来说，Weibull 基线风险表示为 <span class="math inline">\(\text{λρtρ-1}\)</span>，因此 <span class="math inline">\(\rho\)</span> 代替了第 5 章式 <a href="chap5.html#eq:5-4">(5.4)</a> 中的 <span class="math inline">\(\gamma\)</span>，指数基线风险为 <span class="math inline">\(\rho=1\)</span>。loglogstic 基线风险的参数化如第 5 章式 <a href="chap5.html#eq:5-8">(5.8)</a> 所示，但使用 <span class="math inline">\(\alpha\)</span> 替代了 <span class="math inline">\(\theta\)</span>，lognormal 分布如第 5 章 <a href="chap5.html#sec5-1-4">5.1.4</a> 节所述。脆弱性分布的参数为 <span class="math inline">\(\theta\)</span>，它是第 <span class="math inline">\(i\)</span> 个个体的模型中脆弱项 <span class="math inline">\(z_i\)</span> 的方差。因此，在 <a href="chap10.html#sec10-2">10.2</a> 节描述的 gamma 脆弱性分布中的 <span class="math inline">\(\theta\)</span> 替换为 <span class="math inline">\(\theta-1\)</span>，而第 10 章 <a href="chap10.html#sec10-2-1">10.2.1</a> 节中的 lognormal 脆弱性方差 <span class="math inline">\(\text{var }(z_i) = \theta\)</span>，因此脆弱效应 <span class="math inline">\(u_i\)</span> 的方差为 <span class="math inline">\(e^{\theta}(e^\theta − 1)\)</span>。有关 <code>parfm</code> 中使用的模型范围和参数化的详细信息，请参阅与软件包关联的 R vignette (Munda, Rotolo and Legrand, 2017).</p>
<p>为了说明 <code>parfm</code> 函数的使用，将使用<a href="chap10.html#exm:ex10-3">示例 10.3</a> 中关于等待肺移植的患者的生存数据。首先将数据输入到 R 数据框，将性别声明为一个因子，其水平对应于男性和女性患者，而疾病为四个水平的因子，对应于 COPD、纤维化、化脓性疾病和其他疾病。基线水平设为患有化脓性疾病的男性患者。</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="chap17.html#cb115-1" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival of patients registered for a lung transplant.dat"</span>,</span>
<span id="cb115-2"><a href="chap17.html#cb115-2" tabindex="-1"></a>                   <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb115-3"><a href="chap17.html#cb115-3" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="sc">$</span>fdisease<span class="ot">&lt;-</span><span class="fu">factor</span>(lung<span class="sc">$</span>disease)</span>
<span id="cb115-4"><a href="chap17.html#cb115-4" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">levels</span>(lung<span class="sc">$</span>fdisease)<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"COPD"</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">"Fib"</span><span class="ot">=</span><span class="dv">2</span>,<span class="st">"Supp"</span><span class="ot">=</span><span class="dv">3</span>,<span class="st">"Other"</span><span class="ot">=</span><span class="dv">4</span>)</span>
<span id="cb115-5"><a href="chap17.html#cb115-5" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="sc">$</span>fdisease<span class="ot">&lt;-</span><span class="fu">relevel</span>(lung<span class="sc">$</span>fdisease,<span class="at">ref=</span><span class="dv">3</span>)</span>
<span id="cb115-6"><a href="chap17.html#cb115-6" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="sc">$</span>fgender<span class="ot">&lt;-</span><span class="fu">factor</span>(lung<span class="sc">$</span>gender)</span>
<span id="cb115-7"><a href="chap17.html#cb115-7" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">levels</span>(lung<span class="sc">$</span>fgender)<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"male"</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">"female"</span><span class="ot">=</span><span class="dv">2</span>)</span>
<span id="cb115-8"><a href="chap17.html#cb115-8" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="sc">$</span>fgender<span class="ot">&lt;-</span><span class="fu">relevel</span>(lung<span class="sc">$</span>fgender,<span class="at">ref=</span><span class="dv">2</span>)</span></code></pre></div>
<p>函数 <code>parfm</code> 的语法与生存数据建模中使用的其他 R 函数的语法相似，模型公式是使用 <code>Surv</code> 对象表示的。此外，<code>dist=</code> 选项用于指定生存时间的参数分布，<code>cluster=</code> 选项指定用于脆弱性的项，该项视为一个因子，而 <code>frailty=</code> 选项用于指定脆弱分布。为了拟合具有 gamma 脆弱性的 Weibull 模型，其中 196 名患者中每个患者都有单独的脆弱性值，使用以下代码。</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="chap17.html#cb116-1" tabindex="-1"></a><span class="sc">&gt;</span> f_lung0<span class="ot">&lt;-</span><span class="fu">parfm</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> fgender<span class="sc">+</span>age<span class="sc">+</span>bmi<span class="sc">+</span>fdisease,</span>
<span id="cb116-2"><a href="chap17.html#cb116-2" tabindex="-1"></a>                 <span class="at">cluster=</span><span class="st">"patient"</span>,<span class="at">dist=</span><span class="st">"weibull"</span>,<span class="at">frailty=</span><span class="st">"gamma"</span>,<span class="at">data=</span>lung)</span></code></pre></div>
<p>不幸的是，模型拟合程序无法收敛，因为 Weibull 尺度参数的估计变得非常小。这个问题可以通过使用不同的生存时间时间尺度来解决。在这里，在除以 30.44 将生存时间从天转换为月后，模型拟合程序便收敛了。通过这种重新调整，原始 Weibull 基线风险变为 <span class="math inline">\(30.44h_0(t/30.44)\)</span>，即 <span class="math inline">\(30\lambda\rho(t/30.44)^{\rho-1}\)</span>，因此为以月为单位的生存时间拟合的模型的尺度参数估计为 <span class="math inline">\(\lambda^*=30.44^\rho\lambda\)</span>。因此，原始尺度上的 Weibull 尺度参数为 <span class="math inline">\(\lambda^{*}/30.44^{\rho}\)</span>。对数似然统计量 <span class="math inline">\(−2 \log \hat L\)</span> 的值也会有所不同，但替代模型之间的该值之差不受生存时间的任何缩放的影响。</p>
<p>为了将时间尺度从天改为月，并拟合具有 gamma 脆弱性的 Weibull 模型，使用以下代码。</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="chap17.html#cb117-1" tabindex="-1"></a><span class="sc">&gt;</span> lung<span class="sc">$</span>time1<span class="ot">&lt;-</span>lung<span class="sc">$</span>time<span class="sc">/</span><span class="fl">30.44</span></span>
<span id="cb117-2"><a href="chap17.html#cb117-2" tabindex="-1"></a><span class="sc">&gt;</span> f_lung<span class="ot">&lt;-</span><span class="fu">parfm</span>(<span class="fu">Surv</span>(time1,status) <span class="sc">~</span> fgender<span class="sc">+</span>age<span class="sc">+</span>bmi<span class="sc">+</span>fdisease,</span>
<span id="cb117-3"><a href="chap17.html#cb117-3" tabindex="-1"></a>              <span class="at">cluster=</span><span class="st">"patient"</span>,<span class="at">dist=</span><span class="st">"weibull"</span>,<span class="at">frailty=</span><span class="st">"gamma"</span>,<span class="at">data=</span>lung)</span></code></pre></div>
<p><code>print(f_lung)</code> 得到如下输出。</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="chap17.html#cb118-1" tabindex="-1"></a>Frailty distribution<span class="sc">:</span> gamma </span>
<span id="cb118-2"><a href="chap17.html#cb118-2" tabindex="-1"></a>Baseline hazard distribution<span class="sc">:</span> Weibull </span>
<span id="cb118-3"><a href="chap17.html#cb118-3" tabindex="-1"></a>Loglikelihood<span class="sc">:</span> <span class="sc">-</span><span class="fl">591.709</span> </span>
<span id="cb118-4"><a href="chap17.html#cb118-4" tabindex="-1"></a></span>
<span id="cb118-5"><a href="chap17.html#cb118-5" tabindex="-1"></a>              ESTIMATE SE    p<span class="sc">-</span>val  </span>
<span id="cb118-6"><a href="chap17.html#cb118-6" tabindex="-1"></a>theta          <span class="fl">3.015</span>   <span class="fl">1.063</span>        </span>
<span id="cb118-7"><a href="chap17.html#cb118-7" tabindex="-1"></a>rho            <span class="fl">1.304</span>   <span class="fl">0.229</span>        </span>
<span id="cb118-8"><a href="chap17.html#cb118-8" tabindex="-1"></a>lambda         <span class="fl">0.023</span>   <span class="fl">0.025</span>        </span>
<span id="cb118-9"><a href="chap17.html#cb118-9" tabindex="-1"></a>fgendermale    <span class="fl">0.433</span>   <span class="fl">0.412</span> <span class="fl">0.294</span>  </span>
<span id="cb118-10"><a href="chap17.html#cb118-10" tabindex="-1"></a>age            <span class="fl">0.003</span>   <span class="fl">0.020</span> <span class="fl">0.867</span>  </span>
<span id="cb118-11"><a href="chap17.html#cb118-11" tabindex="-1"></a>bmi           <span class="sc">-</span><span class="fl">0.014</span>   <span class="fl">0.047</span> <span class="fl">0.763</span>  </span>
<span id="cb118-12"><a href="chap17.html#cb118-12" tabindex="-1"></a>fdiseaseCOPD  <span class="sc">-</span><span class="fl">1.008</span>   <span class="fl">0.692</span> <span class="fl">0.145</span>  </span>
<span id="cb118-13"><a href="chap17.html#cb118-13" tabindex="-1"></a>fdiseaseFib    <span class="fl">1.383</span>   <span class="fl">0.722</span> <span class="fl">0.055</span> .</span>
<span id="cb118-14"><a href="chap17.html#cb118-14" tabindex="-1"></a>fdiseaseOther <span class="sc">-</span><span class="fl">0.076</span>   <span class="fl">0.766</span> <span class="fl">0.921</span>  </span>
<span id="cb118-15"><a href="chap17.html#cb118-15" tabindex="-1"></a><span class="sc">---</span></span>
<span id="cb118-16"><a href="chap17.html#cb118-16" tabindex="-1"></a>Signif. codes<span class="sc">:</span> <span class="dv">0</span> <span class="st">'***'</span> <span class="fl">0.001</span> <span class="st">'**'</span> <span class="fl">0.01</span> <span class="st">'*'</span> <span class="fl">0.05</span> <span class="st">'.'</span> <span class="fl">0.1</span> <span class="st">' '</span> <span class="dv">1</span></span></code></pre></div>
<p>根据该输出，在比较嵌套模型时使用的 <span class="math inline">\(−2 \log \hat L\)</span> 统计量为 <span class="math inline">\(−2(−591.709)=1183.418\)</span>，这也可以通过 <code>-2*logLik(f lung)</code> 来计算。此外，<code>theta</code> 是指脆弱性方差，即式 <a href="chap17.html#eq:17-2">(17.2)</a> 中 <span class="math inline">\(z_i\)</span> 的方差估计，<code>rho</code> 和 <code>lambda</code> 指定了 Weibull 基线风险中的形状和尺度参数。请注意，第 10 章表 10.3 中 <span class="math inline">\(\hat\lambda\)</span> 的值为 <span class="math inline">\(0.023/(30.441.304)=0.00027\)</span>。这些估计值后面是模型中项的系数估计，它与表 10.3 第四列中的条目一致。然而，由于生存时间进行了缩放，<span class="math inline">\(−2 \log \hat L\)</span> 的值有所不同。可以使用 <code>predict</code> 函数获得脆弱效应估计，即 <code>predict(f_lung)</code> 给出 gamma 脆弱的 196 个单独估计 <span class="math inline">\(\hat z_i\)</span>。通过将 <code>frailty=</code> 选项更改为 <code>frailty="lognormal"</code>，可得到表 10.3 第三列中的条目。</p>
<details><summary><font color="#8B2232">表 10.3</font>
</summary><img src="figure/table%2010.3.png#center" style="width:80.0%"></details>
</div>
<div id="sec17-11-2" class="section level3" number="17.11.2">
<h3>
<span class="header-section-number">17.11.2</span> 拟合具有共享脆弱性的参数脆弱模型<a class="anchor" aria-label="anchor" href="#sec17-11-2"><i class="fas fa-link"></i></a>
</h3>
<p>函数 <code>parfm</code> 也可用于拟合具有共享脆弱性的参数模型。其代码与个体脆弱性的代码非常相似，只是 <code>cluster=</code> 选项现在指定与具有共享脆弱性的个体组相关的变量。</p>
<p>作为说明，请考虑<a href="chap10.html#exm:ex10-4">示例 10.4</a> 中有关肾移植后的生存数据。在这里，一名肾脏供体可能会提供一或两个移植，因此两个受体可能有一个共同的供体，从而导致共享脆弱。以下代码用于输入数据、变换时间尺度并拟合具有 gamma 脆弱性的 Weibull 模型。</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="chap17.html#cb119-1" tabindex="-1"></a><span class="sc">&gt;</span> tplant<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival following kidney transplantation.dat"</span>,</span>
<span id="cb119-2"><a href="chap17.html#cb119-2" tabindex="-1"></a>                     <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb119-3"><a href="chap17.html#cb119-3" tabindex="-1"></a><span class="sc">&gt;</span> tplant<span class="sc">$</span>time1<span class="ot">&lt;-</span>tplant<span class="sc">$</span>time<span class="sc">/</span><span class="fl">30.44</span></span>
<span id="cb119-4"><a href="chap17.html#cb119-4" tabindex="-1"></a><span class="sc">&gt;</span> f_kidney<span class="ot">&lt;-</span><span class="fu">parfm</span>(<span class="fu">Surv</span>(time1,status) <span class="sc">~</span> age<span class="sc">+</span>cit<span class="sc">+</span>diabetes,</span>
<span id="cb119-5"><a href="chap17.html#cb119-5" tabindex="-1"></a>                  <span class="at">cluster=</span><span class="st">"donor"</span>,<span class="at">dist=</span><span class="st">"weibull"</span>,<span class="at">frailty=</span><span class="st">"gamma"</span>,<span class="at">data=</span>tplant)</span></code></pre></div>
<p>使用 <code>print(f_kidney)</code> 得到以下输出。</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="chap17.html#cb120-1" tabindex="-1"></a>Frailty distribution<span class="sc">:</span> gamma </span>
<span id="cb120-2"><a href="chap17.html#cb120-2" tabindex="-1"></a>Baseline hazard distribution<span class="sc">:</span> Weibull </span>
<span id="cb120-3"><a href="chap17.html#cb120-3" tabindex="-1"></a>Loglikelihood<span class="sc">:</span> <span class="sc">-</span><span class="fl">433.31</span> </span>
<span id="cb120-4"><a href="chap17.html#cb120-4" tabindex="-1"></a></span>
<span id="cb120-5"><a href="chap17.html#cb120-5" tabindex="-1"></a>         ESTIMATE SE    p<span class="sc">-</span>val  </span>
<span id="cb120-6"><a href="chap17.html#cb120-6" tabindex="-1"></a>theta     <span class="fl">0.421</span>   <span class="fl">0.620</span>        </span>
<span id="cb120-7"><a href="chap17.html#cb120-7" tabindex="-1"></a>rho       <span class="fl">0.602</span>   <span class="fl">0.068</span>        </span>
<span id="cb120-8"><a href="chap17.html#cb120-8" tabindex="-1"></a>lambda    <span class="fl">0.005</span>   <span class="fl">0.002</span>        </span>
<span id="cb120-9"><a href="chap17.html#cb120-9" tabindex="-1"></a>age       <span class="fl">0.019</span>   <span class="fl">0.008</span> <span class="fl">0.013</span> <span class="sc">*</span></span>
<span id="cb120-10"><a href="chap17.html#cb120-10" tabindex="-1"></a>cit       <span class="fl">0.024</span>   <span class="fl">0.020</span> <span class="fl">0.229</span>  </span>
<span id="cb120-11"><a href="chap17.html#cb120-11" tabindex="-1"></a>diabetes <span class="sc">-</span><span class="fl">0.258</span>   <span class="fl">0.458</span> <span class="fl">0.573</span>  </span>
<span id="cb120-12"><a href="chap17.html#cb120-12" tabindex="-1"></a><span class="sc">---</span></span>
<span id="cb120-13"><a href="chap17.html#cb120-13" tabindex="-1"></a>Signif. codes<span class="sc">:</span> <span class="dv">0</span> <span class="st">'***'</span> <span class="fl">0.001</span> <span class="st">'**'</span> <span class="fl">0.01</span> <span class="st">'*'</span> <span class="fl">0.05</span> <span class="st">'.'</span> <span class="fl">0.1</span> <span class="st">' '</span> <span class="dv">1</span></span>
<span id="cb120-14"><a href="chap17.html#cb120-14" tabindex="-1"></a></span>
<span id="cb120-15"><a href="chap17.html#cb120-15" tabindex="-1"></a>Kendall<span class="st">'s Tau: 0.174 </span></span></code></pre></div>
<p>该输出的解释与个体脆弱模型的解释相同。然而，由于生存时间的缩放，对数似然值再次与<a href="chap10.html#exm:ex10-4">示例 10.4</a> 中引用的值不同。gamma 脆弱的拟合模型的输出还包括 Kendall’s <span class="math inline">\(\tau\)</span> 统计量，这是一种生存时间对之间关联的度量，参见第 10 章 <a href="chap10.html#sec10-8">10.8</a> 节。类似的代码可以用于拟合参数分布和脆弱性分布的其他组合。</p>
</div>
<div id="sec17-11-3" class="section level3" number="17.11.3">
<h3>
<span class="header-section-number">17.11.3</span> 拟合具有个体 lognormal 脆弱性的半参数模型<a class="anchor" aria-label="anchor" href="#sec17-11-3"><i class="fas fa-link"></i></a>
</h3>
<p>使用同名包中的 <code>coxme</code> 函数可以为生存数据拟合具有 lognormal 脆弱项的模型。该函数使用惩罚偏似然法来拟合包含脆弱效应的模型，如第 10 章 <a href="chap10.html#sec10-5">10.5</a> 节所述。</p>
<p>再次考虑等待肺移植期间生存时间的数据。第 <a href="chap17.html#sec17-11-1">17.11.1</a> 节使用的 <code>lung</code> 数据框架包含以性别和疾病集为因子的数据。此分析将使用以天为单位的生存时间。为了拟合 Cox 回归模型，该模型包含 <span class="math inline">\(Age,Sex,BMI\)</span> 和 <span class="math inline">\(Disease\)</span>，以及假设具有 lognormal 分布的患者的个体脆弱效应 <span class="math inline">\(z_i\)</span>，使用如下代码来完成。</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="chap17.html#cb121-1" tabindex="-1"></a><span class="sc">&gt;</span> lnfcox<span class="ot">&lt;-</span><span class="fu">coxme</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> fgender<span class="sc">+</span>age<span class="sc">+</span>bmi<span class="sc">+</span>fdisease<span class="sc">+</span></span>
<span id="cb121-2"><a href="chap17.html#cb121-2" tabindex="-1"></a>                  (<span class="dv">1</span><span class="sc">|</span>patient),<span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>lung)</span></code></pre></div>
<p>在该代码中，通过在模型公式中添加 <code>(1|patient)</code> 来指定脆弱项，并且脆弱变量自动假定为一个因子。使用 <code>summary(lnfcox)</code> 可得到以下输出。</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="chap17.html#cb122-1" tabindex="-1"></a>Mixed effects coxme model</span>
<span id="cb122-2"><a href="chap17.html#cb122-2" tabindex="-1"></a> Formula<span class="sc">:</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> fgender <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> fdisease <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> patient) </span>
<span id="cb122-3"><a href="chap17.html#cb122-3" tabindex="-1"></a>    Data<span class="sc">:</span> lung </span>
<span id="cb122-4"><a href="chap17.html#cb122-4" tabindex="-1"></a></span>
<span id="cb122-5"><a href="chap17.html#cb122-5" tabindex="-1"></a>  events, n <span class="ot">=</span> <span class="dv">123</span>, <span class="dv">196</span></span>
<span id="cb122-6"><a href="chap17.html#cb122-6" tabindex="-1"></a></span>
<span id="cb122-7"><a href="chap17.html#cb122-7" tabindex="-1"></a>Random effects<span class="sc">:</span></span>
<span id="cb122-8"><a href="chap17.html#cb122-8" tabindex="-1"></a>    group  variable        sd  variance</span>
<span id="cb122-9"><a href="chap17.html#cb122-9" tabindex="-1"></a><span class="dv">1</span> patient Intercept <span class="fl">0.7227754</span> <span class="fl">0.5224043</span></span>
<span id="cb122-10"><a href="chap17.html#cb122-10" tabindex="-1"></a>                   Chisq    df         p   AIC     BIC</span>
<span id="cb122-11"><a href="chap17.html#cb122-11" tabindex="-1"></a>Integrated loglik  <span class="fl">17.75</span>  <span class="fl">7.00</span> <span class="fl">1.314e-02</span>  <span class="fl">3.75</span>  <span class="sc">-</span><span class="fl">15.93</span></span>
<span id="cb122-12"><a href="chap17.html#cb122-12" tabindex="-1"></a> Penalized loglik <span class="fl">116.62</span> <span class="fl">49.59</span> <span class="fl">2.532e-07</span> <span class="fl">17.44</span> <span class="sc">-</span><span class="fl">122.02</span></span>
<span id="cb122-13"><a href="chap17.html#cb122-13" tabindex="-1"></a></span>
<span id="cb122-14"><a href="chap17.html#cb122-14" tabindex="-1"></a>Fixed effects<span class="sc">:</span></span>
<span id="cb122-15"><a href="chap17.html#cb122-15" tabindex="-1"></a>                  coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)     z     p</span>
<span id="cb122-16"><a href="chap17.html#cb122-16" tabindex="-1"></a>fgendermale    <span class="fl">0.11401</span>   <span class="fl">1.12076</span>  <span class="fl">0.23180</span>  <span class="fl">0.49</span> <span class="fl">0.623</span></span>
<span id="cb122-17"><a href="chap17.html#cb122-17" tabindex="-1"></a>age            <span class="fl">0.01209</span>   <span class="fl">1.01217</span>  <span class="fl">0.01312</span>  <span class="fl">0.92</span> <span class="fl">0.357</span></span>
<span id="cb122-18"><a href="chap17.html#cb122-18" tabindex="-1"></a>bmi           <span class="sc">-</span><span class="fl">0.02555</span>   <span class="fl">0.97477</span>  <span class="fl">0.02839</span> <span class="sc">-</span><span class="fl">0.90</span> <span class="fl">0.368</span></span>
<span id="cb122-19"><a href="chap17.html#cb122-19" tabindex="-1"></a>fdiseaseCOPD  <span class="sc">-</span><span class="fl">0.68092</span>   <span class="fl">0.50615</span>  <span class="fl">0.42471</span> <span class="sc">-</span><span class="fl">1.60</span> <span class="fl">0.109</span></span>
<span id="cb122-20"><a href="chap17.html#cb122-20" tabindex="-1"></a>fdiseaseFib    <span class="fl">0.55321</span>   <span class="fl">1.73882</span>  <span class="fl">0.39815</span>  <span class="fl">1.39</span> <span class="fl">0.165</span></span>
<span id="cb122-21"><a href="chap17.html#cb122-21" tabindex="-1"></a>fdiseaseOther <span class="sc">-</span><span class="fl">0.19793</span>   <span class="fl">0.82043</span>  <span class="fl">0.44819</span> <span class="sc">-</span><span class="fl">0.44</span> <span class="fl">0.659</span></span></code></pre></div>
<p>该输出的第一部分给出了三个对数似然值，展示为 <code>NULL</code>, <code>Integrated</code> 和 <code>Fitted</code>。零对数似然是指不包含解释变量或脆弱性的模型。这只是 Cox 回归模型的最大化偏对数似然，该模型对每个个体具有相同的基线风险函数 <span class="math inline">\(h_0(t)\)</span>。积分对数似然是第 10 章式 <a href="chap10.html#eq:10-28">(10.28)</a> 给出的最大化边际对数似然 <span class="math inline">\(\log L_m(\hat{\boldsymbol{\beta}},\hat{\sigma}_u^2)\)</span>。拟合对数似然是从式 <a href="chap10.html#eq:10-25">(10.25)</a> 获得的拟合模型的最大偏对数似然 <span class="math inline">\(\log L_p(\boldsymbol{\hat{\beta}},\hat{\boldsymbol{u}})\)</span>。在这三个对数似然值中，积分对数似然是最有用的，因为它用于比较替代模型。</p>
<p>输出的下一部分中 <code>Integrated loglik</code> 所在行 给出了卡方值，用于将积分对数似然与零模型的对数似然进行比较。即，<span class="math inline">\(2(587.616−578.74)=17.75\)</span>。标记为 <code>Penalized loglik</code> 的行将拟合或最大化偏对数似然与零模型的似然进行比较，即 <span class="math inline">\(2(587.616−529.304)=116.62\)</span>。自由度是指拟合模型中独立参数的有效数。最大化偏对数似然包括随机效应的估计 <span class="math inline">\(\hat {\boldsymbol u}\)</span>，而它们已经从边际对数似然性函数中积分出来。这解释了与两个检验相关的有效自由度数的差异。标记为 <code>AIC</code> 和 <code>BIC</code> 值的列中的 AIC 和 BIC 统计量是根据 <code>Chisq</code> 值计算通过减去自由度的两倍或 <span class="math inline">\(q \log d\)</span>，其中 <span class="math inline">\(q\)</span> 是自由度，<span class="math inline">\(d\)</span> 是事件数。当关注于替代模型的比较时，这些统计量的用途有限。</p>
<p>输出的下一部分给出了参数估计、风险比、标准误、<span class="math inline">\(z\)</span> 以及检验系数为零的假设的 <span class="math inline">\(P\)</span> 值。接下来是对模型中随机效应项的标准差和方差的估计，即 <span class="math inline">\(\widehat{\text{var }}(u_i)\)</span>。</p>
<p>一旦拟合了脆弱模型，就可以使用 <code>coxme</code> 对象来提取一些量的值。例如，如 <a href="chap10.html#sec10-4">10.4</a> 节所述，<code>lnfcox$wear</code> 给出了个体脆弱性估计，可用于识别更脆弱的个体的群体。当使用 <code>lnfcox$loglik</code> 来产生最大化对数似然时，可获得以下输出。</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="chap17.html#cb123-1" tabindex="-1"></a>     <span class="cn">NULL</span> Integrated Penalized</span>
<span id="cb123-2"><a href="chap17.html#cb123-2" tabindex="-1"></a><span class="sc">-</span><span class="fl">587.6156</span>  <span class="sc">-</span><span class="fl">578.7399</span> <span class="sc">-</span><span class="fl">552.1309</span></span></code></pre></div>
<p>这里，<code>Penalized log-likelihood</code> 是拟合模型的惩罚偏对数似然的最大值，即式 <a href="chap10.html#eq:10-27">(10.27)</a> 中的 <span class="math inline">\(\log\hat{L}_{pen}(\hat{\boldsymbol{\beta}},\hat{\boldsymbol{u}},\hat{\sigma}_u^2)\)</span>。这是通过从最大化偏对数似然 <span class="math inline">\(\log L_p(\hat{\boldsymbol{\beta}},\hat{\boldsymbol{u}})\)</span> 中减去惩罚项 <span class="math inline">\((2\hat{\sigma}_u^2)^{-1}\sum_i\hat{u}_i^2\)</span> 来计算的。该惩罚函数的值可使用 <code>lnfcox$penalty</code> 得出，为 22.8272，因此，如所给出的，最大化惩罚对数似然为 <span class="math inline">\(−529.3037−22.8272=−552.1309\)</span>。</p>
</div>
<div id="sec17-11-4" class="section level3" number="17.11.4">
<h3>
<span class="header-section-number">17.11.4</span> 拟合具有个体 gamma 脆弱性的半参数模型<a class="anchor" aria-label="anchor" href="#sec17-11-4"><i class="fas fa-link"></i></a>
</h3>
<p>具有 gamma 脆弱性分布的模型不能使用 <code>coxme</code> 拟合，但 <code>survival</code> 包中的 <code>frailty</code> 函数可与 <code>coxph</code> 一起使用，以纳入 gamma 脆弱效应。下面给出了为登记进行肺移植的患者的生存时间数据拟合具有 gamma 脆弱性的 Cox 回归模型的 R 代码。</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="chap17.html#cb124-1" tabindex="-1"></a><span class="sc">&gt;</span> gfcox<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> fgender<span class="sc">+</span>age<span class="sc">+</span>bmi<span class="sc">+</span>fdisease<span class="sc">+</span></span>
<span id="cb124-2"><a href="chap17.html#cb124-2" tabindex="-1"></a>                 <span class="fu">frailty.gamma</span>(patient),<span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>lung)</span></code></pre></div>
<p>在这里，通过将 <code>frailty</code> 函数添加到模型公式中来指定脆弱项，<code>summary(gfcox)</code> 将产生以下输出。</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="chap17.html#cb125-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb125-2"><a href="chap17.html#cb125-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> fgender <span class="sc">+</span> age <span class="sc">+</span> bmi <span class="sc">+</span> fdisease <span class="sc">+</span> </span>
<span id="cb125-3"><a href="chap17.html#cb125-3" tabindex="-1"></a>    <span class="fu">frailty.gamma</span>(patient), <span class="at">data =</span> lung, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb125-4"><a href="chap17.html#cb125-4" tabindex="-1"></a></span>
<span id="cb125-5"><a href="chap17.html#cb125-5" tabindex="-1"></a>  n<span class="ot">=</span> <span class="dv">196</span>, number of events<span class="ot">=</span> <span class="dv">123</span> </span>
<span id="cb125-6"><a href="chap17.html#cb125-6" tabindex="-1"></a></span>
<span id="cb125-7"><a href="chap17.html#cb125-7" tabindex="-1"></a>                       coef     <span class="fu">se</span>(coef)</span>
<span id="cb125-8"><a href="chap17.html#cb125-8" tabindex="-1"></a>fgendermale             <span class="fl">0.30599</span> <span class="fl">0.35412</span> </span>
<span id="cb125-9"><a href="chap17.html#cb125-9" tabindex="-1"></a>age                     <span class="fl">0.00557</span> <span class="fl">0.01812</span> </span>
<span id="cb125-10"><a href="chap17.html#cb125-10" tabindex="-1"></a>bmi                    <span class="sc">-</span><span class="fl">0.02430</span> <span class="fl">0.04257</span> </span>
<span id="cb125-11"><a href="chap17.html#cb125-11" tabindex="-1"></a>fdiseaseCOPD           <span class="sc">-</span><span class="fl">0.88837</span> <span class="fl">0.60317</span> </span>
<span id="cb125-12"><a href="chap17.html#cb125-12" tabindex="-1"></a>fdiseaseFib             <span class="fl">1.22698</span> <span class="fl">0.60721</span> </span>
<span id="cb125-13"><a href="chap17.html#cb125-13" tabindex="-1"></a>fdiseaseOther          <span class="sc">-</span><span class="fl">0.08851</span> <span class="fl">0.66758</span> </span>
<span id="cb125-14"><a href="chap17.html#cb125-14" tabindex="-1"></a><span class="fu">frailty.gamma</span>(patient)                  </span>
<span id="cb125-15"><a href="chap17.html#cb125-15" tabindex="-1"></a>                       se2     Chisq </span>
<span id="cb125-16"><a href="chap17.html#cb125-16" tabindex="-1"></a>fgendermale            <span class="fl">0.23434</span>   <span class="fl">0.75</span></span>
<span id="cb125-17"><a href="chap17.html#cb125-17" tabindex="-1"></a>age                    <span class="fl">0.01198</span>   <span class="fl">0.09</span></span>
<span id="cb125-18"><a href="chap17.html#cb125-18" tabindex="-1"></a>bmi                    <span class="fl">0.02786</span>   <span class="fl">0.33</span></span>
<span id="cb125-19"><a href="chap17.html#cb125-19" tabindex="-1"></a>fdiseaseCOPD           <span class="fl">0.40313</span>   <span class="fl">2.17</span></span>
<span id="cb125-20"><a href="chap17.html#cb125-20" tabindex="-1"></a>fdiseaseFib            <span class="fl">0.39557</span>   <span class="fl">4.08</span></span>
<span id="cb125-21"><a href="chap17.html#cb125-21" tabindex="-1"></a>fdiseaseOther          <span class="fl">0.43458</span>   <span class="fl">0.02</span></span>
<span id="cb125-22"><a href="chap17.html#cb125-22" tabindex="-1"></a><span class="fu">frailty.gamma</span>(patient)         <span class="fl">243.82</span></span>
<span id="cb125-23"><a href="chap17.html#cb125-23" tabindex="-1"></a>                       DF    p      </span>
<span id="cb125-24"><a href="chap17.html#cb125-24" tabindex="-1"></a>fgendermale              <span class="fl">1.0</span> <span class="fl">3.9e-01</span></span>
<span id="cb125-25"><a href="chap17.html#cb125-25" tabindex="-1"></a>age                      <span class="fl">1.0</span> <span class="fl">7.6e-01</span></span>
<span id="cb125-26"><a href="chap17.html#cb125-26" tabindex="-1"></a>bmi                      <span class="fl">1.0</span> <span class="fl">5.7e-01</span></span>
<span id="cb125-27"><a href="chap17.html#cb125-27" tabindex="-1"></a>fdiseaseCOPD             <span class="fl">1.0</span> <span class="fl">1.4e-01</span></span>
<span id="cb125-28"><a href="chap17.html#cb125-28" tabindex="-1"></a>fdiseaseFib              <span class="fl">1.0</span> <span class="fl">4.3e-02</span></span>
<span id="cb125-29"><a href="chap17.html#cb125-29" tabindex="-1"></a>fdiseaseOther            <span class="fl">1.0</span> <span class="fl">8.9e-01</span></span>
<span id="cb125-30"><a href="chap17.html#cb125-30" tabindex="-1"></a><span class="fu">frailty.gamma</span>(patient) <span class="fl">120.5</span> <span class="fl">2.2e-10</span></span>
<span id="cb125-31"><a href="chap17.html#cb125-31" tabindex="-1"></a></span>
<span id="cb125-32"><a href="chap17.html#cb125-32" tabindex="-1"></a>              <span class="fu">exp</span>(coef) <span class="fu">exp</span>(<span class="sc">-</span>coef)</span>
<span id="cb125-33"><a href="chap17.html#cb125-33" tabindex="-1"></a>fgendermale      <span class="fl">1.3580</span>     <span class="fl">0.7364</span></span>
<span id="cb125-34"><a href="chap17.html#cb125-34" tabindex="-1"></a>age              <span class="fl">1.0056</span>     <span class="fl">0.9944</span></span>
<span id="cb125-35"><a href="chap17.html#cb125-35" tabindex="-1"></a>bmi              <span class="fl">0.9760</span>     <span class="fl">1.0246</span></span>
<span id="cb125-36"><a href="chap17.html#cb125-36" tabindex="-1"></a>fdiseaseCOPD     <span class="fl">0.4113</span>     <span class="fl">2.4312</span></span>
<span id="cb125-37"><a href="chap17.html#cb125-37" tabindex="-1"></a>fdiseaseFib      <span class="fl">3.4109</span>     <span class="fl">0.2932</span></span>
<span id="cb125-38"><a href="chap17.html#cb125-38" tabindex="-1"></a>fdiseaseOther    <span class="fl">0.9153</span>     <span class="fl">1.0925</span></span>
<span id="cb125-39"><a href="chap17.html#cb125-39" tabindex="-1"></a>              lower .<span class="dv">95</span> upper .<span class="dv">95</span></span>
<span id="cb125-40"><a href="chap17.html#cb125-40" tabindex="-1"></a>fgendermale      <span class="fl">0.6784</span>     <span class="fl">2.718</span></span>
<span id="cb125-41"><a href="chap17.html#cb125-41" tabindex="-1"></a>age              <span class="fl">0.9705</span>     <span class="fl">1.042</span></span>
<span id="cb125-42"><a href="chap17.html#cb125-42" tabindex="-1"></a>bmi              <span class="fl">0.8979</span>     <span class="fl">1.061</span></span>
<span id="cb125-43"><a href="chap17.html#cb125-43" tabindex="-1"></a>fdiseaseCOPD     <span class="fl">0.1261</span>     <span class="fl">1.342</span></span>
<span id="cb125-44"><a href="chap17.html#cb125-44" tabindex="-1"></a>fdiseaseFib      <span class="fl">1.0376</span>    <span class="fl">11.213</span></span>
<span id="cb125-45"><a href="chap17.html#cb125-45" tabindex="-1"></a>fdiseaseOther    <span class="fl">0.2474</span>     <span class="fl">3.387</span></span>
<span id="cb125-46"><a href="chap17.html#cb125-46" tabindex="-1"></a></span>
<span id="cb125-47"><a href="chap17.html#cb125-47" tabindex="-1"></a>Iterations<span class="sc">:</span> <span class="dv">6</span> outer, <span class="dv">68</span> Newton<span class="sc">-</span>Raphson</span>
<span id="cb125-48"><a href="chap17.html#cb125-48" tabindex="-1"></a>     Variance of random effect<span class="ot">=</span> <span class="fl">2.154654</span>   I<span class="sc">-</span>likelihood <span class="ot">=</span> <span class="sc">-</span><span class="fl">576.7</span> </span>
<span id="cb125-49"><a href="chap17.html#cb125-49" tabindex="-1"></a>Degrees of freedom <span class="cf">for</span> terms<span class="ot">=</span>   <span class="fl">0.4</span>   <span class="fl">0.4</span>   <span class="fl">0.4</span>   <span class="fl">1.4</span> <span class="fl">120.5</span> </span>
<span id="cb125-50"><a href="chap17.html#cb125-50" tabindex="-1"></a>Concordance<span class="ot">=</span> <span class="fl">0.944</span>  (<span class="at">se =</span> <span class="fl">0.008</span> )</span>
<span id="cb125-51"><a href="chap17.html#cb125-51" tabindex="-1"></a>Likelihood ratio test<span class="ot">=</span> <span class="fl">304.5</span>  on <span class="fl">123.2</span> df,   p<span class="ot">=</span><span class="er">&lt;</span><span class="fl">2e-16</span></span></code></pre></div>
<p>该输出给出了模型中项的系数估计及其标准误、计算为 <span class="math inline">\(\{(\hat{\beta}/\sec{(\hat{\beta})}\}^2\)</span> 的卡方统计量以及相应的 <span class="math inline">\(P\)</span> 值。标记为 <code>se2</code> 的量是对标准误的稳健估计，该标准误解释了模型指定中的不确定性。系数的指数，即风险比，也与 95% 的区间估计一起给出。</p>
<p>标记为 <code>frailty.gamma(patient)</code> 的行给出了无脆弱性假设的卡方检验统计量。概括地说，这基于计算为 <span class="math inline">\(\hat{\boldsymbol{u}}^{\prime}\boldsymbol{V}^{-1}(\hat{\boldsymbol{u}})\hat{\boldsymbol{u}}\)</span> 的 Wald 检验统计量，其中 <span class="math inline">\(\boldsymbol{V}(\hat{\boldsymbol{u}})\)</span> 为向量 <span class="math inline">\(\widehat{\boldsymbol{u}}\)</span> 中脆弱性估计的方差-协方差阵，这是从惩罚偏对数似然的二阶导数矩阵中获得的，如附录 <a href="A.html#A">A</a> 所述。</p>
<p>给出拟合模型所需迭代次数的信息后，给出了随机效应的方差估计，即 <span class="math inline">\(\widehat{\text{var}} \left ( u _ i \right )\)</span>。同一行中是拟合模型的积分或边际对数似然，标记为 <code>I-likelihood</code>。将其乘以 −2 后，即为用于将替代模型与伽玛脆弱性进行比较的 <span class="math inline">\(−2 \log \hat L\)</span> 统计量。似然函数的值包括第 10 章 <a href="chap10.html#sec10-5">10.5</a> 节末尾提到的额外项 <span class="math inline">\(\sum_{i=1}^n\delta_i\)</span>，因此可以更容易地将具有脆弱性的模型与没有脆弱性的模型进行比较。之后给出了模型中每个项（包括随机效应）的有效自由度数，然后是一致性估计，该一致性通过第 3 章 <a href="cox-%E5%9B%9E%E5%BD%92%E6%A8%A1%E5%9E%8B.html#sec3-12-1">3.12.1</a> 节中描述的 <span class="math inline">\(c\)</span> 统计量来度量。标记为 <code>Likelihood ratio</code> 的统计量将拟合模型与零模型进行比较，其中拟合模型的似然是 在 <span class="math inline">\(\beta\)</span> 和脆弱效应 <span class="math inline">\(u_i\)</span> 估计处的最大化偏对数似然，但不包含惩罚项，即 <span class="math inline">\(\log L_p(\hat{\boldsymbol{\beta}},\hat{\boldsymbol{u}})\)</span>，以第 <a href="chap10.html#sec10-5">10.5</a> 节表示法。</p>
<p>以 <code>frailty.gaussian(patient)</code> 形式的 <code>frailty</code> 函数也可以用于向模型中添加 lognormal 脆弱性。尽管通常认为 <code>coxme</code> 函数更可靠，但这两种方法往往产生相似的结果。</p>
</div>
<div id="sec17-11-5" class="section level3" number="17.11.5">
<h3>
<span class="header-section-number">17.11.5</span> 拟合具有共享脆弱性的半参数模型<a class="anchor" aria-label="anchor" href="#sec17-11-5"><i class="fas fa-link"></i></a>
</h3>
<p>R 函数 <code>coxme</code> 以及带 <code>frailty.gamma</code> 的 <code>coxph</code> 可分别用于对共享 lognormal 和 gamma 脆弱性进行建模。该代码与上一节中描述的个体对若行的代码非常相似。现用肾移植后的生存数据，以说明参数共享脆弱模型。以下代码使用函数 <code>coxme</code> 来拟合供体效应的 lognormal 脆弱性</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="chap17.html#cb126-1" tabindex="-1"></a><span class="sc">&gt;</span> slnfcox<span class="ot">&lt;-</span><span class="fu">coxme</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> age<span class="sc">+</span>cit<span class="sc">+</span>diabetes<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>donor),</span>
<span id="cb126-2"><a href="chap17.html#cb126-2" tabindex="-1"></a>                 <span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>tplant)</span></code></pre></div>
<p><code>summary(slnfcox)</code> 得到以下输出。</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="chap17.html#cb127-1" tabindex="-1"></a>Mixed effects coxme model</span>
<span id="cb127-2"><a href="chap17.html#cb127-2" tabindex="-1"></a> Formula<span class="sc">:</span> <span class="fu">Surv</span>(time, status) <span class="sc">~</span> age <span class="sc">+</span> cit <span class="sc">+</span> diabetes <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> donor) </span>
<span id="cb127-3"><a href="chap17.html#cb127-3" tabindex="-1"></a>    Data<span class="sc">:</span> tplant </span>
<span id="cb127-4"><a href="chap17.html#cb127-4" tabindex="-1"></a></span>
<span id="cb127-5"><a href="chap17.html#cb127-5" tabindex="-1"></a>  events, n <span class="ot">=</span> <span class="dv">71</span>, <span class="dv">434</span></span>
<span id="cb127-6"><a href="chap17.html#cb127-6" tabindex="-1"></a></span>
<span id="cb127-7"><a href="chap17.html#cb127-7" tabindex="-1"></a>Random effects<span class="sc">:</span></span>
<span id="cb127-8"><a href="chap17.html#cb127-8" tabindex="-1"></a>  group  variable        sd variance</span>
<span id="cb127-9"><a href="chap17.html#cb127-9" tabindex="-1"></a><span class="dv">1</span> donor Intercept <span class="fl">0.5268985</span> <span class="fl">0.277622</span></span>
<span id="cb127-10"><a href="chap17.html#cb127-10" tabindex="-1"></a>                  Chisq    df        p   AIC    BIC</span>
<span id="cb127-11"><a href="chap17.html#cb127-11" tabindex="-1"></a>Integrated loglik  <span class="fl">5.44</span>  <span class="fl">4.00</span> <span class="fl">0.245290</span> <span class="sc">-</span><span class="fl">2.56</span> <span class="sc">-</span><span class="fl">11.61</span></span>
<span id="cb127-12"><a href="chap17.html#cb127-12" tabindex="-1"></a> Penalized loglik <span class="fl">42.36</span> <span class="fl">20.92</span> <span class="fl">0.003677</span>  <span class="fl">0.51</span> <span class="sc">-</span><span class="fl">46.84</span></span>
<span id="cb127-13"><a href="chap17.html#cb127-13" tabindex="-1"></a></span>
<span id="cb127-14"><a href="chap17.html#cb127-14" tabindex="-1"></a>Fixed effects<span class="sc">:</span></span>
<span id="cb127-15"><a href="chap17.html#cb127-15" tabindex="-1"></a>             coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)     z      p</span>
<span id="cb127-16"><a href="chap17.html#cb127-16" tabindex="-1"></a>age       <span class="fl">0.01876</span>   <span class="fl">1.01894</span>  <span class="fl">0.01037</span>  <span class="fl">1.81</span> <span class="fl">0.0706</span></span>
<span id="cb127-17"><a href="chap17.html#cb127-17" tabindex="-1"></a>cit       <span class="fl">0.02357</span>   <span class="fl">1.02385</span>  <span class="fl">0.02177</span>  <span class="fl">1.08</span> <span class="fl">0.2791</span></span>
<span id="cb127-18"><a href="chap17.html#cb127-18" tabindex="-1"></a>diabetes <span class="sc">-</span><span class="fl">0.25418</span>   <span class="fl">0.77555</span>  <span class="fl">0.44938</span> <span class="sc">-</span><span class="fl">0.57</span> <span class="fl">0.5716</span></span></code></pre></div>
<p>该输出与使用 <code>coxme</code> 拟合的个体脆弱性模型的格式相同，并且与第 10 章<a href="chap10.html#exm:ex10-4">示例 10.4</a> 中给出的结果一致。</p>
<p>带 <code>frailty.gamma</code> 函数的函数 <code>coxph</code> 用于拟合具有共享 gamma 脆弱性的模型，使用</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="chap17.html#cb128-1" tabindex="-1"></a><span class="sc">&gt;</span> sgfcox<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> age<span class="sc">+</span>cit<span class="sc">+</span>diabetes<span class="sc">+</span></span>
<span id="cb128-2"><a href="chap17.html#cb128-2" tabindex="-1"></a>                  <span class="fu">frailty.gamma</span>(donor),<span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>tplant)</span></code></pre></div>
<p>模型中解释变量系数的估计结果与使用具有 lognormal 脆弱性的半参数模型时发现的结果非常相似。</p>
</div>
</div>
<div id="sec17-12" class="section level2" number="17.12">
<h2>
<span class="header-section-number">17.12</span> 竞争风险<a class="anchor" aria-label="anchor" href="#sec17-12"><i class="fas fa-link"></i></a>
</h2>
<p>竞争风险模型用于研究中的个体可能经历多个不同终点之一的情况，并在第 <a href="chap12.html#chap12">12</a> 章进行了描述。在本节中，使用 R 来估计累积发生率函数。并拟合原因别风险和原因别发生率的模型。第 12 章<a href="chap12.html#exm:ex12-1">示例 12.1</a> 中描述的肝移植后移植失效时间的数据将用于说明 R 代码和输出。在此数据集中，许多患者的移植失效时间删失，有四个潜在的致命终点，即排异、血栓形成、疾病复发和其他原因。在数据集中，与失效原因相关的变量分别编码为 0, 1, 2, 3 和 4. 数据被输入到 R 数据框架中，性别和肝病都被设为因子，女性和酒精性肝病作为参考水平，这些使用如下代码完成。</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="chap17.html#cb129-1" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Survival of liver transplant recipients.dat"</span>, <span class="at">header=</span><span class="cn">TRUE</span>) </span>
<span id="cb129-2"><a href="chap17.html#cb129-2" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="sc">$</span>fdisease<span class="ot">&lt;-</span><span class="fu">factor</span>(liver<span class="sc">$</span>disease) </span>
<span id="cb129-3"><a href="chap17.html#cb129-3" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">levels</span>(liver<span class="sc">$</span>fdisease)<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"PBC"</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">"PSC"</span><span class="ot">=</span><span class="dv">2</span>,<span class="st">"ALD"</span><span class="ot">=</span><span class="dv">3</span>) </span>
<span id="cb129-4"><a href="chap17.html#cb129-4" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="sc">$</span>fdisease<span class="ot">&lt;-</span><span class="fu">relevel</span>(liver<span class="sc">$</span>fdisease,<span class="at">ref=</span><span class="dv">3</span>) </span>
<span id="cb129-5"><a href="chap17.html#cb129-5" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="sc">$</span>fgender<span class="ot">&lt;-</span><span class="fu">factor</span>(liver<span class="sc">$</span>gender) </span>
<span id="cb129-6"><a href="chap17.html#cb129-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">levels</span>(liver<span class="sc">$</span>fgender)<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"male"</span><span class="ot">=</span><span class="dv">1</span>,<span class="st">"female"</span><span class="ot">=</span><span class="dv">2</span>) </span>
<span id="cb129-7"><a href="chap17.html#cb129-7" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="sc">$</span>fgender<span class="ot">&lt;-</span><span class="fu">relevel</span>(liver<span class="sc">$</span>fgender,<span class="at">ref=</span><span class="dv">2</span>)</span></code></pre></div>
<div id="sec17-12-1" class="section level3" number="17.12.1">
<h3>
<span class="header-section-number">17.12.1</span> 原因别的风险函数的估计和建模<a class="anchor" aria-label="anchor" href="#sec17-12-1"><i class="fas fa-link"></i></a>
</h3>
<p>可以按照第 12 章 <a href="chap12.html#sec12-2">12.2</a> 节所述的方式，使用每种事件类型的生存函数来总结竞争风险数据。这包括依次使用每个失效原因的事件时间，将所有其他事件的时间视为删失，以提供原因别数 据。这可以通过创建一个新的变量来实现，该变量指示给定肝衰竭原因的事件时间是一个事件，而所有其他原因的事件时间都是删失的。例如，如果死因是血栓，则定义一个变量，对于 <code>liver</code> 数据框中变量 <code>cof</code> 等于 2 的观测，该变量为 1，否则为 0：</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="chap17.html#cb130-1" tabindex="-1"></a><span class="sc">&gt;</span> liver<span class="sc">$</span>status2<span class="ot">&lt;-</span><span class="fu">ifelse</span>(liver<span class="sc">$</span>cof<span class="sc">==</span><span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span></code></pre></div>
<p>然后可以在 <code>survfit</code> 函数中使用变量 <code>status2</code> 来获得生存函数估计。例如，当血栓形成是移植失效的原因时，每种肝病的生存函数的 Kaplan-Meier 估计使用如下代码获得。</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="chap17.html#cb131-1" tabindex="-1"></a><span class="sc">&gt;</span> km2<span class="ot">&lt;-</span><span class="fu">survfit</span>(<span class="fu">Surv</span>(time,status2) <span class="sc">~</span> fdisease,<span class="at">data=</span>liver)</span>
<span id="cb131-2"><a href="chap17.html#cb131-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">summary</span>(km2)</span></code></pre></div>
<p>随后，可以使用 <code>coxph</code> 函数拟合每种事件类型的风险的 Cox 回归模型，如 <a href="chap17.html#sec17-4">17.4</a> 节所述。例如，要获得第 12 章表 12.5 中的原因别风险比，在以血栓形成引起的移植失败为事件拟合 Cox 回归模型后，使用</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="chap17.html#cb132-1" tabindex="-1"></a><span class="sc">&gt;</span> crfit2<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(time,status2) <span class="sc">~</span> age<span class="sc">+</span>fgender<span class="sc">+</span>fdisease,</span>
<span id="cb132-2"><a href="chap17.html#cb132-2" tabindex="-1"></a>                <span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>liver)</span></code></pre></div>
<p>所得血栓形成的风险比如表 12.5 所示。移植失效的其他原因可以用类似的方式处理。</p>
<details><summary><font color="#8B2232">表 12.5</font>
</summary><img src="figure/table%2012.5.png#center" style="width:80.0%"></details>
</div>
<div id="sec17-12-2" class="section level3" number="17.12.2">
<h3>
<span class="header-section-number">17.12.2</span> 估计累计发生率函数<a class="anchor" aria-label="anchor" href="#sec17-12-2"><i class="fas fa-link"></i></a>
</h3>
<p><code>cmprsk</code> 包中的函数 <code>cuminc</code> 可用于估计原因别累积发生率函数，其中选项 <code>ftime=</code> 和 <code>fstatus=</code> 用于指定包含生存时间和状态指示符的变量。例如，为了获得血栓形成的总体累积发生率，使用以下命令。</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="chap17.html#cb133-1" tabindex="-1"></a><span class="sc">&gt;</span> cuminc2all<span class="ot">&lt;-</span><span class="fu">cuminc</span>(<span class="at">ftime=</span>liver<span class="sc">$</span>time,<span class="at">fstatus=</span>liver<span class="sc">$</span>status2)</span></code></pre></div>
<p>这可以扩展到为每个移植指示符提供累积发生率函数，使用 <code>group=</code> 选项指定分组变量，如</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="chap17.html#cb134-1" tabindex="-1"></a><span class="sc">&gt;</span> cuminc2<span class="ot">&lt;-</span><span class="fu">cuminc</span>(<span class="at">ftime=</span>liver<span class="sc">$</span>time,<span class="at">fstatus=</span>liver<span class="sc">$</span>status2,</span>
<span id="cb134-2"><a href="chap17.html#cb134-2" tabindex="-1"></a>                  <span class="at">group=</span>liver<span class="sc">$</span>fdisease)</span></code></pre></div>
<p>在此之后，例如，酒精性肝病的累积发病率和相应的时间点可以从变量 <code>cuminc2$"ALD 1"$est</code> 和 <code>cuminc2$"ALD1"$time</code> 中获得。这些可以分配变量名称，以便在进一步的分析或图形总结中使用。例如，可以使用<code>plot(cuminc2)</code> 获得累积发生率函数的图形，这类似于图 12.2.</p>
</div>
<div id="sec17-12-3" class="section level3" number="17.12.3">
<h3>
<span class="header-section-number">17.12.3</span> 累积发生率的 Fine and Gray 模型<a class="anchor" aria-label="anchor" href="#sec17-12-3"><i class="fas fa-link"></i></a>
</h3>
<p>第 12 章 <a href="chap12.html#sec12-5">12.5</a> 节中描述的 Fine and Gray 模型用于在存在竞争风险的情况下对事件的累积发生率进行建模。该模型可以使用 <code>cmprsk</code> 包中的函数 <code>crr</code> 进行拟合。该函数不允许指定模型公式，相反，必须提供一个包含解释变量值的矩阵，该矩阵将被包含在模型中。对于因子，需要定义指示变量，但可使用 <code>model.matrix</code> 函数来辅助。例如，函数 <code>model.matrix(~A+B)[,-1]</code> 将为两个因子 <code>A</code> 和 <code>B</code> 生成指示变量。最后的 <code>[,-1]</code> 会从函数的输出中移除一个常数项，以避免对指示变量进行过度参数化。</p>
<p>例如，对于肝移植后移植失败时间的数据，性别和肝病因素的指标变量的水平在 liver 数据框的 <code>fgender</code> 和 <code>fdisease</code> 列中，使用如下命令。</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="chap17.html#cb135-1" tabindex="-1"></a><span class="sc">&gt;</span> indvars<span class="ot">&lt;-</span><span class="fu">model.matrix</span>(<span class="sc">~</span>liver<span class="sc">$</span>fdisease<span class="sc">+</span>liver<span class="sc">$</span>fgender)[,<span class="sc">-</span><span class="dv">1</span>]</span></code></pre></div>
<p>患者的年龄也应包括在模型中，因此必须将其与 <code>indvars</code> 中的指标变量相结合，以给出包含年龄以及性别和疾病的指标变量的矩阵 <code>xvars</code>。生成的矩阵的列也被重命名。这些使用如下代码实现。</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="chap17.html#cb136-1" tabindex="-1"></a><span class="sc">&gt;</span> xvars<span class="ot">&lt;-</span><span class="fu">cbind</span>(liver<span class="sc">$</span>age,indvars)</span>
<span id="cb136-2"><a href="chap17.html#cb136-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">colnames</span>(xvars)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"age"</span>,<span class="st">"PBC"</span>,<span class="st">"PSC"</span>,<span class="st">"male"</span>)</span></code></pre></div>
<p>矩阵 <code>xvars</code> 的前 10 行如下所示。</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="chap17.html#cb137-1" tabindex="-1"></a>   age PBC PSC male</span>
<span id="cb137-2"><a href="chap17.html#cb137-2" tabindex="-1"></a><span class="dv">1</span>   <span class="dv">55</span>   <span class="dv">0</span>   <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb137-3"><a href="chap17.html#cb137-3" tabindex="-1"></a><span class="dv">2</span>   <span class="dv">63</span>   <span class="dv">1</span>   <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb137-4"><a href="chap17.html#cb137-4" tabindex="-1"></a><span class="dv">3</span>   <span class="dv">67</span>   <span class="dv">1</span>   <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb137-5"><a href="chap17.html#cb137-5" tabindex="-1"></a><span class="dv">4</span>   <span class="dv">58</span>   <span class="dv">0</span>   <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb137-6"><a href="chap17.html#cb137-6" tabindex="-1"></a><span class="dv">5</span>   <span class="dv">59</span>   <span class="dv">1</span>   <span class="dv">0</span>    <span class="dv">1</span></span>
<span id="cb137-7"><a href="chap17.html#cb137-7" tabindex="-1"></a><span class="dv">6</span>   <span class="dv">35</span>   <span class="dv">1</span>   <span class="dv">0</span>    <span class="dv">0</span></span>
<span id="cb137-8"><a href="chap17.html#cb137-8" tabindex="-1"></a><span class="dv">7</span>   <span class="dv">51</span>   <span class="dv">1</span>   <span class="dv">0</span>    <span class="dv">0</span></span>
<span id="cb137-9"><a href="chap17.html#cb137-9" tabindex="-1"></a><span class="dv">8</span>   <span class="dv">61</span>   <span class="dv">0</span>   <span class="dv">1</span>    <span class="dv">0</span></span>
<span id="cb137-10"><a href="chap17.html#cb137-10" tabindex="-1"></a><span class="dv">9</span>   <span class="dv">51</span>   <span class="dv">0</span>   <span class="dv">0</span>    <span class="dv">0</span></span>
<span id="cb137-11"><a href="chap17.html#cb137-11" tabindex="-1"></a><span class="dv">10</span>  <span class="dv">59</span>   <span class="dv">0</span>   <span class="dv">0</span>    <span class="dv">0</span></span></code></pre></div>
<p>由 <code>model.matrix</code> 函数生成的指标变量是这样的：如果疾病是 PBC（或 PSC），则 <code>PBC</code>（或 <code>PSC</code>）的值为 1，否则为 0；对于男性患者，<code>male</code> 的值为 1，否则为 0.</p>
<p>现在可用 <code>crr</code> 函数来拟合特定事件的累积发生率的模型。使用选项 <code>ftime=</code> 和 <code>fstatus=</code> 指定包含每个事件时间以及每种事件类型编码以及删失观测的变量。接下来，使用 <code>cov1=</code> 指定要包含在模型中的解释变量矩阵。可以使用 <code>cencode=</code> 选项指定删失时间的编码，<code>failcode=</code> 选项用于指定要建模的事件类型，所有其他事件都是竞争风险。在 <code>liver</code> 数据框中，变量 <code>cof</code> 包含事件编码，对于删失时间为 0，对于血栓形成为 2. 使用 <code>failcode=2</code> 指定要对血栓形成的发生率进行建模。选项 <code>cencode=0</code> 指定变量 <code>cof</code> 在删失时间为 0，但这是不必要的，因为这是默认值。</p>
<p>使用了以下 <code>crr</code> 函数调用，以对血栓形成发生率关于患者年龄、性别和原发性肝病的依赖性进行建模。</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cifit2</span><span class="op">&lt;-</span><span class="fu">crr</span><span class="op">(</span>ftime<span class="op">=</span><span class="va">liver</span><span class="op">$</span><span class="va">time</span>,fstatus<span class="op">=</span><span class="va">liver</span><span class="op">$</span><span class="va">cof</span>,cov1<span class="op">=</span><span class="va">xvars</span>,cencode<span class="op">=</span><span class="fl">0</span>,</span>
<span>            failcode<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>使用 <code>summary(cifit2)</code> 会生成以下输出。</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="chap17.html#cb139-1" tabindex="-1"></a>Competing Risks Regression</span>
<span id="cb139-2"><a href="chap17.html#cb139-2" tabindex="-1"></a></span>
<span id="cb139-3"><a href="chap17.html#cb139-3" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb139-4"><a href="chap17.html#cb139-4" tabindex="-1"></a><span class="fu">crr</span>(<span class="at">ftime =</span> liver<span class="sc">$</span>time, <span class="at">fstatus =</span> liver<span class="sc">$</span>cof, <span class="at">cov1 =</span> xvars, <span class="at">failcode =</span> <span class="dv">2</span>, </span>
<span id="cb139-5"><a href="chap17.html#cb139-5" tabindex="-1"></a>    <span class="at">cencode =</span> <span class="dv">0</span>)</span>
<span id="cb139-6"><a href="chap17.html#cb139-6" tabindex="-1"></a></span>
<span id="cb139-7"><a href="chap17.html#cb139-7" tabindex="-1"></a>        coef <span class="fu">exp</span>(coef) <span class="fu">se</span>(coef)      z p<span class="sc">-</span>value</span>
<span id="cb139-8"><a href="chap17.html#cb139-8" tabindex="-1"></a>age  <span class="sc">-</span><span class="fl">0.0233</span>     <span class="fl">0.977</span>   <span class="fl">0.0104</span> <span class="sc">-</span><span class="fl">2.246</span>   <span class="fl">0.025</span></span>
<span id="cb139-9"><a href="chap17.html#cb139-9" tabindex="-1"></a>PBC   <span class="fl">0.6057</span>     <span class="fl">1.833</span>   <span class="fl">0.2798</span>  <span class="fl">2.165</span>   <span class="fl">0.030</span></span>
<span id="cb139-10"><a href="chap17.html#cb139-10" tabindex="-1"></a>PSC   <span class="fl">0.4648</span>     <span class="fl">1.592</span>   <span class="fl">0.3086</span>  <span class="fl">1.506</span>   <span class="fl">0.130</span></span>
<span id="cb139-11"><a href="chap17.html#cb139-11" tabindex="-1"></a>male  <span class="fl">0.0760</span>     <span class="fl">1.079</span>   <span class="fl">0.2458</span>  <span class="fl">0.309</span>   <span class="fl">0.760</span></span>
<span id="cb139-12"><a href="chap17.html#cb139-12" tabindex="-1"></a></span>
<span id="cb139-13"><a href="chap17.html#cb139-13" tabindex="-1"></a>     <span class="fu">exp</span>(coef) <span class="fu">exp</span>(<span class="sc">-</span>coef)  <span class="fl">2.5</span><span class="sc">% 97.5%</span></span>
<span id="cb139-14"><a href="chap17.html#cb139-14" tabindex="-1"></a>age      <span class="fl">0.977</span>      <span class="fl">1.024</span> <span class="fl">0.957</span> <span class="fl">0.997</span></span>
<span id="cb139-15"><a href="chap17.html#cb139-15" tabindex="-1"></a>PBC      <span class="fl">1.833</span>      <span class="fl">0.546</span> <span class="fl">1.059</span> <span class="fl">3.171</span></span>
<span id="cb139-16"><a href="chap17.html#cb139-16" tabindex="-1"></a>PSC      <span class="fl">1.592</span>      <span class="fl">0.628</span> <span class="fl">0.869</span> <span class="fl">2.914</span></span>
<span id="cb139-17"><a href="chap17.html#cb139-17" tabindex="-1"></a>male     <span class="fl">1.079</span>      <span class="fl">0.927</span> <span class="fl">0.666</span> <span class="fl">1.747</span></span>
<span id="cb139-18"><a href="chap17.html#cb139-18" tabindex="-1"></a></span>
<span id="cb139-19"><a href="chap17.html#cb139-19" tabindex="-1"></a>Num. cases <span class="ot">=</span> <span class="dv">1761</span></span>
<span id="cb139-20"><a href="chap17.html#cb139-20" tabindex="-1"></a>Pseudo Log<span class="sc">-</span>likelihood <span class="ot">=</span> <span class="sc">-</span><span class="dv">528</span> </span>
<span id="cb139-21"><a href="chap17.html#cb139-21" tabindex="-1"></a>Pseudo likelihood ratio test <span class="ot">=</span> <span class="fl">9.28</span>  on <span class="dv">4</span> df,</span></code></pre></div>
<p>输出在很大程度上是不言自明的，并给出了模型中解释变量系数的估计、相应的子风险比 <code>exp(coeff)</code>、系数的标准误、<span class="math inline">\(z\)</span> 值和 <span class="math inline">\(P\)</span> 值。然后重复输出了子风险比，标记为 <code>2.5%</code> 和 <code>97.5%</code> 的两列是它们的 95% 置信限。这些对应于表 12.6 中 “Thrombosis”（血栓形成）栏中的值。随后是拟合模型的对数似然值。<code>Pseudo Log-likelihood</code> 是根据第 12 章式 <a href="chap12.html#eq:12-12">(12.12)</a> 获得的最大化偏对数似然，<code>Pseudo likelihood ratio test</code> 将其与零模型（即没有解释变量的模型）进行比较。</p>
<p>可以从 <code>crr</code> 对象 <code>cifit2</code> 中提取各种量以用于进一步分析。使用值为 1, 3 和 4 的 <code>failcode</code> 将能够对其他三种事件类型的发生率进行建模。</p>
</div>
</div>
<div id="sec17-13" class="section level2" number="17.13">
<h2>
<span class="header-section-number">17.13</span> 多次事件和事件历史建模<a class="anchor" aria-label="anchor" href="#sec17-13"><i class="fas fa-link"></i></a>
</h2>
<p>复发事件模型，具体来说，Anderson and Gill (AG) 以及 Prentice, Williams and Peterson (PWP) 模型，可以在以计数过程格式表达相关数据后进行拟合，如第 13 章<a href="chap13.html#exm:ex13-2">示例 13.2</a> 所示。这可以使用 <a href="chap17.html#sec17-9">17.9</a> 节中描述的 <code>tmerge</code> 和 <code>surveSplit</code> 函数直接完成。此外，<code>tmerge</code> 中的 <code>cumtdc=</code> 选项可用于枚举每个个体的复发事件数。当使用 <code>coxph</code> 函数拟合 PWP 模型时，需要通过复发次数进行分层。</p>
<p>事件历史模型是通过定义与不同转移相关的变量来拟合的，并使用该变量以 <code>tmerge</code> 的计数过程格式形成数据。将数据集转换为所需格式所需的数据操作可能很复杂，这取决于所提供数据的格式。因此，此处不再提供更多详细信息。</p>
</div>
<div id="sec17-14" class="section level2" number="17.14">
<h2>
<span class="header-section-number">17.14</span> 相依删失<a class="anchor" aria-label="anchor" href="#sec17-14"><i class="fas fa-link"></i></a>
</h2>
<p><a href="chap14.html#sec14-3">14.3</a> 节描述的具有相依删失的 Cox 回归模型可以通过以下方式进行拟合。首先，通过为删失时间拟合生存模型来估计删失概率。这是通过反转通常的事件时间指示符来完成的，使得它对删失时间取值 1，对事件时间取值 0. 如 <a href="chap14.html#sec14-3">14.3</a> 节所述，拟合参数模型更方便，因此 <code>survreg</code> 函数用于对删失的风险进行建模。该模型中的参数估计产生线性预测器和尺度参数，它们被保存到数据框中以供以后使用。</p>
<p>然后使用 <code>surveSplit</code> 函数以计数过程格式表示事件时间数据。这是通过创建一个具有唯一事件时间的变量来实现的，该变量用于函数的 <code>cuts=</code> 选项。根据扩展的数据框，在每个区间终点计算删失时间的生存函数的估计。它们的倒数是相依删失建模中所需的权重。最后，使用具有选项 <code>weights=</code>（用于指定权重变量）的 <code>coxph</code> 函数为计数过程数据拟合 Cox 回归模型。</p>
<p>为了说明所需代码，将使用<a href="chap14.html#exm:ex14-1">示例 14.1</a> 中关于等待肝移植时死亡时间的数据来拟合考虑相依删失的 Cox 回归模型。首先输入数据，以给出与表 14.1 匹配的数据帧 <code>livertx</code>。</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="chap17.html#cb140-1" tabindex="-1"></a><span class="sc">&gt;</span> livertx<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Time to death while waiting for a liver transplant.dat"</span>,<span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<details><summary><font color="#8B2232">表 14.1</font>
</summary><img src="figure/table%2014.1.png#center" style="width:80.0%"></details><p><br>
然后，使用删失状态变量 <code>cstatus</code>，通过为删失时间拟合 Weibull 分布来对删失概率进行建模。使用以下代码将线性预测器和尺度参数的估计分配给 <code>lp</code> 和 <code>sigma</code> 并保存在 <code>livertx</code> 数据框中。</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="chap17.html#cb141-1" tabindex="-1"></a><span class="sc">&gt;</span> livertx<span class="sc">$</span>cstatus<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">-</span>livertx<span class="sc">$</span>status</span>
<span id="cb141-2"><a href="chap17.html#cb141-2" tabindex="-1"></a><span class="sc">&gt;</span> wcens<span class="ot">&lt;-</span><span class="fu">survreg</span>(<span class="fu">Surv</span>(time,cstatus) <span class="sc">~</span> age<span class="sc">+</span>gender<span class="sc">+</span>bmi<span class="sc">+</span>ukeld,</span>
<span id="cb141-3"><a href="chap17.html#cb141-3" tabindex="-1"></a>                 <span class="at">data=</span>livertx)</span>
<span id="cb141-4"><a href="chap17.html#cb141-4" tabindex="-1"></a><span class="sc">&gt;</span> livertx<span class="sc">$</span>lp<span class="ot">&lt;-</span>wcens<span class="sc">$</span>linear.predictors</span>
<span id="cb141-5"><a href="chap17.html#cb141-5" tabindex="-1"></a><span class="sc">&gt;</span> livertx<span class="sc">$</span>sigma<span class="ot">&lt;-</span>wcens<span class="sc">$</span>scale</span></code></pre></div>
<p>下一步是构造一个变量 <code>survtime</code>，其中包含数据集中事件时间的唯一值，并在 <code>survSplit</code> 函数中使用该变量以计数过程格式给出新的数据框 <code>livertx1</code>。</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="chap17.html#cb142-1" tabindex="-1"></a><span class="sc">&gt;</span> survtime<span class="ot">&lt;-</span><span class="fu">subset</span>(livertx,status<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb142-2"><a href="chap17.html#cb142-2" tabindex="-1"></a><span class="sc">&gt;</span> survtime<span class="ot">&lt;-</span><span class="fu">unique</span>(survtime[,<span class="st">"time"</span>])</span>
<span id="cb142-3"><a href="chap17.html#cb142-3" tabindex="-1"></a><span class="sc">&gt;</span> livertx1<span class="ot">&lt;-</span><span class="fu">survSplit</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> .,<span class="at">cut=</span>survtime,<span class="at">data=</span>livertx)</span></code></pre></div>
<p>变量 <code>time</code> 现在是每个时间区间的终点。现在可以根据式 <a href="chap17.html#eq:17-1">(17.1)</a> 中参数模型的对数线性形式找到在这些端点处的生存函数估计。根据第 14 章的式 <a href="chap14.html#eq:14-5">(14.5)</a>，超过时间 <span class="math inline">\(t\)</span> 的删失概率估计为</p>
<p><span class="math display">\[\hat{S}_{ci}(t)=\exp\left\{-\exp\left[\frac{\log t-\hat{\eta}_{ci}}{\hat{\sigma}_{c}}\right]\right\}\]</span></p>
<p>其中，模型中的线性预测器是 <span class="math inline">\(\hat{\eta}_{ci}=\hat{\mu}_{c}+\hat{\boldsymbol{\alpha}}_{c}'\boldsymbol{x}_{i}\)</span>，并且 <span class="math inline">\(\hat{\boldsymbol{\mu}}_{c}\)</span> 是截距，<span class="math inline">\(\hat{\mathbf{O}}_{c}\)</span> 是解释变量的系数向量，而 <span class="math inline">\(\hat{\sigma}_{c}\)</span> 是 Weibull 模型对数线性形式的尺度参数。用于在计数过程数据中的每个区间的终点处获得的生存函数估计并计算权重的代码如下。</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="chap17.html#cb143-1" tabindex="-1"></a><span class="sc">&gt;</span> livertx1<span class="sc">$</span>csurv<span class="ot">&lt;-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>((<span class="fu">log</span>(livertx1<span class="sc">$</span>time)<span class="sc">-</span></span>
<span id="cb143-2"><a href="chap17.html#cb143-2" tabindex="-1"></a>                              livertx1<span class="sc">$</span>lp)<span class="sc">/</span>livertx1<span class="sc">$</span>sigma))</span>
<span id="cb143-3"><a href="chap17.html#cb143-3" tabindex="-1"></a><span class="sc">&gt;</span> livertx1<span class="sc">$</span>weight<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>livertx1<span class="sc">$</span>csurv</span></code></pre></div>
<p>不再需要变量 <code>cstatus</code>, <code>lp</code>, <code>sigma</code> 和 <code>csurv</code>，可以使用如下代码从 <code>livertx1</code> 中删除。</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="chap17.html#cb144-1" tabindex="-1"></a><span class="sc">&gt;</span> livertx1<span class="ot">&lt;-</span><span class="fu">subset</span>(livertx1,<span class="at">select=</span><span class="sc">-</span><span class="fu">c</span>(cstatus,lp,sigma,csurv))</span></code></pre></div>
<p><code>livertx1</code> 的前 8 行如下所示。</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="chap17.html#cb145-1" tabindex="-1"></a>  patient age gender   bmi ukeld tstart time status   weight</span>
<span id="cb145-2"><a href="chap17.html#cb145-2" tabindex="-1"></a><span class="dv">1</span>       <span class="dv">1</span>  <span class="dv">60</span>      <span class="dv">0</span> <span class="fl">24.24</span>    <span class="dv">60</span>      <span class="dv">0</span>    <span class="dv">1</span>      <span class="dv">0</span> <span class="fl">1.004505</span></span>
<span id="cb145-3"><a href="chap17.html#cb145-3" tabindex="-1"></a><span class="dv">2</span>       <span class="dv">2</span>  <span class="dv">66</span>      <span class="dv">0</span> <span class="fl">30.53</span>    <span class="dv">67</span>      <span class="dv">0</span>    <span class="dv">2</span>      <span class="dv">1</span> <span class="fl">1.011361</span></span>
<span id="cb145-4"><a href="chap17.html#cb145-4" tabindex="-1"></a><span class="dv">3</span>       <span class="dv">3</span>  <span class="dv">71</span>      <span class="dv">0</span> <span class="fl">26.56</span>    <span class="dv">61</span>      <span class="dv">0</span>    <span class="dv">2</span>      <span class="dv">0</span> <span class="fl">1.008534</span></span>
<span id="cb145-5"><a href="chap17.html#cb145-5" tabindex="-1"></a><span class="dv">4</span>       <span class="dv">3</span>  <span class="dv">71</span>      <span class="dv">0</span> <span class="fl">26.56</span>    <span class="dv">61</span>      <span class="dv">2</span>    <span class="dv">3</span>      <span class="dv">0</span> <span class="fl">1.012929</span></span>
<span id="cb145-6"><a href="chap17.html#cb145-6" tabindex="-1"></a><span class="dv">5</span>       <span class="dv">4</span>  <span class="dv">65</span>      <span class="dv">1</span> <span class="fl">23.15</span>    <span class="dv">63</span>      <span class="dv">0</span>    <span class="dv">2</span>      <span class="dv">0</span> <span class="fl">1.012837</span></span>
<span id="cb145-7"><a href="chap17.html#cb145-7" tabindex="-1"></a><span class="dv">6</span>       <span class="dv">4</span>  <span class="dv">65</span>      <span class="dv">1</span> <span class="fl">23.15</span>    <span class="dv">63</span>      <span class="dv">2</span>    <span class="dv">3</span>      <span class="dv">0</span> <span class="fl">1.019468</span></span>
<span id="cb145-8"><a href="chap17.html#cb145-8" tabindex="-1"></a><span class="dv">7</span>       <span class="dv">5</span>  <span class="dv">62</span>      <span class="dv">0</span> <span class="fl">22.55</span>    <span class="dv">64</span>      <span class="dv">0</span>    <span class="dv">2</span>      <span class="dv">0</span> <span class="fl">1.011611</span></span>
<span id="cb145-9"><a href="chap17.html#cb145-9" tabindex="-1"></a><span class="dv">8</span>       <span class="dv">5</span>  <span class="dv">62</span>      <span class="dv">0</span> <span class="fl">22.55</span>    <span class="dv">64</span>      <span class="dv">2</span>    <span class="dv">3</span>      <span class="dv">0</span> <span class="fl">1.017603</span></span></code></pre></div>
<p>现在可使用如下代码拟合加权 Cox 回归模型。</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="chap17.html#cb146-1" tabindex="-1"></a><span class="sc">&gt;</span> wcoxfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,time,status) <span class="sc">~</span> age<span class="sc">+</span>gender<span class="sc">+</span>bmi<span class="sc">+</span>ukeld,</span>
<span id="cb146-2"><a href="chap17.html#cb146-2" tabindex="-1"></a>                 <span class="at">weight=</span>weight,<span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>livertx1)</span></code></pre></div>
<p>下面是 <code>summary(wcoxfit)</code> 的部分输出。</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="chap17.html#cb147-1" tabindex="-1"></a>Call<span class="sc">:</span></span>
<span id="cb147-2"><a href="chap17.html#cb147-2" tabindex="-1"></a><span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(tstart, time, status) <span class="sc">~</span> age <span class="sc">+</span> gender <span class="sc">+</span> bmi <span class="sc">+</span> </span>
<span id="cb147-3"><a href="chap17.html#cb147-3" tabindex="-1"></a>    ukeld, <span class="at">data =</span> livertx1, <span class="at">weights =</span> weight, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb147-4"><a href="chap17.html#cb147-4" tabindex="-1"></a></span>
<span id="cb147-5"><a href="chap17.html#cb147-5" tabindex="-1"></a>  n<span class="ot">=</span> <span class="dv">8968</span>, number of events<span class="ot">=</span> <span class="dv">64</span> </span>
<span id="cb147-6"><a href="chap17.html#cb147-6" tabindex="-1"></a></span>
<span id="cb147-7"><a href="chap17.html#cb147-7" tabindex="-1"></a>            coef <span class="fu">exp</span>(coef)  <span class="fu">se</span>(coef) robust se      z <span class="fu">Pr</span>(<span class="sc">&gt;</span><span class="er">|</span>z<span class="sc">|</span>)    </span>
<span id="cb147-8"><a href="chap17.html#cb147-8" tabindex="-1"></a>age     <span class="fl">0.011805</span>  <span class="fl">1.011875</span>  <span class="fl">0.007758</span>  <span class="fl">0.031582</span>  <span class="fl">0.374</span>  <span class="fl">0.70858</span>    </span>
<span id="cb147-9"><a href="chap17.html#cb147-9" tabindex="-1"></a>gender <span class="sc">-</span><span class="fl">0.990764</span>  <span class="fl">0.371293</span>  <span class="fl">0.367368</span>  <span class="fl">0.655330</span> <span class="sc">-</span><span class="fl">1.512</span>  <span class="fl">0.13057</span>    </span>
<span id="cb147-10"><a href="chap17.html#cb147-10" tabindex="-1"></a>bmi    <span class="sc">-</span><span class="fl">0.021822</span>  <span class="fl">0.978414</span>  <span class="fl">0.014422</span>  <span class="fl">0.049145</span> <span class="sc">-</span><span class="fl">0.444</span>  <span class="fl">0.65702</span>    </span>
<span id="cb147-11"><a href="chap17.html#cb147-11" tabindex="-1"></a>ukeld   <span class="fl">0.155906</span>  <span class="fl">1.168716</span>  <span class="fl">0.018695</span>  <span class="fl">0.042688</span>  <span class="fl">3.652</span>  <span class="fl">0.00026</span> <span class="sc">**</span><span class="er">*</span></span></code></pre></div>
<p>该输出中四个解释变量的系数估计及其稳健的标准误与表 14.4 中的加权估计一致。该模型的未加权版本可以使用如下代码实现。</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="chap17.html#cb148-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,time,status) <span class="sc">~</span> age<span class="sc">+</span>gender<span class="sc">+</span>bmi<span class="sc">+</span>ukeld,<span class="at">ties=</span><span class="st">"breslow"</span>,</span>
<span id="cb148-2"><a href="chap17.html#cb148-2" tabindex="-1"></a>        <span class="at">data=</span>livertx1)</span></code></pre></div>
<details><summary><font color="#8B2232">表 14.4</font>
</summary><img src="figure/table%2014.4.png#center" style="width:80.0%"></details><p><br>
如果需要，可以通过为每个单独的观测定义聚类标识符并将 <code>cluster(id)</code> 添加到模型公式中来获得该模型中系数标准误的稳健估计，如下所示。</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="chap17.html#cb149-1" tabindex="-1"></a><span class="sc">&gt;</span> livertx1<span class="sc">$</span>id<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(livertx1)</span>
<span id="cb149-2"><a href="chap17.html#cb149-2" tabindex="-1"></a><span class="sc">&gt;</span> coxfit<span class="ot">&lt;-</span><span class="fu">coxph</span>(<span class="fu">Surv</span>(tstart,time,status) <span class="sc">~</span> age<span class="sc">+</span>gender<span class="sc">+</span>bmi<span class="sc">+</span>ukeld<span class="sc">+</span></span>
<span id="cb149-3"><a href="chap17.html#cb149-3" tabindex="-1"></a>                  <span class="fu">cluster</span>(id),<span class="at">ties=</span><span class="st">"breslow"</span>,<span class="at">data=</span>livertx1)</span></code></pre></div>
<p>该代码的输出给出了表 14.4 中的未加权估计。</p>
</div>
<div id="sec17-15" class="section level2" number="17.15">
<h2>
<span class="header-section-number">17.15</span> 贝叶斯生存分析<a class="anchor" aria-label="anchor" href="#sec17-15"><i class="fas fa-link"></i></a>
</h2>
<p><code>rstanarm</code> 包支持使用 Markov
Chain Monte Carlo (MCMC) 方法和 R 建模语法来拟合各种回归模型。该包又是 <code>rstan</code> 包的补充，它提供了 <code>Stan</code> 的 R 接口，<code>Stan</code> 是一个用于贝叶斯建模和推理的 <code>C++</code> 库。第 16 章描述的贝叶斯生存分析可以使用 <code>rstanarm</code> 中的函数 <code>stan_surv</code> 来实现，该函数在 Brilleman et al. (2020) 的文章中进行了描述。第 16 章<a href="chap16.html#exm:ex16-7">示例 16.7</a> 中描述的健康评估和与初级保健联系的 HELP 研究数据将用于展示如何在贝叶斯生存分析中使用函数 <code>stan_surv</code>，并说明结果输出。使用如下命令将数据输入到名为 <code>help</code> 的数据框。</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="chap17.html#cb150-1" tabindex="-1"></a><span class="sc">&gt;</span> help<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"Health evaluation and linkage to primary care.dat"</span>,</span>
<span id="cb150-2"><a href="chap17.html#cb150-2" tabindex="-1"></a>                   <span class="at">header=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>安装 <code>rstanarm</code> 包后，可以使用 <code><a href="https://mc-stan.org/rstanarm/">library("rstanarm")</a></code> 加载它。</p>
<div class="rmdnote">
<details open><summary><font color="#8B2232">安装说明</font>
</summary><p><br><code>rstanarm</code> 最新发布的 CRAN 版本（version 2.32.1，发布日期：2024-01-18）尚无 <code>feature/survival</code>，即无法进行生存分析。要完成下列分析，需使用如下命令安装 <code>rstanarm</code> survival branch 的二进制版本（静态版本）：</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"rstanarm"</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"https://mc-stan.org/r-packages/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/options.html">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>具体详见 <a href="https://github.com/stan-dev/rstanarm/?tab=readme-ov-file#survival-analysis-version">rstanarm 的 Github页面</a> 以及<a href="https://discourse.mc-stan.org/t/stan-surv-in-rstanarm/26812">这里</a>和<a href="https://github.com/stan-dev/rstanarm/issues/566">这里</a>的讨论。</p>
</details>
</div>
<div id="sec17-15-1" class="section level3" number="17.15.1">
<h3>
<span class="header-section-number">17.15.1</span> 贝叶斯参数建模<a class="anchor" aria-label="anchor" href="#sec17-15-1"><i class="fas fa-link"></i></a>
</h3>
<p><code>stan_surv</code> 函数可用于拟合基线风险函数的贝叶斯版本的指数, Weibull 和 Gompertz 模型（如第 <a href="chap5.html#chap5">5</a> 章所述）以及对数基线风险的 B 样条模型（如第 6 章的 <a href="chap6.html#sec6-3">6.3</a> 节所述）。需要指定模型中未知参数的分布以及有关 MCMC 仿真过程的信息。贝叶斯 Weibull 比例风险模型包含数据集中的四个变量（<span class="math inline">\(Age, Gender, Housing\)</span> 和 <span class="math inline">\(Help\)</span>），可以使用以下代码为 HELP 研究的数据进行拟合。</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="chap17.html#cb152-1" tabindex="-1"></a><span class="sc">&gt;</span> hweib<span class="ot">&lt;-</span><span class="fu">stan_surv</span>(<span class="fu">Surv</span>(days,status) <span class="sc">~</span> linkage<span class="sc">+</span>age<span class="sc">+</span>gender<span class="sc">+</span>housing,</span>
<span id="cb152-2"><a href="chap17.html#cb152-2" tabindex="-1"></a>                   <span class="at">basehaz=</span><span class="st">"weibull"</span>,<span class="at">chains=</span><span class="dv">1</span>,<span class="at">iter=</span><span class="dv">11000</span>,<span class="at">warmup=</span><span class="dv">1000</span>,<span class="at">seed=</span><span class="dv">123</span>,</span>
<span id="cb152-3"><a href="chap17.html#cb152-3" tabindex="-1"></a>                   <span class="at">prior_intercept=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">prior_aux=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),</span>
<span id="cb152-4"><a href="chap17.html#cb152-4" tabindex="-1"></a>                   <span class="at">prior=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">data=</span>help)</span></code></pre></div>
<p>该模型是使用 <code>Surv</code> 对象以通常的方式指定的，而 Weibull 基线危险是使用 <code>basehaz="weibull"</code> 指定的。使用 <code>stan_surv</code>，Weibull 比例风险模型参数化为 <span class="math inline">\(h_i(t)~=~\exp(\boldsymbol{\beta'x}_i)\lambda\gamma t^{\gamma-1}\)</span>，其中 <span class="math inline">\(\log \lambda\)</span> 称为截距并在输出中表示为 <code>(Intercept)</code>，<span class="math inline">\(\gamma\)</span> 为形状参数，在输出中标记为 <code>weibull-shape</code>。使用 <code>algorithm=c("sampling")</code> 启动 <code>MCMC</code> 采样过程，但由于这是 <code>stan_surv</code> 函数的默认设置，因此已省略此选项。关于要使用的链的数量、所需的模拟总数以及用于热身的模拟数的详细信息分别使用选项 <code>chain=</code>, <code>iter=</code> 和 <code>warmup=</code> 给出。<code>seed=</code> 选项可用于初始化模拟过程的伪随机数生成器，并使随机数序列能够再现。</p>
<p>接下来，指定先验分布。可使用广泛的先验分布，包括正态分布、柯西分布、指数分布和 Laplace 分布。Brilleman et al. (2020) 的 vignette 对这些进行了描述。在上述代码中，为 Weibull 模型的截距 <span class="math inline">\(\log \lambda\)</span> 指定了具有均值为零和方差为 10<sup>2</sup> 的正态分布。<code>prior_aux=</code> 选项用于指定形状参数的先验分布，该分布为非负分布。在这种情况下，<code>prior_aux=normal(0,10)</code> 指定 Weibull 形状参数 <span class="math inline">\(\gamma\)</span> 为 half-normal 分布。<code>prior=</code> 选项用于指定模型线性部分中 <span class="math inline">\(\beta\)</span> 系数的先验分布，这里它们都分配了 <span class="math inline">\(N(0,1)\)</span> 分布。在第 16 章的<a href="chap16.html#exm:ex16-7">示例 16.7</a> 中使用了先验分布的这种选择。如果 <span class="math inline">\(\beta\)</span> 系数具有不相同的先验分布，则可以使用不同的位置和尺度参数或不同的分布。</p>
<p><code>stan_surv</code> 的函数调用得到以下输出。<code>summary</code> 和 <code>print</code> 函数提供不同的输出信息。<code>summary(hweib)</code> 的输出如下。</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="chap17.html#cb153-1" tabindex="-1"></a>Model Info<span class="sc">:</span></span>
<span id="cb153-2"><a href="chap17.html#cb153-2" tabindex="-1"></a></span>
<span id="cb153-3"><a href="chap17.html#cb153-3" tabindex="-1"></a> <span class="cf">function</span><span class="sc">:</span>        stan_surv</span>
<span id="cb153-4"><a href="chap17.html#cb153-4" tabindex="-1"></a> baseline hazard<span class="sc">:</span> weibull</span>
<span id="cb153-5"><a href="chap17.html#cb153-5" tabindex="-1"></a> formula<span class="sc">:</span>         <span class="fu">Surv</span>(days, status) <span class="sc">~</span> linkage <span class="sc">+</span> age <span class="sc">+</span> gender <span class="sc">+</span> housing</span>
<span id="cb153-6"><a href="chap17.html#cb153-6" tabindex="-1"></a> algorithm<span class="sc">:</span>       sampling</span>
<span id="cb153-7"><a href="chap17.html#cb153-7" tabindex="-1"></a> sample<span class="sc">:</span>          <span class="dv">10000</span> (posterior sample size)</span>
<span id="cb153-8"><a href="chap17.html#cb153-8" tabindex="-1"></a> priors<span class="sc">:</span>          see <span class="fu">help</span>(<span class="st">'prior_summary'</span>)</span>
<span id="cb153-9"><a href="chap17.html#cb153-9" tabindex="-1"></a> observations<span class="sc">:</span>    <span class="dv">447</span></span>
<span id="cb153-10"><a href="chap17.html#cb153-10" tabindex="-1"></a> events<span class="sc">:</span>          <span class="dv">167</span> (<span class="fl">37.4</span>%)</span>
<span id="cb153-11"><a href="chap17.html#cb153-11" tabindex="-1"></a> right censored<span class="sc">:</span>  <span class="dv">280</span> (<span class="fl">62.6</span>%)</span>
<span id="cb153-12"><a href="chap17.html#cb153-12" tabindex="-1"></a> delayed entry<span class="sc">:</span>   no</span>
<span id="cb153-13"><a href="chap17.html#cb153-13" tabindex="-1"></a></span>
<span id="cb153-14"><a href="chap17.html#cb153-14" tabindex="-1"></a> Estimates<span class="sc">:</span></span>
<span id="cb153-15"><a href="chap17.html#cb153-15" tabindex="-1"></a>                 mean     sd     <span class="dv">10</span><span class="sc">%     50%</span>     <span class="dv">90</span>%</span>
<span id="cb153-16"><a href="chap17.html#cb153-16" tabindex="-1"></a>(Intercept)   <span class="sc">-</span><span class="fl">6.3613</span> <span class="fl">0.5235</span> <span class="sc">-</span><span class="fl">7.0404</span> <span class="sc">-</span><span class="fl">6.3580</span> <span class="sc">-</span><span class="fl">5.6853</span></span>
<span id="cb153-17"><a href="chap17.html#cb153-17" tabindex="-1"></a>linkage        <span class="fl">1.6422</span> <span class="fl">0.1846</span>  <span class="fl">1.4043</span>  <span class="fl">1.6400</span>  <span class="fl">1.8778</span></span>
<span id="cb153-18"><a href="chap17.html#cb153-18" tabindex="-1"></a>age            <span class="fl">0.0239</span> <span class="fl">0.0100</span>  <span class="fl">0.0111</span>  <span class="fl">0.0239</span>  <span class="fl">0.0367</span></span>
<span id="cb153-19"><a href="chap17.html#cb153-19" tabindex="-1"></a>gender         <span class="fl">0.3439</span> <span class="fl">0.1945</span>  <span class="fl">0.0985</span>  <span class="fl">0.3390</span>  <span class="fl">0.5946</span></span>
<span id="cb153-20"><a href="chap17.html#cb153-20" tabindex="-1"></a>housing       <span class="sc">-</span><span class="fl">0.1458</span> <span class="fl">0.1530</span> <span class="sc">-</span><span class="fl">0.3403</span> <span class="sc">-</span><span class="fl">0.1456</span>  <span class="fl">0.0474</span></span>
<span id="cb153-21"><a href="chap17.html#cb153-21" tabindex="-1"></a>weibull<span class="sc">-</span>shape  <span class="fl">0.6084</span> <span class="fl">0.0414</span>  <span class="fl">0.5549</span>  <span class="fl">0.6074</span>  <span class="fl">0.6621</span></span>
<span id="cb153-22"><a href="chap17.html#cb153-22" tabindex="-1"></a></span>
<span id="cb153-23"><a href="chap17.html#cb153-23" tabindex="-1"></a>MCMC diagnostics</span>
<span id="cb153-24"><a href="chap17.html#cb153-24" tabindex="-1"></a>                mcse   Rhat n_eff</span>
<span id="cb153-25"><a href="chap17.html#cb153-25" tabindex="-1"></a>(Intercept)   <span class="fl">0.0063</span> <span class="fl">0.9999</span>  <span class="dv">6971</span></span>
<span id="cb153-26"><a href="chap17.html#cb153-26" tabindex="-1"></a>linkage       <span class="fl">0.0021</span> <span class="fl">0.9999</span>  <span class="dv">7710</span></span>
<span id="cb153-27"><a href="chap17.html#cb153-27" tabindex="-1"></a>age           <span class="fl">0.0001</span> <span class="fl">1.0000</span>  <span class="dv">9042</span></span>
<span id="cb153-28"><a href="chap17.html#cb153-28" tabindex="-1"></a>gender        <span class="fl">0.0022</span> <span class="fl">1.0000</span>  <span class="dv">8033</span></span>
<span id="cb153-29"><a href="chap17.html#cb153-29" tabindex="-1"></a>housing       <span class="fl">0.0017</span> <span class="fl">0.9999</span>  <span class="dv">8243</span></span>
<span id="cb153-30"><a href="chap17.html#cb153-30" tabindex="-1"></a>weibull<span class="sc">-</span>shape <span class="fl">0.0005</span> <span class="fl">1.0004</span>  <span class="dv">6472</span></span>
<span id="cb153-31"><a href="chap17.html#cb153-31" tabindex="-1"></a>log<span class="sc">-</span>posterior <span class="fl">0.0244</span> <span class="fl">1.0000</span>  <span class="dv">4865</span></span>
<span id="cb153-32"><a href="chap17.html#cb153-32" tabindex="-1"></a></span>
<span id="cb153-33"><a href="chap17.html#cb153-33" tabindex="-1"></a>For each parameter, mcse is Monte Carlo standard error, n_eff is a</span>
<span id="cb153-34"><a href="chap17.html#cb153-34" tabindex="-1"></a>crude measure of effective sample size, and Rhat is the potential</span>
<span id="cb153-35"><a href="chap17.html#cb153-35" tabindex="-1"></a>scale reduction factor on split <span class="fu">chains</span> (at convergence <span class="at">Rhat=</span><span class="dv">1</span>).</span></code></pre></div>
<p>该输出给出了 10000 次 MCMC 模拟中解释变量系数的均值和标准差，Weibull 截距和形状参数，以及它们分布的 10%, 50% 和 90% 百分位数。输出中对标记为 <code>MCMC diagnostics</code> 的输出内容进行了有益的描述。</p>
<p>使用 <code>print(hweib)</code> 的简略输出如下。</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="chap17.html#cb154-1" tabindex="-1"></a>               Median MAD_SD <span class="fu">exp</span>(Median)</span>
<span id="cb154-2"><a href="chap17.html#cb154-2" tabindex="-1"></a>(Intercept)   <span class="sc">-</span><span class="fl">6.3580</span> <span class="fl">0.5191</span>          <span class="cn">NA</span></span>
<span id="cb154-3"><a href="chap17.html#cb154-3" tabindex="-1"></a>linkage        <span class="fl">1.6400</span> <span class="fl">0.1835</span>      <span class="fl">5.1552</span></span>
<span id="cb154-4"><a href="chap17.html#cb154-4" tabindex="-1"></a>age            <span class="fl">0.0239</span> <span class="fl">0.0100</span>      <span class="fl">1.0242</span></span>
<span id="cb154-5"><a href="chap17.html#cb154-5" tabindex="-1"></a>gender         <span class="fl">0.3390</span> <span class="fl">0.1911</span>      <span class="fl">1.4036</span></span>
<span id="cb154-6"><a href="chap17.html#cb154-6" tabindex="-1"></a>housing       <span class="sc">-</span><span class="fl">0.1456</span> <span class="fl">0.1529</span>      <span class="fl">0.8645</span></span>
<span id="cb154-7"><a href="chap17.html#cb154-7" tabindex="-1"></a>weibull<span class="sc">-</span>shape  <span class="fl">0.6074</span> <span class="fl">0.0408</span>          <span class="cn">NA</span></span></code></pre></div>
<p>该输出给出了 MCMC 估计的中位数，以及中位绝对偏差 (median absolute deviation)，标记为 <code>MAD_SD</code>。这是对变异性估计的稳健度量，计算为每个模拟值与总体中位数之差绝对值的中位数。 <code>exp(Median)</code> 列表示中位数的指数，可用作模型中每个变量的风险比估计。</p>
<p>函数 <code>prior_summary</code> 提供了一种有用的方法来获得 <code>stan_surv</code> 函数中使用的先验总结，得到以下输出。</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="chap17.html#cb155-1" tabindex="-1"></a> Priors <span class="cf">for</span> model <span class="st">'hweib'</span></span>
<span id="cb155-2"><a href="chap17.html#cb155-2" tabindex="-1"></a> <span class="sc">------</span></span>
<span id="cb155-3"><a href="chap17.html#cb155-3" tabindex="-1"></a> Intercept</span>
<span id="cb155-4"><a href="chap17.html#cb155-4" tabindex="-1"></a> <span class="sc">~</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="dv">10</span>)</span>
<span id="cb155-5"><a href="chap17.html#cb155-5" tabindex="-1"></a> Coefficients</span>
<span id="cb155-6"><a href="chap17.html#cb155-6" tabindex="-1"></a> <span class="sc">~</span> <span class="fu">normal</span>(<span class="at">location =</span> [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,...], <span class="at">scale =</span> [<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,...])</span>
<span id="cb155-7"><a href="chap17.html#cb155-7" tabindex="-1"></a> <span class="fu">Auxiliary</span> (weibull<span class="sc">-</span>shape)</span>
<span id="cb155-8"><a href="chap17.html#cb155-8" tabindex="-1"></a> <span class="sc">~</span> half<span class="sc">-</span><span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>这证实了 Weibull 模型的截距和形状参数以及变量系数的所选先验。</p>
</div>
<div id="sec17-15-2" class="section level3" number="17.15.2">
<h3>
<span class="header-section-number">17.15.2</span> 贝叶斯半参数建模<a class="anchor" aria-label="anchor" href="#sec17-15-2"><i class="fas fa-link"></i></a>
</h3>
<p><code>stan_surv</code> 函数也可用于拟合基于 B 样条的对数风险函数的模型（在第 6 章的 <a href="chap6.html#sec6-3">6.3</a> 节中描述）的贝叶斯版本。在使用零次 B 样条的特殊情况下，该模型等价于分段指数模型，其中在第 <span class="math inline">\(j(j=1,2,\ldots,m+1)\)</span> 个时间区间中，基线风险函数为 <span class="math inline">\(h_0(t)=\exp(\alpha_j)\)</span>，其中 <span class="math inline">\(m\)</span> 是内部结数，即最短和最长事件时间之间的结的数量。然而，R 函数 <code>stan_surv</code> 包含截距项，因此实际拟合的基线风险为 <span class="math inline">\(h_0(t)=\exp(\mu+\alpha_j)\)</span>。由于该模型中现在有 <span class="math inline">\(m+2\)</span> 个未知参数，与 <span class="math inline">\(m+1\)</span> 个时间区间相关，所以该模型被过度参数化，<span class="math inline">\(\alpha_1\)</span> 被设置为零。在第一个时间区间中，基线风险为 <span class="math inline">\(e^\mu\)</span>，在其余 <span class="math inline">\(m\)</span> 个时间区间中，则为 <span class="math inline">\(\exp(\mu+\alpha_{j-1}),j=2,3,\ldots,m+1\)</span>。那么，对于具有 <span class="math inline">\(m\)</span> 个结的模型，将只有 <span class="math inline">\(m\)</span> 个B 样条系数。</p>
<p>所需的代码与为 HELP 研究数据拟合参数模型的代码非常相似，只是 <code>basehaz=</code> 选项设置为 <code>bs</code>，代表 B 样条曲线。为了拟合分段指数模型的贝叶斯版本，使用选项 <code>basehaz_ops=list(degree=0,df=5)</code> 来表示 B 样条函数的阶数和基线危险变化处的结的位置。这里，选项 <code>df=5</code> 意味着在最短 (0) 和最长 (456) 事件时间之间有五个内部结，并且时间区间的终点选择为在事件时间的等距百分位数处。这导致在第 18, 32, 42, 74 和 136 天出现内部结。选项 <code>df=5</code> 可以替换为用于内部结的事件时间列表，因此 <code>basehaz_ops=list(degree=0,knots=c(18,32,42,74,136))</code> 将提供类似的输出。为每个事件时间区间设置不同基线风险的模型将非常接近 Cox 回归模型，这可以通过将结数设置为不同事件时间数，或者在 <code>knots=</code> 选项中列出唯一的事件时间来进行拟合。</p>
<p>为了说明贝叶斯半参数建模，以下代码用于为 HELP 研究的数据拟合具有 5 个内部结的贝叶斯分段指数模型。所有四个解释变量均已包含在模型中。<span class="math inline">\(N(0, 1)\)</span> 先验用于解释变量的每个系数，并且截距和每个 B 样条参数的先验分布取为 <span class="math inline">\(N(0, 10)\)</span>。MCMC 模拟过程先进行 1,000 次热身，然后进行 10,000 次模拟。</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="chap17.html#cb156-1" tabindex="-1"></a><span class="sc">&gt;</span> bayespe<span class="ot">&lt;-</span><span class="fu">stan_surv</span>(<span class="fu">Surv</span>(days,status) <span class="sc">~</span> linkage<span class="sc">+</span>age<span class="sc">+</span>gender<span class="sc">+</span>housing,</span>
<span id="cb156-2"><a href="chap17.html#cb156-2" tabindex="-1"></a>                     <span class="at">basehaz=</span><span class="st">"bs"</span>,<span class="at">basehaz_ops=</span><span class="fu">list</span>(<span class="at">degree=</span><span class="dv">0</span>,<span class="at">df=</span><span class="dv">5</span>),</span>
<span id="cb156-3"><a href="chap17.html#cb156-3" tabindex="-1"></a>                     <span class="at">chains=</span><span class="dv">1</span>,<span class="at">iter=</span><span class="dv">11000</span>,<span class="at">warmup=</span><span class="dv">1000</span>,<span class="at">seed=</span><span class="dv">1234</span>,</span>
<span id="cb156-4"><a href="chap17.html#cb156-4" tabindex="-1"></a>                     <span class="at">prior_intercept=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">prior_aux=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),</span>
<span id="cb156-5"><a href="chap17.html#cb156-5" tabindex="-1"></a>                     <span class="at">prior=</span><span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">data=</span>help)</span></code></pre></div>
<p>使用 <code>print(bayespe)</code> 得到的参数估计的中位数以及相应的风险比，如下。</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="chap17.html#cb157-1" tabindex="-1"></a>                 Median MAD_SD <span class="fu">exp</span>(Median)</span>
<span id="cb157-2"><a href="chap17.html#cb157-2" tabindex="-1"></a>(Intercept)     <span class="sc">-</span><span class="fl">7.6055</span> <span class="fl">0.5038</span>          <span class="cn">NA</span></span>
<span id="cb157-3"><a href="chap17.html#cb157-3" tabindex="-1"></a>linkage          <span class="fl">1.5339</span> <span class="fl">0.1819</span>      <span class="fl">4.6362</span></span>
<span id="cb157-4"><a href="chap17.html#cb157-4" tabindex="-1"></a>age              <span class="fl">0.0219</span> <span class="fl">0.0102</span>      <span class="fl">1.0222</span></span>
<span id="cb157-5"><a href="chap17.html#cb157-5" tabindex="-1"></a>gender           <span class="fl">0.2586</span> <span class="fl">0.1926</span>      <span class="fl">1.2951</span></span>
<span id="cb157-6"><a href="chap17.html#cb157-6" tabindex="-1"></a>housing         <span class="sc">-</span><span class="fl">0.1165</span> <span class="fl">0.1542</span>      <span class="fl">0.8901</span></span>
<span id="cb157-7"><a href="chap17.html#cb157-7" tabindex="-1"></a>b<span class="sc">-</span>splines<span class="sc">-</span>coef1  <span class="fl">0.1457</span> <span class="fl">0.2733</span>          <span class="cn">NA</span></span>
<span id="cb157-8"><a href="chap17.html#cb157-8" tabindex="-1"></a>b<span class="sc">-</span>splines<span class="sc">-</span>coef2  <span class="fl">1.6314</span> <span class="fl">0.2695</span>          <span class="cn">NA</span></span>
<span id="cb157-9"><a href="chap17.html#cb157-9" tabindex="-1"></a>b<span class="sc">-</span>splines<span class="sc">-</span>coef3 <span class="sc">-</span><span class="fl">0.1793</span> <span class="fl">0.2723</span>          <span class="cn">NA</span></span>
<span id="cb157-10"><a href="chap17.html#cb157-10" tabindex="-1"></a>b<span class="sc">-</span>splines<span class="sc">-</span>coef4 <span class="sc">-</span><span class="fl">0.8054</span> <span class="fl">0.2731</span>          <span class="cn">NA</span></span>
<span id="cb157-11"><a href="chap17.html#cb157-11" tabindex="-1"></a>b<span class="sc">-</span>splines<span class="sc">-</span>coef5 <span class="sc">-</span><span class="fl">1.9390</span> <span class="fl">0.2688</span>          <span class="cn">NA</span></span></code></pre></div>
<p>通过 MCMC 模拟得到的模型中解释变量的系数估计与拟合 Weibull 模型的贝叶斯版本时得到的系数估计非常相似。截距 <code>Intercept</code> 是 <span class="math inline">\(\mu\)</span> 的估计，标记为 <code>b-splines-coef</code> 的系数是对样条基函数的系数 <span class="math inline">\(\alpha_j,j=2,3,4,5,6\)</span> 的估计。基线风险函数在第一区间为 <span class="math inline">\(\exp(\mu)\)</span>，在其余五个区间为 <span class="math inline">\(\exp{\mu + \alpha_j}\)</span>。这些数值需要从每个单独的 10,000 次 MCMC 模拟中推导出来，而不是通过该输出的中位数得出。</p>
<p>对于具有给定特征的个体，<code>posterior_survfit</code> 可用于从 MCMC 模拟中模型参数的单个估计中获取后验预测生存函数和风险函数。具体来说，基线函数可以使用如下代码获得。</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basevals</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>linkage<span class="op">=</span><span class="fl">0</span>,age<span class="op">=</span><span class="fl">0</span>,gender<span class="op">=</span><span class="fl">0</span>,housing<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">basesurv</span><span class="op">&lt;-</span><span class="fu">posterior_survfit</span><span class="op">(</span><span class="va">bayespe</span>,type<span class="op">=</span><span class="st">"surv"</span>,newdata<span class="op">=</span><span class="va">basevals</span><span class="op">)</span></span>
<span><span class="va">basehaz</span><span class="op">&lt;-</span><span class="fu">posterior_survfit</span><span class="op">(</span><span class="va">bayespe</span>,type<span class="op">=</span><span class="st">"haz"</span>,newdata<span class="op">=</span><span class="va">basevals</span><span class="op">)</span></span></code></pre></div>
<p>使用 <code>plot</code> 对它们绘图，例如 <code>plot(basesurv)</code>。</p>
<p>使用 <code>waic</code> 函数可以轻松得到使用 <code>stan_surv</code> 函数拟合的模型用于贝叶斯模型比较的 <span class="math inline">\(WAIC\)</span> 统计量，如第 16 章 <a href="chap16.html#sec16-8">16.8</a> 节所述。例如，<code>waic(bayespe)</code> 给出</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="chap17.html#cb159-1" tabindex="-1"></a>          Estimate    SE</span>
<span id="cb159-2"><a href="chap17.html#cb159-2" tabindex="-1"></a>elpd_waic  <span class="sc">-</span><span class="fl">1118.7</span>  <span class="fl">61.3</span></span>
<span id="cb159-3"><a href="chap17.html#cb159-3" tabindex="-1"></a>p_waic         <span class="fl">9.6</span>   <span class="fl">0.5</span></span>
<span id="cb159-4"><a href="chap17.html#cb159-4" tabindex="-1"></a>waic        <span class="fl">2237.4</span> <span class="fl">122.7</span></span></code></pre></div>
<p>其中拟合分段指数模型的 <span class="math inline">\(WAIC\)</span> 统计量为 2237.4，相应的模型复杂度估计为 <span class="math inline">\(p_W = 9.6\)</span>。标记为 <code>elpd_waic</code> 的行是预期对数逐点预测密度 (expected log-pointwise predictive density)，是一种预测准确性的度量，将其乘以 -2 得到 <span class="math inline">\(WAIC\)</span> 统计量。</p>
</div>
<div id="sec17-15-3" class="section level3" number="17.15.3">
<h3>
<span class="header-section-number">17.15.3</span> 风险函数的灵活模型<a class="anchor" aria-label="anchor" href="#sec17-15-3"><i class="fas fa-link"></i></a>
</h3>
<p>第6章 <a href="chap6.html#sec6-3">6.3</a> 节中描述的对数风险函数的灵活的立方 B 样条模型的贝叶斯版本可以使用类似的代码进行拟合。唯一需要的更改是在 <code>basehaz_ops=</code> 选项中使用 <code>degree=3</code>。例如，可以使用 <span class="math inline">\(WAIC\)</span> 准则来拟合具有越来越多内部结（自由度）的模型，并确定最合适的模型。</p>
<p>第 6 章 <a href="chap6.html#sec6-4">6.4</a> 节中描述的对数累积风险的限制性立方样条模型不常用于贝叶斯生存分析，因为很难确保对数累积风险是时间的递增函数，这会导致 MCMC 模拟过程出现问题。</p>
</div>
</div>
<div id="sec17-16" class="section level2" number="17.16">
<h2>
<span class="header-section-number">17.16</span> 延伸阅读<a class="anchor" aria-label="anchor" href="#sec17-16"><i class="fas fa-link"></i></a>
</h2>
<p>本章只能介绍一小部分用于生存分析的 R 包，以及展示数据操作、向量和矩阵代数等功能的部分内容。此外，对于 R 软件在数据可视化和图形化表示方面的应用，本章所涉非常有限。然而，有很多书籍都介绍了 R 软件及其在统计分析中的应用。其中包括 Crawley (2013), Dalgaard (2008), Davies (2016), Field, Miles and Field (2012), Verzani (2014) 以及 Wickham (2019) 的著作。此外，还有一本名为 <em>R for Dummies</em>的书籍 (de Vries and Meys, 2015)，以及同一系列中介绍使用 R 进行统计分析的书籍 (Schmuller, 2017).</p>
<p>Moore (2016) 描述了生存分析的原则，并说明了使用 R 进行数据分析。Broström (2022) 介绍了生存分析和事件史分析，并提供了使用 R 包 <code>eha</code> 分析社会科学领域数据的实例。</p>
<p>所有 R 包都在 CRAN 网站上进行了描述，但其中一些包还提供了更详细的文档，称为 vignette. 这些 vignette 包括 <code>survival</code> 包的文档 (Therneau, 2022)、使用时依变量进行建模的文档 (Therneau, Crowson and Atkinson, 2022a)、<code>parfm</code> 包的文档 (Munda, Rotolo and Legrand, 2017)以及多状态模型和竞争风险模型的文档 (Therneau, Crowson and Atkinson, 2022b). 还可参考 Munda, Rotolo and Legrand (2012) 关于 <code>parfm</code> 的早期论文。Rizopoulos (2022) 描述了 <code>JM</code> 包，该包用于纵向和事件发生时间数据的联合建模。Brilleman et al. (2020) 描述了使用 <code>rstanarm</code> 包进行贝叶斯生存分析的方法。</p>

</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="chap16.html"><span class="header-section-number">16</span> 贝叶斯生存分析</a></div>
<div class="next"><a href="A.html"><span class="header-section-number">A</span> 最大似然估计</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#chap17"><span class="header-section-number">17</span> 使用 R 进行生存分析</a></li>
<li><a class="nav-link" href="#sec17-1"><span class="header-section-number">17.1</span> R 的介绍</a></li>
<li>
<a class="nav-link" href="#sec17-2"><span class="header-section-number">17.2</span> 数据输入和编辑</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-2-1"><span class="header-section-number">17.2.1</span> 从文件中读取和操作数据</a></li>
<li><a class="nav-link" href="#sec17-2-2"><span class="header-section-number">17.2.2</span> R 包</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec17-3"><span class="header-section-number">17.3</span> 非参数程序</a></li>
<li>
<a class="nav-link" href="#sec17-4"><span class="header-section-number">17.4</span> Cox 回归模型</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-4-1"><span class="header-section-number">17.4.1</span> 变量选择和 lasso</a></li>
<li><a class="nav-link" href="#sec17-4-2"><span class="header-section-number">17.4.2</span> 预测能力和解释的变异的度量</a></li>
<li><a class="nav-link" href="#sec17-4-3"><span class="header-section-number">17.4.3</span> 时依 ROC 曲线</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-5"><span class="header-section-number">17.5</span> Cox 回归模型中的模型检查</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-5-1"><span class="header-section-number">17.5.1</span> 残差分析</a></li>
<li><a class="nav-link" href="#sec17-5-2"><span class="header-section-number">17.5.2</span> 识别有影响的观测</a></li>
<li><a class="nav-link" href="#sec17-5-3"><span class="header-section-number">17.5.3</span> 检验比例风险假设</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec17-6"><span class="header-section-number">17.6</span> 参数生存模型</a></li>
<li>
<a class="nav-link" href="#sec17-7"><span class="header-section-number">17.7</span> 灵活的参数模型</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-7-1"><span class="header-section-number">17.7.1</span> 分段指数模型</a></li>
<li><a class="nav-link" href="#sec17-7-2"><span class="header-section-number">17.7.2</span> 风险函数的模型</a></li>
<li><a class="nav-link" href="#sec17-7-3"><span class="header-section-number">17.7.3</span> 对数累积风险函数的模型</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-8"><span class="header-section-number">17.8</span> 参数模型中的模型检查</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-8-1"><span class="header-section-number">17.8.1</span> 有影响的值</a></li>
<li><a class="nav-link" href="#sec17-8-2"><span class="header-section-number">17.8.2</span> 比较观测的和拟合的生存函数</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-9"><span class="header-section-number">17.9</span> 时依变量</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-9-1"><span class="header-section-number">17.9.1</span> 时变系数</a></li>
<li><a class="nav-link" href="#sec17-9-2"><span class="header-section-number">17.9.2</span> 纵向数据和生存数据的联合建模</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-10"><span class="header-section-number">17.10</span> 区间删失数据</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-10-1"><span class="header-section-number">17.10.1</span> 生存函数的非参数最大似然估计</a></li>
<li><a class="nav-link" href="#sec17-10-2"><span class="header-section-number">17.10.2</span> 区间删失数据的半参数模型</a></li>
<li><a class="nav-link" href="#sec17-10-3"><span class="header-section-number">17.10.3</span> 区间删失数据的参数模型</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-11"><span class="header-section-number">17.11</span> 脆弱模型</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-11-1"><span class="header-section-number">17.11.1</span> 拟合具有个体脆弱性的参数脆弱模型</a></li>
<li><a class="nav-link" href="#sec17-11-2"><span class="header-section-number">17.11.2</span> 拟合具有共享脆弱性的参数脆弱模型</a></li>
<li><a class="nav-link" href="#sec17-11-3"><span class="header-section-number">17.11.3</span> 拟合具有个体 lognormal 脆弱性的半参数模型</a></li>
<li><a class="nav-link" href="#sec17-11-4"><span class="header-section-number">17.11.4</span> 拟合具有个体 gamma 脆弱性的半参数模型</a></li>
<li><a class="nav-link" href="#sec17-11-5"><span class="header-section-number">17.11.5</span> 拟合具有共享脆弱性的半参数模型</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#sec17-12"><span class="header-section-number">17.12</span> 竞争风险</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-12-1"><span class="header-section-number">17.12.1</span> 原因别的风险函数的估计和建模</a></li>
<li><a class="nav-link" href="#sec17-12-2"><span class="header-section-number">17.12.2</span> 估计累计发生率函数</a></li>
<li><a class="nav-link" href="#sec17-12-3"><span class="header-section-number">17.12.3</span> 累积发生率的 Fine and Gray 模型</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec17-13"><span class="header-section-number">17.13</span> 多次事件和事件历史建模</a></li>
<li><a class="nav-link" href="#sec17-14"><span class="header-section-number">17.14</span> 相依删失</a></li>
<li>
<a class="nav-link" href="#sec17-15"><span class="header-section-number">17.15</span> 贝叶斯生存分析</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sec17-15-1"><span class="header-section-number">17.15.1</span> 贝叶斯参数建模</a></li>
<li><a class="nav-link" href="#sec17-15-2"><span class="header-section-number">17.15.2</span> 贝叶斯半参数建模</a></li>
<li><a class="nav-link" href="#sec17-15-3"><span class="header-section-number">17.15.3</span> 风险函数的灵活模型</a></li>
</ul>
</li>
<li><a class="nav-link" href="#sec17-16"><span class="header-section-number">17.16</span> 延伸阅读</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>医学研究中的生存数据建模</strong>" was written by Wang Zhen. It was last built on 2024-04-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
